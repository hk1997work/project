<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ecoSignal | Network</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* =========================================
           1. CORE STYLES (COPIED FROM PROJECT.HTML)
           ========================================= */
        :root {
            /* --- COLOR PALETTE (基础色) --- */
            --brand: #83CD20;
            --brand-tint: rgba(131, 205, 32, 0.08);
            --brand-hover: #72b51b;
            --brand-gradient: linear-gradient(135deg, #95d93d 0%, #6ab01a 100%);

            /* --- LIGHT THEME (默认亮色变量) --- */
            --bg-page: radial-gradient(circle at top left, #ffffff, #f8fafc);
            --bg-nav: rgba(255, 255, 255, 0.85);
            --bg-capsule: #f1f5f9;
            --bg-surface: #ffffff;
            --bg-surface-hover: #fcfcfc;
            --bg-surface-secondary: #f8fafc;
            --bg-input: #ffffff;
            --bg-header-tint: rgba(255, 255, 255, 0.4);

            --text-main: #1e293b;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --text-on-img: #ffffff; /* Index特有：图片上的文字颜色 */

            --border-light: #e2e8f0;
            --border-color: rgba(0, 0, 0, 0.06);

            /* --- CARD STYLES --- */
            --glass-bg: rgba(255, 255, 255, 0.9);
            --card-bg: #ffffff;
            --card-border: 1px solid rgba(0, 0, 0, 0.06);
            --card-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.08),
            0 0 0 1px rgba(255, 255, 255, 0.8) inset;

            /* --- DIMENSIONS --- */
            --nav-height: 80px;
            --capsule-height: 48px;
            --radius: 24px;

            /* --- ANIMATION --- */
            --anim-fade-duration: 0.3s;
            --anim-fade-ease: ease-out;

            /* --- FONTS --- */
            --font-sans: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        /* --- DARK THEME OVERRIDES (暗色主题覆盖) --- */
        [data-theme="dark"] {
            --bg-page: #020617; /* Index特有：使用深色背景而非渐变，配合地图 */
            --bg-nav: rgba(15, 23, 42, 0.85);
            --bg-capsule: #334155;
            --bg-surface: #1e293b;
            --bg-surface-hover: #334155;
            --bg-surface-secondary: #020617;
            --bg-input: #0f172a;
            --bg-header-tint: rgba(0, 0, 0, 0.2);

            --text-main: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;

            --border-light: #334155;
            --border-color: rgba(255, 255, 255, 0.1);

            --glass-bg: rgba(30, 41, 59, 0.85);
            --card-bg: #1e293b;
            --card-border: 1px solid rgba(255, 255, 255, 0.08);
            --card-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.4),
            0 0 0 1px rgba(255, 255, 255, 0.05) inset;
        }

        /* --- Leaflet Map Dark Mode (地图暗色滤镜) --- */
        [data-theme="dark"] .leaflet-layer,
        [data-theme="dark"] .leaflet-control-zoom-in,
        [data-theme="dark"] .leaflet-control-zoom-out,
        [data-theme="dark"] .leaflet-control-attribution {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }
        [data-theme="dark"] #map-pane { background: #0f172a; }

        body, html { margin: 0; padding: 0; height: 100%; font-family: var(--font-sans); background: var(--bg-page); color: var(--text-main); overflow: hidden; transition: background 0.3s, color 0.3s; }

        /* =========================================
           2. NAVIGATION COMPONENTS (COPIED FROM PROJECT.HTML)
           ========================================= */

        /* 导航栏容器 - INDEX 特殊处理：背景透明 */
        .project-nav-bar {
            position: absolute;
            top: 0; left: 0; width: 100%;
            height: var(--nav-height);
            z-index: 5000;
            display: flex; align-items: center;
            padding: 0 30px; box-sizing: border-box;
            background: transparent; /* Index 保持透明 */
            pointer-events: none;    /* 让鼠标穿透透明区域 */
            gap: 16px;
            /* border-bottom: 1px solid var(--border-color); */ /* Index 不需要边框 */
        }

        /* 胶囊样式 - 完全一致 */
        .nav-capsule-box {
            position: relative;
            display: flex;
            align-items: center;
            background: var(--bg-capsule); /* 使用 Project 定义的胶囊背景 */
            /* Project 的阴影样式 */
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.04), inset -1px -1px 3px rgba(255, 255, 255, 0.1);
            border-radius: 60px;
            padding: 4px;
            height: var(--capsule-height);
            box-sizing: border-box;
            pointer-events: auto; /* 恢复交互 */
        }

        /* 胶囊在 Index 页面的特殊微调：如果是玻璃态背景图上，可能需要一点透明度，
           但为了"完全一致"，我们保留 var(--bg-capsule) */

        [data-theme="dark"] .nav-capsule-box {
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.2);
        }

        .nav-left { display: flex; align-items: center; margin-right: auto; pointer-events: auto; }
        .nav-right { display: flex; justify-content: flex-end; pointer-events: auto; }
        .nav-divider { width: 1px; height: 16px; background: var(--border-color); margin: 0 6px; flex-shrink: 0; }

        /* Logo 样式 */
        .nav-logo {
            display: flex; align-items: center; gap: 10px; text-decoration: none;
            color: var(--text-main); padding: 0 12px; height: 100%; border-radius: 40px;
            margin-right: 0; transition: all 0.2s ease;
        }
        .nav-logo:hover { background: var(--brand); color: white; box-shadow: 0 4px 12px rgba(131, 205, 32, 0.3); }
        .nav-logo span { font-weight: 800; font-size: 1.1rem; letter-spacing: -0.5px; }

        .logo-icon-box {
            width: 28px; height: 28px; background: var(--brand); color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(131, 205, 32, 0.4); transition: all 0.2s ease;
        }
        .nav-logo:hover .logo-icon-box { background: white; color: var(--brand); }

        /* 按钮样式 */
        .nav-btn-simple {
            background: transparent; border: none; padding: 0;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-secondary);
            width: 40px; height: 100%;
            border-radius: 40px; transition: all 0.2s ease; cursor: pointer;
        }
        .nav-btn-simple:hover { background: var(--brand); color: white; box-shadow: 0 4px 12px rgba(131, 205, 32, 0.3); }

        /* 用户菜单样式 */
        .user-wrapper { position: relative; height: 100%; }

        .user-capsule-btn {
            padding: 0 16px 0 10px; border-radius: 40px; gap: 10px;
            height: 100%;
            display: flex; align-items: center; cursor: pointer;
            color: var(--text-secondary); transition: all 0.2s ease;
        }
        .user-capsule-btn:hover { background: var(--brand); color: white; box-shadow: 0 4px 12px rgba(131, 205, 32, 0.3); }

        .user-avatar-icon { width: 30px; height: 30px; background: transparent; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); transition: all 0.2s; }
        .user-capsule-btn:hover .user-avatar-icon { background: white; color: var(--brand); box-shadow: none; }
        .user-name-text { font-size: 0.9rem; font-weight: 600; letter-spacing: -0.2px; color: var(--text-main); }
        .user-capsule-btn:hover .user-name-text { color: white; }

        /* 下拉菜单 */
        .dropdown-menu {
            position: absolute; top: calc(100% + 14px); right: 0; width: 220px;
            background: var(--bg-surface); border-radius: 20px;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.1);
            padding: 6px; display: flex; flex-direction: column; gap: 2px;
            opacity: 0; visibility: hidden; transform: translateY(-10px);
            transition: 0.2s; z-index: 5005; border: var(--card-border);
        }
        .user-wrapper.active .dropdown-menu { opacity: 1; visibility: visible; transform: translateY(0); }

        .dropdown-item { display: flex; align-items: center; gap: 12px; padding: 10px 14px; border-radius: 12px; text-decoration: none; color: var(--text-main); font-size: 0.95rem; font-weight: 600; transition: 0.2s; }
        .dropdown-item:hover { background: var(--brand-tint); color: var(--brand); }
        .dropdown-item.danger:hover { background: #fee2e2; color: #ef4444; }
        [data-theme="dark"] .dropdown-item.danger:hover { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .dropdown-divider { height: 1px; background: var(--border-color); margin: 4px 10px; opacity: 0.6; }

        /* =========================================
           3. INDEX PAGE SPECIFIC LAYOUTS
           ========================================= */

        /* Swiper & Backgrounds */
        .swiper { width: 100%; height: 100%; }
        .swiper-slide { position: relative; overflow: hidden; }
        .bg-image { position: absolute; inset: 0; background-size: cover; background-position: center; z-index: -1; transform: scale(1); transition: transform 2s ease-out; }
        #page-home.swiper-slide-active .bg-image,
        #page-project.swiper-slide-active .swiper-slide-active .bg-image,
        #page-sponsors.swiper-slide-active .bg-image { transition: transform 10s ease; transform: scale(1.05); }

        /* Page 1: Home */
        #page-home .bg-image { background-image: url('https://images.pexels.com/photos/733090/pexels-photo-733090.jpeg?auto=compress&cs=tinysrgb&w=1600'); }
        .home-content { position: relative; z-index: 10; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; background: linear-gradient(to bottom, rgba(0,0,0,0) 60%, rgba(0,0,0,0.4) 100%); }
        .brand-logo { font-size: 3rem; font-weight: 900; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; text-shadow: 0 4px 15px rgba(0,0,0,0.6); color: var(--text-on-img); }
        .brand-logo span { color: var(--brand); }
        .hero-title { font-size: clamp(40px, 6.5vw, 85px); font-weight: 900; line-height: 1.05; max-width: 1200px; margin-bottom: 25px; text-shadow: 0 4px 4px rgba(0,0,0,0.4), 0 10px 20px rgba(0,0,0,0.5); letter-spacing: -0.02em; padding: 0 20px; color: var(--text-on-img); }
        .hero-desc { font-size: 1.2rem; opacity: 1; color: #f0f0f0; max-width: 650px; margin-bottom: 50px; font-weight: 600; line-height: 1.6; text-shadow: 0 2px 8px rgba(0,0,0,0.8); }
        .btn-group { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }

        /* Pill Button (Consistent with Project) */
        .pill-btn { background: var(--brand-gradient); color: white; padding: 12px 36px; border-radius: 50px; font-weight: 700; font-size: 1rem; text-decoration: none; display: flex; align-items: center; gap: 10px; transition: all 0.3s; box-shadow: 0 8px 20px rgba(106, 176, 26, 0.3), 0 2px 5px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.2); }
        .pill-btn:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 12px 30px rgba(106, 176, 26, 0.5); filter: brightness(1.1); }

        /* Page 2: Projects */
        .thumbs-container { position: absolute; bottom: 30px !important; left: 50%; transform: translateX(-50%); max-width: 880px; width: 100%; height: 90px; z-index: 20; display: flex; align-items: center; justify-content: center; padding: 0 50px; box-sizing: border-box; }
        .thumbs-swiper { width: 100%; height: 100%; overflow: hidden; }
        .thumbs-swiper .swiper-slide { width: 60px !important; height: 60px !important; flex-shrink: 0; border-radius: 50%; background-size: cover; background-position: center; opacity: 1; border: 4px solid var(--bg-surface); transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); cursor: pointer; box-sizing: border-box; margin-top: 15px; margin-right: 20px; }
        .thumbs-swiper .swiper-slide-thumb-active { border-color: var(--brand); box-shadow: 0 0 20px rgba(131, 205, 32, 0.5); transform: none; }
        .thumbs-swiper .swiper-slide:hover { transform: translateY(-5px); border-color: rgba(255,255,255,0.9); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .thumbs-button-next, .thumbs-button-prev { color: white; width: 40px; height: 40px; margin-top: -20px; z-index: 30; cursor: pointer; position: absolute; top: 50%; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); border-radius: 50%; transition: 0.3s; border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(5px); }
        .thumbs-button-next:hover, .thumbs-button-prev:hover { background: var(--brand); color: black; border-color: var(--brand); }
        .thumbs-button-next { right: 0; }
        .thumbs-button-prev { left: 0; }

        .project-fixed-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; padding: 40px; box-sizing: border-box; display: flex; justify-content: flex-end; align-items: flex-start; }

        /* Search Bar (Centered in Nav Area) */
        .search-bar { position: absolute; top: 16px; left: 50%; transform: translateX(-50%); background: var(--glass-bg); backdrop-filter: blur(20px); padding: 12px 24px; border-radius: 50px; display: flex; align-items: center; gap: 10px; width: 340px; border: var(--card-border); pointer-events: auto; box-shadow: var(--card-shadow); transition: background 0.3s; height: 48px; box-sizing: border-box; }
        .search-bar input { background: transparent; border: none; color: var(--text-main); outline: none; width: 100%; font-size: 0.95rem; }
        .search-bar i { color: var(--text-secondary); }

        .info-card { background: var(--glass-bg); backdrop-filter: blur(25px) saturate(120%); padding: 35px; border-radius: var(--radius); width: 440px; color: var(--text-main); border: var(--card-border); pointer-events: auto; margin-top: 140px; transition: height 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); overflow: hidden; display: block; box-sizing: border-box; box-shadow: var(--card-shadow); }
        .info-content-wrapper { opacity: 1; transition: opacity 0.3s ease; }
        .info-content-wrapper.fading { opacity: 0; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; opacity: 0.8; font-size: 0.9rem; color: var(--text-secondary); }
        .top-link-icon { color: var(--text-main); transition: 0.3s; cursor: pointer; }
        .top-link-icon:hover { color: var(--brand); transform: scale(1.1); }
        .project-title { text-decoration: none; color: var(--text-main); transition: 0.3s; display: block; margin-bottom: 10px; }
        .project-title h2 { font-size: 2.8rem; margin: 0; font-weight: 800; line-height: 1.05; letter-spacing: -0.02em; }
        .project-title:hover { color: var(--brand); text-shadow: 0 0 20px rgba(131, 205, 32, 0.4); }
        .creator-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .creator-name { font-weight: 700; color: var(--text-main); font-size: 1.1rem; }
        .status-icon { display: flex; align-items: center; }
        .status-icon.locked { color: var(--text-muted); }
        .status-icon.unlocked { color: var(--text-main); text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .info-card hr { border: 0; border-top: 1px solid var(--border-color); margin: 20px 0; }
        .info-card p { line-height: 1.7; opacity: 0.9; font-size: 1rem; margin-bottom: 25px; text-align: justify; color: var(--text-secondary); max-height: 300px; overflow-y: auto; padding-right: 8px; }
        .info-card p::-webkit-scrollbar { width: 4px; }
        .info-card p::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 2px; }
        .info-card p::-webkit-scrollbar-thumb { background: var(--brand); border-radius: 2px; }
        .tags { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 20px; }
        .tag { background: var(--brand); color: #ffffff; padding: 6px 16px; border-radius: 50px; font-size: 0.85rem; font-weight: 700; text-shadow: 0 1px 2px rgba(0,0,0,0.1); box-shadow: 0 4px 10px rgba(131, 205, 32, 0.3); }

        /* Page 3: Map */
        #page-map { background: var(--bg-page); position: relative; }
        #map-pane { width: 100%; height: 100%; z-index: 1; }

        .map-brand-overlay { position: absolute; top: 16px; left: 50%; transform: translateX(-50%); z-index: 500; background: var(--glass-bg); backdrop-filter: blur(20px) saturate(120%); padding: 0 35px; border-radius: 50px; display: flex; align-items: center; gap: 12px; box-shadow: var(--card-shadow); pointer-events: none; border: var(--card-border); height: 48px; box-sizing: border-box; }
        .map-brand-text { font-size: 1.3rem; font-weight: 800; color: var(--text-main); letter-spacing: -0.5px; }
        .map-brand-text span { background: var(--brand-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .stats-container { position: absolute; left: 40px; top: 50%; transform: translateY(-50%); z-index: 500; display: flex; flex-direction: column; gap: 10px; pointer-events: none; perspective: 1000px; }
        .stat-card { pointer-events: auto; background: var(--glass-bg); backdrop-filter: blur(25px) saturate(120%); border: var(--card-border); width: 320px; padding: 8px 20px; border-radius: 20px; height: 65px; box-sizing: border-box; display: flex; align-items: center; gap: 20px; box-shadow: var(--card-shadow); opacity: 0; transform: translateX(-30px); transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .stats-container.active .stat-card { opacity: 1; transform: translateX(0); }
        /* Stagger */
        .stats-container.active .stat-card:nth-child(2) { transition-delay: 0.1s; }
        .stats-container.active .stat-card:nth-child(3) { transition-delay: 0.2s; }
        .stats-container.active .stat-card:nth-child(4) { transition-delay: 0.3s; }
        .stats-container.active .stat-card:nth-child(5) { transition-delay: 0.4s; }
        .stats-container.active .stat-card:nth-child(6) { transition-delay: 0.5s; }
        .stats-container.active .stat-card:nth-child(7) { transition-delay: 0.6s; }
        .stats-container.active .stat-card:nth-child(8) { transition-delay: 0.7s; }
        .stats-container.active .stat-card:nth-child(9) { transition-delay: 0.8s; }

        .stat-icon { color: var(--brand); flex-shrink: 0; display: flex; align-items: center; background: rgba(131, 205, 32, 0.1); padding: 8px; border-radius: 12px; }
        .stat-icon svg { width: 22px; height: 22px; }
        .stat-info .label { font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1.5px; font-weight: 700; line-height: 1.4; }
        .stat-info .value { font-size: 1.4rem; font-weight: 800; color: var(--text-main); line-height: 1.1; letter-spacing: -1px; }

        /* Markers (Restored Original Styles) */
        .premium-marker { display: flex; align-items: center; justify-content: center; }
        .radar-ring { position: absolute; width: 40px; height: 40px; border: 2px solid var(--brand); border-radius: 50%; animation: radar-beam 2.5s infinite ease-out; }
        .radar-ring:nth-child(2) { animation-delay: 0.8s; }
        .marker-core { width: 14px; height: 14px; background: var(--brand-gradient); border-radius: 50%; border: 3px solid #fff; animation: core-pulse 2.5s infinite ease-in-out; z-index: 10; }

        .marker-label { position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%); color: #1f2937; padding: 0; font-size: 0.95rem; white-space: nowrap; display: none; pointer-events: none; z-index: 20; font-weight: 800; opacity: 0; transition: transform 0.18s ease, opacity 0.18s ease; }
        /* Only change text color in Dark Mode for visibility */
        [data-theme="dark"] .marker-label { color: #f8fafc; text-shadow: 0 1px 4px rgba(0,0,0,0.8); }

        .marker-selected .marker-label { display: block; opacity: 1; transform: translateX(-50%) translateY(-10px); color: #1f2937; }
        .marker-hover .marker-label { display: block; opacity: 1; transform: translateX(-50%) translateY(-10px); }
        [data-theme="dark"] .marker-selected .marker-label { color: white; }

        .marker-selected .radar-ring { border-color: #ff8c00; }
        .marker-selected .marker-core { background: linear-gradient(135deg, #ffb866 0%, #ff8c00 100%); box-shadow: 0 0 20px rgba(255,140,0,0.6); }

        @keyframes radar-beam { 0% { transform: scale(0.4); opacity: 0.8; border-width: 3px; } 100% { transform: scale(2); opacity: 0; border-width: 1px; } }
        @keyframes core-pulse { 0%, 100% { box-shadow: 0 0 15px rgba(131, 205, 32, 0.6); transform: scale(1); } 50% { box-shadow: 0 0 30px rgba(131, 205, 32, 0.9); transform: scale(1.15); } }

        /* Page 4: Sponsors */
        #page-sponsors { background: var(--bg-page); position: relative; overflow: hidden; color: var(--text-main); display: flex; align-items: center; justify-content: center; }
        .aurora-bg { position: absolute; width: 100%; height: 100%; top: 0; left: 0; z-index: 0; overflow: hidden; pointer-events: none; }
        .aurora-blob { position: absolute; filter: blur(80px); opacity: 0.6; animation: blob-float 20s infinite ease-in-out alternate; }
        .aurora-blob:nth-child(1) { width: 500px; height: 500px; background: #e0f2fe; top: -10%; left: -10%; }
        .aurora-blob:nth-child(2) { width: 600px; height: 600px; background: rgba(131, 205, 32, 0.15); bottom: -10%; right: -10%; animation-delay: -5s; }
        [data-theme="dark"] .aurora-blob:nth-child(1) { background: #1e3a8a; opacity: 0.3; }
        [data-theme="dark"] .aurora-blob:nth-child(2) { background: rgba(131, 205, 32, 0.1); opacity: 0.2; }

        @keyframes blob-float { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(50px, 50px) scale(1.1); } }

        .sponsors-wrapper { width: 100%; max-width: 1100px; padding: 0 40px; box-sizing: border-box; text-align: center; display: flex; flex-direction: column; gap: 10px; z-index: 10; margin: 0 auto; }
        .sponsors-header .main-title { font-size: 3.5rem; font-weight: 900; margin: 0; line-height: 1.1; letter-spacing: -1px; color: var(--text-main); }
        .sponsors-header .main-title span { color: var(--brand); }
        .sponsors-desc { max-width: 600px; margin: 30px auto 40px auto; color: var(--text-secondary); font-size: 1.1rem; line-height: 1.6; }

        .logo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 40px 60px; padding: 20px; box-sizing: border-box; align-items: center; }
        .sponsor-card { height: 120px; display: flex; align-items: center; justify-content: center; position: relative; transition: all 0.3s ease; background: transparent; border: none; }
        .sponsor-card img { height: auto; width: auto; max-height: 70px; max-width: 100%; object-fit: contain; filter: grayscale(100%) opacity(0.5); transition: 0.4s ease; }
        .sponsor-card:hover img { filter: none; opacity: 1; transform: scale(1.05); }
        [data-theme="dark"] .sponsor-card img { filter: grayscale(100%) brightness(0) invert(1) opacity(0.5); }
        [data-theme="dark"] .sponsor-card:hover img { filter: none; opacity: 1; }

        .sponsors-footer-action { margin-top: 40px; display: flex; justify-content: center; }
        .join-btn { background: var(--brand-gradient); color: white; padding: 16px 45px; border-radius: 50px; font-weight: 700; text-decoration: none; display: inline-flex; align-items: center; gap: 12px; transition: all 0.3s ease; box-shadow: 0 8px 20px rgba(131, 205, 32, 0.3); border: 1px solid rgba(255,255,255,0.2); }
        .join-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(131, 205, 32, 0.5); filter: brightness(1.1); }

        /* Page 5: Footer */
        #page-footer { background: #050505; color: white; display: flex; align-items: center; justify-content: center; }
        .footer-logo { font-size: 2rem; color: white; margin-bottom: 20px; font-weight: 900; }
        .footer-logo span { color: var(--brand); }
        .footer-links { display: flex; gap: 30px; justify-content: center; margin-bottom: 40px; }
        .footer-links a { color: white; text-decoration: none; font-weight: 600; transition: 0.3s; }
        .footer-links a:hover { color: var(--brand); }

        /* Cookie & Login */
        .cookie-banner { position: fixed; bottom: 30px; left: 30px; z-index: 99999; background: var(--glass-bg); backdrop-filter: blur(20px); border: var(--card-border); width: 420px; max-width: 90%; padding: 16px 24px; border-radius: 16px; color: var(--text-main); box-shadow: var(--card-shadow); transform: translateY(150%); transition: transform 0.6s cubic-bezier(0.19, 1, 0.22, 1); display: flex; flex-direction: column; gap: 10px; }
        .cookie-banner.active { transform: translateY(0); }
        .cookie-header { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 1rem; color: var(--text-main); }
        .cookie-header i { color: var(--brand); }
        .cookie-text { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4; }
        .cookie-actions { display: flex; gap: 10px; margin-top: 2px; }
        .cookie-btn { flex: 1; padding: 8px 10px; border-radius: 50px; border: none; font-weight: 700; font-size: 0.85rem; cursor: pointer; transition: 0.3s; }
        .cookie-btn-primary { background: var(--brand-gradient); color: white; }
        .cookie-btn-secondary { background: var(--bg-surface-secondary); color: var(--text-main); border: 1px solid var(--border-color); }
        .cookie-btn-secondary:hover { background: var(--bg-surface-hover); }

        .modal-overlay { position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.6); backdrop-filter: blur(15px); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.4s ease; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: var(--bg-surface); border: var(--card-border); padding: 40px; border-radius: var(--radius); width: 360px; max-width: 90%; text-align: center; transform: translateY(30px); transition: 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: var(--card-shadow); }
        .modal-overlay.active .modal-content { transform: translateY(0); }
        .modal-close { position: absolute; top: 20px; right: 20px; cursor: pointer; opacity: 0.7; transition: 0.3s; color: var(--text-main); }
        .modal-close:hover { opacity: 1; color: var(--brand); }
        .modal-content h2 { margin-top: 0; margin-bottom: 25px; font-size: 1.8rem; color: var(--text-main); }
        .login-form input { width: 100%; padding: 12px 15px; margin-bottom: 15px; background: var(--bg-capsule); border: 1px solid var(--border-color); border-radius: 12px; color: var(--text-main); outline: none; box-sizing: border-box; transition: 0.3s; }
        .login-form input:focus { border-color: var(--brand); background: var(--bg-surface); }
        .login-submit-btn { width: 100%; padding: 12px; background: var(--brand-gradient); border: none; border-radius: 12px; color: white; font-weight: 700; font-size: 1rem; cursor: pointer; transition: 0.3s; text-transform: uppercase; letter-spacing: 0.05em; }
        .login-submit-btn:hover { transform: scale(1.02); box-shadow: 0 10px 25px rgba(131, 205, 32, 0.3); }

        .leaflet-container, .leaflet-interactive, .leaflet-marker-icon, .leaflet-marker-shadow { outline: none !important; -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body>

<nav class="project-nav-bar">
    <div class="nav-left">
        <div class="nav-capsule-box">
            <a href="#" class="nav-logo" onclick="location.reload()">
                <div class="logo-icon-box"><i data-lucide="activity"></i></div>
                <span>ecoSignal</span>
            </a>
        </div>
    </div>

    <div class="nav-right">
        <div class="nav-capsule-box">
            <button class="nav-btn-simple" onclick="toggleTheme()" title="Switch Theme">
                <i data-lucide="moon" id="theme-icon-el" size="20"></i>
            </button>
            <div class="nav-divider"></div>

            <button class="nav-btn-simple" title="Information"><i data-lucide="info" size="20"></i></button>
            <div class="nav-divider"></div>

            <div id="guest-nav-btn" class="user-capsule-btn" onclick="openLogin()">
                <div class="user-avatar-icon"><i data-lucide="log-in" size="16"></i></div>
                <span class="user-name-text">Login</span>
            </div>

            <div class="user-wrapper" id="user-menu-wrapper" style="display: none;">
                <div class="user-capsule-btn" onclick="toggleUserMenu()">
                    <div class="user-avatar-icon"><i data-lucide="user" size="16"></i></div>
                    <span class="user-name-text" id="display-username">User</span>
                    <i data-lucide="chevron-down" class="chevron-icon" size="14"></i>
                </div>
                <div class="dropdown-menu">
                    <a href="#" class="dropdown-item"><i data-lucide="settings" size="18"></i> Settings</a>
                    <div class="dropdown-divider"></div>
                    <a href="#" class="dropdown-item danger" onclick="handleLogout(event)"><i data-lucide="log-out" size="18"></i> Logout</a>
                </div>
            </div>
        </div>
    </div>
</nav>

<div id="cookie-banner" class="cookie-banner">
    <div class="cookie-header"><i data-lucide="cookie" size="24"></i><span>Cookie Settings</span></div>
    <div class="cookie-text">We use cookies to improve your experience and analyze our traffic. By clicking "Accept", you consent to our use of cookies.</div>
    <div class="cookie-actions">
        <button id="cookie-reject" class="cookie-btn cookie-btn-secondary">Reject</button>
        <button id="cookie-accept" class="cookie-btn cookie-btn-primary">Accept</button>
    </div>
</div>

<div id="login-modal" class="modal-overlay">
    <div class="modal-content">
        <i data-lucide="x" class="modal-close" id="close-modal-btn"></i>
        <h2>Welcome Back</h2>
        <form class="login-form" id="login-form-el">
            <input type="text" id="username-input" placeholder="Username" required>
            <input type="password" placeholder="Password" required>
            <button type="submit" class="login-submit-btn">Login</button>
        </form>
    </div>
</div>

<div class="swiper mainSwiper">
    <div class="swiper-wrapper">
        <div class="swiper-slide" id="page-home">
            <div class="bg-image"></div>
            <div class="home-content">
                <div class="brand-logo"><i data-lucide="activity"></i> <span>ecoSignal</span></div>
                <div class="hero-title">Open-source online<br>platform for ecoacoustics</div>
                <div class="hero-desc">Use ecoSignal to manage, navigate, visualize, annotate, and analyze soundscape recordings.</div>
                <div class="btn-group">
                    <a href="#" class="pill-btn"><i data-lucide="github"></i> GitHub</a>
                    <a href="#" class="pill-btn"><i data-lucide="file-text"></i> F1000Research</a>
                    <a href="#" class="pill-btn"><i data-lucide="graduation-cap"></i> Scholar</a>
                    <a href="#" class="pill-btn"><i data-lucide="mail"></i> Email</a>
                </div>
            </div>
        </div>

        <div class="swiper-slide" id="page-project">
            <div class="project-fixed-ui">
                <div class="search-bar"><i data-lucide="search"></i><input type="text" placeholder="Search projects..."></div>
                <div class="info-card" id="info-card-el"><div class="info-content-wrapper" id="project-info-content"></div></div>
            </div>
            <div class="swiper projectSwiper"><div class="swiper-wrapper" id="project-slides-container"></div></div>
            <div class="thumbs-container">
                <div class="thumbs-button-prev"><i data-lucide="chevron-left"></i></div>
                <div class="swiper thumbs-swiper"><div class="swiper-wrapper" id="thumbs-slides-container"></div></div>
                <div class="thumbs-button-next"><i data-lucide="chevron-right"></i></div>
            </div>
        </div>

        <div class="swiper-slide" id="page-map">
            <div class="map-brand-overlay"><div class="map-brand-text"><span>ecoSignal</span> Network</div></div>
            <div class="stats-container" id="side-stats">
                <div class="stat-card"><div class="stat-icon"><i data-lucide="users" size="26"></i></div><div class="stat-info"><div class="label">Users</div><div class="value" id="val-users">0</div></div></div>
                <div class="stat-card"><div class="stat-icon"><i data-lucide="folder-kanban" size="26"></i></div><div class="stat-info"><div class="label">Projects</div><div class="value" id="val-projects">0</div></div></div>
                <div class="stat-card"><div class="stat-icon"><i data-lucide="library" size="26"></i></div><div class="stat-info"><div class="label">Collections</div><div class="value" id="val-collections">0</div></div></div>
                <div class="stat-card"><div class="stat-icon"><i data-lucide="mic" size="26"></i></div><div class="stat-info"><div class="label">Audio</div><div class="value" id="val-audio">0</div></div></div>
                <div class="stat-card"><div class="stat-icon"><i data-lucide="image" size="26"></i></div><div class="stat-info"><div class="label">Photos</div><div class="value" id="val-photos">0</div></div></div>
                <div class="stat-card"><div class="stat-icon"><i data-lucide="video" size="26"></i></div><div class="stat-info"><div class="label">Videos</div><div class="value" id="val-videos">0</div></div></div>
                <div class="stat-card"><div class="stat-icon"><i data-lucide="file-json" size="26"></i></div><div class="stat-info"><div class="label">Metadata</div><div class="value" id="val-metadata">0</div></div></div>
                <div class="stat-card"><div class="stat-icon"><i data-lucide="tags" size="26"></i></div><div class="stat-info"><div class="label">Tags</div><div class="value" id="val-tags">0</div></div></div>
                <div class="stat-card"><div class="stat-icon"><i data-lucide="map-pin" size="26"></i></div><div class="stat-info"><div class="label">Sites</div><div class="value" id="val-sites">0</div></div></div>
            </div>
            <div id="map-pane"></div>
        </div>

        <div class="swiper-slide" id="page-sponsors">
            <div class="aurora-bg"><div class="aurora-blob"></div><div class="aurora-blob"></div></div>
            <div class="sponsors-wrapper">
                <div class="sponsors-header"><h2 class="main-title">Sponsored <span>By</span></h2><p class="sponsors-desc">Our research is made possible through the generous support of leading academic institutions and environmental organizations.</p></div>
                <div class="logo-grid">
                    <div class="sponsor-card"><img src="https://ecosound-web.de/ecosound_web/assets/images/project/inrae.png" alt="INRAE"></div>
                    <div class="sponsor-card"><img src="https://ecosound-web.de/ecosound_web/assets/images/project/westlake_univ.png" alt="Westlake"></div>
                    <div class="sponsor-card"><img src="https://ecosound-web.de/ecosound_web/assets/images/project/dfg_logo.png" alt="DFG"></div>
                    <div class="sponsor-card"><img src="https://ecosound-web.de/ecosound_web/assets/images/project/fly_bee.png" alt="FlyBee"></div>
                    <div class="sponsor-card"><img src="https://ecosound-web.de/ecosound_web/assets/images/project/NFDI4Earth_logo.png" alt="NFDI"></div>
                    <div class="sponsor-card"><img src="https://ecosound-web.de/ecosound_web/assets/images/project/sealab_logo.png" alt="SeaLab"></div>
                </div>
                <div class="sponsors-footer-action"><a href="mailto:contact@ecosignal.org" class="join-btn"><i data-lucide="mail" size="18"></i> Contact Us</a></div>
            </div>
        </div>

        <div class="swiper-slide" id="page-footer" style="height: 36vh !important;">
            <div style="display:flex; flex-direction:column; justify-content:center; align-items:center; height:100%; background:#050505; color:rgba(255,255,255,0.5);">
                <div style="font-size:2rem; font-weight:900; color:white; margin-bottom:20px;"><span>ecoSignal</span></div>
                <div style="display:flex; gap:30px; margin-bottom:40px;"><a href="#">About</a><a href="#">API</a><a href="#">Privacy</a></div>
                <p>&copy; 2025 ecoSignal. All rights reserved.</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    lucide.createIcons();

    // --- 1. THEME LOGIC ---
    function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        const target = current === 'dark' ? 'light' : 'dark';
        setTheme(target);
    }

    function setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);

        const icon = document.getElementById('theme-icon-el');
        if (icon) {
            icon.setAttribute('data-lucide', theme === 'dark' ? 'sun' : 'moon');
            lucide.createIcons();
        }
    }

    // Initialize Theme (Default to Dark for original look, unless Light saved)
    (function initTheme() {
        const saved = localStorage.getItem('theme');
        const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        // PREFER DARK IF NO PREFERENCE
        const defaultTheme = saved || (systemDark ? 'dark' : 'dark');
        setTheme(defaultTheme);
    })();

    // --- 2. AUTH LOGIC ---
    const loginModal = document.getElementById('login-modal');
    const closeBtn = document.getElementById('close-modal-btn');
    const loginForm = document.getElementById('login-form-el');
    const guestNavBtn = document.getElementById('guest-nav-btn');
    const userMenuWrapper = document.getElementById('user-menu-wrapper');

    function openLogin() { loginModal.classList.add('active'); }
    function closeModal() { loginModal.classList.remove('active'); }

    if (closeBtn) closeBtn.addEventListener('click', closeModal);
    if (loginModal) loginModal.addEventListener('click', (e) => { if (e.target === loginModal) closeModal(); });

    // Handle Login Submit
    if (loginForm) {
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username-input').value;

            // 1. Close Modal
            closeModal();

            // 2. Switch UI
            if(guestNavBtn) guestNavBtn.style.display = 'none';
            if(userMenuWrapper) userMenuWrapper.style.display = 'block';

            // 3. Update Name
            const displayUser = document.getElementById('display-username');
            if(displayUser) displayUser.textContent = username || "Liudilong";
        });
    }

    // Toggle User Dropdown
    function toggleUserMenu() {
        if (!userMenuWrapper) return;
        const isActive = userMenuWrapper.classList.contains('active');
        userMenuWrapper.classList.remove('active');
        if(!isActive) userMenuWrapper.classList.add('active');
    }

    // Click outside to close menu
    document.addEventListener('click', (e) => {
        if (userMenuWrapper && !e.target.closest('.user-wrapper')) {
            userMenuWrapper.classList.remove('active');
        }
    });

    // Handle Logout
    function handleLogout(e) {
        e.preventDefault();
        if (userMenuWrapper) {
            userMenuWrapper.classList.remove('active');
            userMenuWrapper.style.display = 'none';
        }
        if(guestNavBtn) guestNavBtn.style.display = 'flex';
    }

    // --- EXISTING LOGIC ---
    const cookieBanner = document.getElementById('cookie-banner');
    const acceptBtn = document.getElementById('cookie-accept');
    const rejectBtn = document.getElementById('cookie-reject');

    function setConsent(value) {
        try { localStorage.setItem('cookieConsent', value); } catch(e) {}
        cookieBanner.classList.remove('active');
    }

    function checkCookieConsent() {
        let hasConsent = false;
        try { if (localStorage.getItem('cookieConsent')) hasConsent = true; } catch(e) {}
        if (!hasConsent) setTimeout(() => { cookieBanner.classList.add('active'); }, 1500);
    }

    acceptBtn.addEventListener('click', () => setConsent('accepted'));
    rejectBtn.addEventListener('click', () => setConsent('rejected'));
    checkCookieConsent();

    document.getElementById('info-card-el').addEventListener('wheel', function(e) { e.stopPropagation(); }, { passive: false });

    var mainSwiper = new Swiper(".mainSwiper", {
        direction: "vertical", slidesPerView: "auto", mousewheel: true, allowTouchMove: false, speed: 800,
        on: {
            slideChangeTransitionEnd: function () {
                if (this.activeIndex === 2) {
                    map.invalidateSize();
                    updatePanel(currentSelectedNode);
                }
            }
        }
    });

    const baseImages = [
        'https://ecosound-web.de/ecosound_web/sounds/projects/108.jpeg', 'https://ecosound-web.de/ecosound_web/sounds/projects/117.jpeg',
        'https://ecosound-web.de/ecosound_web/sounds/projects/121.jpeg', 'https://ecosound-web.de/ecosound_web/sounds/projects/105.jpeg',
        'https://ecosound-web.de/ecosound_web/sounds/projects/114.jpeg', 'https://ecosound-web.de/ecosound_web/sounds/projects/123.jpeg',
        'https://ecosound-web.de/ecosound_web/sounds/projects/124.jpeg', 'https://ecosound-web.de/ecosound_web/sounds/projects/109.jpeg',
        'https://ecosound-web.de/ecosound_web/sounds/projects/118.jpeg', 'https://ecosound-web.de/ecosound_web/sounds/projects/101.jpeg',
        'https://ecosound-web.de/ecosound_web/sounds/projects/125.jpeg'
    ];

    const mainSlidesContainer = document.getElementById('project-slides-container');
    const thumbsSlidesContainer = document.getElementById('thumbs-slides-container');

    for(let i=0; i<25; i++) {
        const img = baseImages[i % baseImages.length];
        mainSlidesContainer.innerHTML += `<div class="swiper-slide"><div class="bg-image" style="background-image: url('${img}');"></div></div>`;
        thumbsSlidesContainer.innerHTML += `<div class="swiper-slide" style="background-image: url('${img}');"></div>`;
    }

    const projectData = [
        {
            id: "10.12688/f1000research", status: "lock", title: "SeabirdIslands", author: "liudilong",
            desc: "Dry summers leave their mark on Switzerland's forests: many trees have sparse crowns and die off. These developments pose challenges for forest owners, forestry services and society - but they also offer big opportunities for the biodiversity. The Swiss Ornithological Institute is working with partners to protect forests suffering from drought stress so that they are left to decompose for 30 years. Passive acoustic monitoring (PAM) is used to record changes in the composition of breeding birds.",
            tags: ["Arne Wenzel", "Dr. Iva", "J. Zech", "Somme Group"]
        },
        {
            id: "Project ID: #8821", status: "unlock", title: "Amazon Rainfall", author: "BioTeam Alpha",
            desc: "Monitoring the acoustic diversity of the Amazon rainforest during the rainy season to track amphibian migration patterns. This project utilizes a network of 500+ open-source sensors deployed across the canopy and forest floor to capture the symphony of life.",
            tags: ["Dr. Silva", "Rainforest Labs", "Climate Watch"]
        },
        {
            id: "dataset #902", status: "unlock", title: "Alpine Wolves", author: "Dr. Weber",
            desc: "Audio recordings of wolf packs in the Austrian Alps. Short dataset focusing on nocturnal howls.",
            tags: ["Canis lupus", "Austria"]
        }
    ];

    const infoCardEl = document.getElementById('info-card-el');
    const contentContainer = document.getElementById('project-info-content');

    function renderProjectInfo(index) {
        const data = projectData[index % projectData.length];
        const startHeight = infoCardEl.getBoundingClientRect().height;
        infoCardEl.style.height = startHeight + 'px';
        contentContainer.classList.add('fading');

        setTimeout(() => {
            const tagsHtml = data.tags.map(tag => `<span class="tag">${tag}</span>`).join('');
            const lockClass = data.status === 'lock' ? 'locked' : 'unlocked';
            contentContainer.innerHTML = `<div class="card-header"><div class="meta-left">${data.id}</div><a href="#" class="top-link-icon"><i data-lucide="link"></i></a></div><a href="#" class="project-title"><h2>${data.title}</h2></a><div class="creator-row"><span class="creator-name">${data.author}</span><div class="status-icon ${lockClass}"><i data-lucide="${data.status}"></i></div></div><hr><p>${data.desc}</p><div class="tags">${tagsHtml}</div>`;
            lucide.createIcons();
            infoCardEl.style.height = 'auto';
            const targetHeight = infoCardEl.getBoundingClientRect().height;
            if(Math.abs(startHeight - targetHeight) < 1) { infoCardEl.style.height = 'auto'; contentContainer.classList.remove('fading'); }
            else { infoCardEl.style.height = startHeight + 'px'; void infoCardEl.offsetHeight; infoCardEl.style.height = targetHeight + 'px'; contentContainer.classList.remove('fading'); setTimeout(() => { infoCardEl.style.height = 'auto'; }, 400); }
        }, 300);
    }

    var thumbsSwiper = new Swiper(".thumbs-swiper", {
        spaceBetween: 20, slidesPerView: 10, slidesPerGroup: 10, freeMode: false, allowTouchMove: true, watchSlidesProgress: true,
        navigation: { nextEl: ".thumbs-button-next", prevEl: ".thumbs-button-prev" },
    });

    var projectSwiper = new Swiper(".projectSwiper", {
        direction: "horizontal", loop: false, effect: 'slide', speed: 600, nested: true,
        thumbs: { swiper: thumbsSwiper },
        on: { init: function () { renderProjectInfo(0); }, slideChange: function () { renderProjectInfo(this.activeIndex); } }
    });

    const nodeData = {
        "GWDG - EFForTS VM": { users: 142, projects: 15, collections: 48, sites: 12, audio: "4.2k", photo: "1.2k", video: "350", metadata: "15k", tags: 856, coords: [51.56, 9.95] },
        "INRAE - Monitor PAM VM": { users: 95, projects: 8, collections: 26, sites: 5, audio: "1.8k", photo: "560", video: "120", metadata: "8.5k", tags: 432, coords: [43.59, 1.44] },
        "INRAE - EFNO test VM": { users: 312, projects: 42, collections: 156, sites: 38, audio: "12.5k", photo: "3.8k", video: "950", metadata: "45k", tags: 2109, coords: [47.8, 2.7] }
    };
    let currentSelectedNode = "GWDG - EFForTS VM";

    const map = L.map('map-pane', { zoomControl: false, attributionControl: false, scrollWheelZoom: false }).setView([48, 6], 5.5);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', { opacity: 1 }).addTo(map);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', { opacity: 0.7 }).addTo(map);

    const mapContainer = document.getElementById('map-pane');
    document.addEventListener('keydown', (e) => { if (e.key === 'Shift') { map.scrollWheelZoom.enable(); } });
    document.addEventListener('keyup', (e) => { if (e.key === 'Shift') { map.scrollWheelZoom.disable(); } });
    mapContainer.addEventListener('wheel', (e) => { if (e.shiftKey) { e.stopPropagation(); } }, { passive: false });

    const container = document.getElementById('side-stats');
    let currentPanelNode = "";

    function updatePanel(name) {
        if (currentPanelNode === name) return;
        currentPanelNode = name;
        const isActive = container.classList.contains('active');
        container.classList.remove('active');
        setTimeout(() => {
            const data = nodeData[name];
            document.getElementById('val-users').innerText = data.users;
            document.getElementById('val-projects').innerText = data.projects;
            document.getElementById('val-sites').innerText = data.sites;
            document.getElementById('val-collections').innerText = data.collections;
            document.getElementById('val-audio').innerText = data.audio;
            document.getElementById('val-photos').innerText = data.photo;
            document.getElementById('val-videos').innerText = data.video;
            document.getElementById('val-metadata').innerText = data.metadata;
            document.getElementById('val-tags').innerText = data.tags;
            container.classList.add('active');
            if (typeof setSelectedMarker === 'function') setSelectedMarker(name);
        }, isActive ? 500 : 100);
    }
    const markersByName = {};
    let currentSelectedMarkerEl = null;

    const createPremiumIcon = (name) => L.divIcon({ className: 'premium-marker', html: `<div class="marker-label">${name}</div><div class="radar-ring"></div><div class="radar-ring"></div><div class="marker-core"></div>`, iconSize: [40, 40] });

    function setSelectedMarker(name) {
        try {
            Object.keys(markersByName).forEach(n => {
                const m = markersByName[n];
                const el = m && m.getElement();
                if (el) { el.classList.remove('marker-selected'); el.classList.remove('marker-hover'); }
            });
            const marker = markersByName[name];
            if (!marker) { currentSelectedMarkerEl = null; return; }
            const el = marker.getElement();
            if (el) { el.classList.add('marker-selected'); currentSelectedMarkerEl = el; } else { currentSelectedMarkerEl = null; }
        } catch (err) { console.warn('setSelectedMarker error', err); }
    }

    Object.keys(nodeData).forEach(name => {
        const marker = L.marker(nodeData[name].coords, { icon: createPremiumIcon(name) }).addTo(map);
        markersByName[name] = marker;
        marker.on('mouseover', (e) => { const el = marker.getElement(); if (!el) return; if (el !== currentSelectedMarkerEl) el.classList.add('marker-hover'); });
        marker.on('mouseout', (e) => { const el = marker.getElement(); if (!el) return; if (el !== currentSelectedMarkerEl) el.classList.remove('marker-hover'); });
        marker.on('click', (e) => { L.DomEvent.stopPropagation(e); currentSelectedNode = name; updatePanel(name); setSelectedMarker(name); map.flyTo(nodeData[name].coords, 6, { duration: 1 }); });
    });
    setSelectedMarker(currentSelectedNode);
</script>
</body>
</html>