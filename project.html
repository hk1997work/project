<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ecoSignal | Dashboard</title>

    <script src="https://unpkg.com/lucide@latest"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

    <style>
        :root {
            /* --- COLOR PALETTE (基础色) --- */
            --brand: #83CD20;
            --brand-tint: rgba(131, 205, 32, 0.08);
            --brand-hover: #72b51b;

            /* --- LIGHT THEME (默认亮色变量) --- */
            --bg-page: radial-gradient(circle at top left, #ffffff, #f8fafc);
            --bg-nav: rgba(255, 255, 255, 0.85);
            --bg-capsule: #f1f5f9;
            --bg-surface: #ffffff;
            --bg-surface-hover: #fcfcfc;
            --bg-surface-secondary: #f8fafc;
            --bg-input: #ffffff;
            --bg-header-tint: rgba(255, 255, 255, 0.4);

            --text-main: #1e293b;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border-light: #e2e8f0;
            --border-color: rgba(0, 0, 0, 0.06);

            /* --- CARD STYLES --- */
            --glass-bg: rgba(255, 255, 255, 0.9);
            --card-bg: #ffffff;
            --card-border: 1px solid rgba(0, 0, 0, 0.06);
            --card-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.08),
            0 0 0 1px rgba(255, 255, 255, 0.8) inset;

            /* --- DIMENSIONS --- */
            --nav-height: 80px;
            --capsule-height: 48px;
            --radius: 24px;

            /* --- LAYOUT PROPORTIONS --- */
            --w-wide: 60%;
            --gap: 32px;

            /* --- ANIMATION --- */
            --anim-layout-duration: 0.8s;
            --anim-layout-ease: cubic-bezier(0.19, 1, 0.22, 1);
            --anim-fade-duration: 0.3s;
            --anim-fade-ease: ease-out;

            /* --- FONTS --- */
            --font-sans: 'Inter', sans-serif;

            /* --- MAP DYNAMIC VARS --- */
            --site-color: #0f172a;
            --site-color-tint: rgba(15, 23, 42, 0.05);

            --tl-scale: 1;
        }

        /* --- DARK THEME OVERRIDES (暗色主题覆盖) --- */
        [data-theme="dark"] {
            --bg-page: radial-gradient(circle at top left, #0f172a, #020617);
            --bg-nav: rgba(15, 23, 42, 0.85);
            --bg-capsule: #334155;
            --bg-surface: #1e293b;
            --bg-surface-hover: #334155;
            --bg-surface-secondary: #020617;
            --bg-input: #0f172a;
            --bg-header-tint: rgba(0, 0, 0, 0.2);

            --text-main: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;

            --border-light: #334155;
            --border-color: rgba(255, 255, 255, 0.1);

            --glass-bg: rgba(30, 41, 59, 0.85);
            --card-bg: #1e293b;
            --card-border: 1px solid rgba(255, 255, 255, 0.08);
            --card-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.4),
            0 0 0 1px rgba(255, 255, 255, 0.05) inset;

            --site-color: #f8fafc;
        }

        /* --- Leaflet Map Dark Mode (地图暗色滤镜) --- */
        [data-theme="dark"] .leaflet-layer,
        [data-theme="dark"] .leaflet-control-zoom-in,
        [data-theme="dark"] .leaflet-control-zoom-out,
        [data-theme="dark"] .leaflet-control-attribution {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }

        [data-theme="dark"] #full-map {
            background: #0f172a;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: var(--font-sans);
            background: var(--bg-page);
            color: var(--text-main);
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.06);
            border-radius: 10px;
            transition: background 0.2s;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--brand);
        }

        /* =========================================
   NAVIGATION
   ========================================= */
        .project-nav-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--nav-height);
            z-index: 5000;
            background: var(--bg-nav);
            backdrop-filter: blur(25px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 30px;
            box-sizing: border-box;
            gap: 16px;
        }

        .nav-capsule-box {
            position: relative;
            display: flex;
            align-items: center;
            background: var(--bg-capsule);
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.04), inset -1px -1px 3px rgba(255, 255, 255, 0.1);
            border-radius: 60px;
            padding: 4px;
            height: var(--capsule-height);
            box-sizing: border-box;
        }

        [data-theme="dark"] .nav-capsule-box {
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.2);
        }

        .nav-left {
            display: flex;
            align-items: center;
            margin-right: auto;
        }

        .nav-center {
            flex: 0 0 auto;
        }

        .nav-right {
            display: flex;
            justify-content: flex-end;
        }

        .nav-divider {
            width: 1px;
            height: 16px;
            background: var(--border-color);
            margin: 0 6px;
            flex-shrink: 0;
        }

        .nav-logo span,
        .crumb-btn,
        .nav-item,
        .user-name-text {
            font-family: var(--font-sans);
            font-size: 0.9rem;
            font-weight: 600;
            letter-spacing: -0.2px;
        }

        /* --- Logo Styles --- */
        .nav-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--text-main);
            padding: 0 12px;
            height: 100%;
            border-radius: 40px;
            margin-right: 0;
            transition: all 0.2s ease;
        }

        .nav-logo:hover {
            background: var(--brand);
            color: white;
            box-shadow: 0 4px 12px rgba(131, 205, 32, 0.3);
        }

        .logo-icon-box {
            width: 28px;
            height: 28px;
            background: var(--brand);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(131, 205, 32, 0.4);
            transition: all 0.2s ease;
        }

        .nav-logo:hover .logo-icon-box {
            background: white;
            color: var(--brand);
        }

        /* Breadcrumbs */
        .breadcrumb-group {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 100%;
        }

        .crumb-wrapper {
            position: relative;
            height: 100%;
        }

        .crumb-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: transparent;
            border: none;
            padding: 0 12px;
            height: 100%;
            border-radius: 40px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
        }

        .crumb-btn:hover {
            background: var(--brand);
            color: white;
            box-shadow: 0 4px 12px rgba(131, 205, 32, 0.3);
        }

        .crumb-wrapper.active .crumb-btn {
            color: var(--brand);
            background: var(--bg-surface-secondary);
        }

        .crumb-separator {
            margin: 0 2px;
            color: var(--text-muted);
            opacity: 0.6;
            font-size: 0.9rem;
        }

        .crumb-dropdown {
            position: absolute;
            top: calc(100% + 14px);
            left: 0;
            min-width: 320px;
            background: var(--bg-surface);
            border-radius: 16px;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
            padding: 0;
            z-index: 5002;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: 0.2s;
            border: var(--card-border);
        }

        .crumb-wrapper.active .crumb-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-search-box {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-icon-small {
            position: absolute;
            left: 12px;
            width: 16px;
            height: 16px;
            color: var(--text-muted);
            z-index: 2;
        }

        .dropdown-input {
            width: 100%;
            padding: 10px 12px 10px 36px;
            border: 1px solid var(--border-light);
            background: var(--bg-input);
            color: var(--text-main);
            border-radius: 10px;
            outline: none;
            font-family: var(--font-sans);
            font-size: 0.9rem;
            transition: all 0.2s;
            box-sizing: border-box;
        }

        .dropdown-input:focus {
            border-color: var(--brand);
            box-shadow: 0 0 0 2px var(--brand-tint);
        }

        .dropdown-list-scroll {
            max-height: 280px;
            overflow-y: auto;
            padding: 6px;
        }

        .crumb-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 2px;
        }

        .crumb-item:hover {
            background: var(--bg-surface-secondary);
            color: var(--brand);
        }

        .crumb-item.selected {
            background: var(--brand-tint);
            color: var(--brand);
        }

        .crumb-item .check-icon {
            opacity: 0;
            transition: opacity 0.2s;
            width: 16px;
            height: 16px;
            color: var(--brand);
        }

        .crumb-item.selected .check-icon {
            opacity: 1;
        }

        .empty-state {
            padding: 20px;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.85rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        /* Tabs */
        .sliding-pill {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 4px;
            background: var(--brand);
            border-radius: 50px;
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            z-index: 1;
            width: 0;
            pointer-events: none;
        }

        .nav-item {
            position: relative;
            z-index: 2;
            background: transparent;
            border: none;
            padding: 0 24px;
            height: 100%;
            border-radius: 50px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.25s ease;
        }

        .nav-item.active {
            color: white;
        }

        .nav-item:not(.active):hover {
            color: var(--brand);
        }

        /* Right Actions */
        .nav-btn-simple {
            background: transparent;
            border: none;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            width: 40px;
            height: 100%;
            border-radius: 40px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .nav-btn-simple:hover {
            background: var(--brand);
            color: white;
            box-shadow: 0 4px 12px rgba(131, 205, 32, 0.3);
        }

        .user-wrapper {
            position: relative;
            height: 100%;
        }

        .user-capsule-btn {
            padding: 0 16px 0 10px;
            border-radius: 40px;
            gap: 10px;
            height: 100%;
            display: flex;
            align-items: center;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .user-capsule-btn:hover {
            background: var(--brand);
            color: white;
            box-shadow: 0 4px 12px rgba(131, 205, 32, 0.3);
        }

        .user-avatar-icon {
            width: 30px;
            height: 30px;
            background: transparent;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .user-capsule-btn:hover .user-avatar-icon {
            background: white;
            color: var(--brand);
            box-shadow: none;
        }

        .user-wrapper.active .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 14px);
            right: 0;
            width: 220px;
            background: var(--bg-surface);
            border-radius: 20px;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.1);
            padding: 6px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: 0.2s;
            z-index: 5005;
            border: var(--card-border);
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            border-radius: 12px;
            text-decoration: none;
            color: var(--text-main);
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .dropdown-item:hover {
            background: var(--brand-tint);
            color: var(--brand);
        }

        .dropdown-item.danger:hover {
            background: #fee2e2;
            color: #ef4444;
        }

        [data-theme="dark"] .dropdown-item.danger:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .dropdown-divider {
            height: 1px;
            background: var(--border-color);
            margin: 4px 10px;
            opacity: 0.6;
        }

        /* =========================================
   GLOBAL LAYOUT
   ========================================= */
        .content-wrapper {
            position: absolute;
            top: var(--nav-height);
            bottom: 0;
            left: 0;
            right: 0;
            padding: 30px 40px 40px 40px;
            box-sizing: border-box;
            overflow: hidden;
        }

        #tab-map.tab-page {
            padding: 0;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: 0;
            width: 100%;
            height: 100%;
        }

        .tab-page {
            width: 100%;
            height: 100%;
            display: none;
            animation: fadeIn 0.5s ease forwards;
        }

        .tab-page.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: none;
                /* [关键修复] 移除 transform 以修复 sticky 定位 */
            }
        }

        .block-anim {
            transition: opacity var(--anim-fade-duration) var(--anim-fade-ease);
            opacity: 1;
        }

        .block-anim.fading-out {
            opacity: 0;
        }

        .dashboard-card {
            background: var(--glass-bg);
            border: var(--card-border);
            border-radius: var(--radius);
            box-shadow: var(--card-shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* =========================================
   PAGE STYLES
   ========================================= */
        .desc-layout {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .panel-anim {
            transition: transform var(--anim-layout-duration) var(--anim-layout-ease), left var(--anim-layout-duration) var(--anim-layout-ease), width var(--anim-layout-duration) var(--anim-layout-ease), opacity var(--anim-fade-duration) var(--anim-fade-ease);
        }

        #panel-proj-desc {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: var(--w-wide);
            opacity: 1;
            transform: translateX(0);
            z-index: 10;
            background: var(--glass-bg);
            border: var(--card-border);
            border-radius: var(--radius);
            box-shadow: var(--card-shadow);
            padding: 48px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        #panel-visual {
            position: absolute;
            top: 0;
            bottom: 0;
            left: calc(var(--w-wide) + var(--gap));
            width: calc(100% - var(--w-wide) - var(--gap));
            z-index: 20;
            will-change: left, width;
        }

        #panel-col-desc {
            position: absolute;
            top: 0;
            bottom: 0;
            left: calc(var(--w-wide) + var(--gap));
            width: calc(100% - var(--w-wide) - var(--gap));
            transform: translateX(150%);
            opacity: 0;
            z-index: 15;
            display: flex;
            flex-direction: column;
        }

        .desc-layout.mode-collection #panel-proj-desc {
            transform: translateX(-100%);
            opacity: 0;
        }

        .desc-layout.mode-collection #panel-visual {
            left: 0;
            width: var(--w-wide);
        }

        .desc-layout.mode-collection #panel-col-desc {
            transform: translateX(0);
            opacity: 1;
        }

        /* Headers, Text, etc. */
        .desc-header-section {
            flex-shrink: 0;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .title-row {
            display: flex;
            align-items: center;
            gap: 14px;
            margin: 0;
        }

        .desc-title-text {
            font-size: 2.8rem;
            font-weight: 800;
            letter-spacing: -1px;
            margin: 0;
            line-height: 1.1;
            color: var(--text-main);
            font-family: var(--font-sans);
        }

        .title-link-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-surface);
            color: var(--text-muted);
            transition: 0.3s;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .title-link-icon:hover {
            background: var(--brand);
            color: white;
        }

        .desc-content-area {
            flex: 1;
            overflow-y: auto;
            padding-right: 12px;
        }

        .desc-image-container {
            width: 100%;
            height: 100%;
            border-radius: var(--radius);
            overflow: hidden;
            background: #e2e8f0;
            box-shadow: var(--card-shadow);
            border: var(--card-border);
            transform: translateZ(0);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .desc-project-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.4s var(--anim-fade-ease);
        }

        .desc-project-img.loaded {
            opacity: 1;
        }

        .meta-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .meta-capsule-box {
            display: inline-flex;
            align-items: center;
            background: var(--bg-capsule);
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.04), inset -1px -1px 3px rgba(255, 255, 255, 0.1);
            border-radius: 60px;
            padding: 4px;
            gap: 4px;
        }

        [data-theme="dark"] .meta-capsule-box {
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.2);
        }

        .meta-item-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 4px 12px 4px 10px;
            border-radius: 40px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: default;
            transition: all 0.2s ease;
            text-decoration: none;
            height: 32px;
            box-sizing: border-box;
        }

        .meta-item-btn:hover {
            background: var(--bg-surface);
            color: var(--brand);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .meta-item-icon {
            width: 24px;
            height: 24px;
            background: transparent;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: inherit;
            box-shadow: none;
            transition: none;
        }

        .meta-divider {
            width: 1px;
            height: 16px;
            background: var(--border-color);
            margin: 0 2px;
        }

        .collection-card {
            background: var(--card-bg);
            width: 100%;
            height: 100%;
            border-radius: var(--radius);
            box-shadow: var(--card-shadow);
            border: var(--card-border);
            padding: 48px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 24px;
            position: relative;
            overflow: hidden;
        }

        .col-header-group {
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex-shrink: 0;
        }

        .col-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--brand);
            color: white;
            padding: 6px 14px;
            border-radius: 30px;
            font-weight: 700;
            font-size: 0.8rem;
            text-transform: uppercase;
            align-self: flex-start;
            margin-bottom: -5px;
        }

        .col-title {
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin: 0;
            color: var(--text-secondary);
        }

        .col-rich-text {
            font-size: 1.05rem;
            color: var(--text-secondary);
            line-height: 1.8;
            flex: 1;
            border-top: 1px solid var(--border-color);
            padding-top: 24px;
            overflow-y: auto;
        }

        .col-meta-row {
            display: flex;
            gap: 8px;
            margin-top: 4px;
        }

        .col-rt-modern h3 {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-main);
            margin: 1.5em 0 1em 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .col-rt-modern h3 i {
            color: var(--brand);
        }

        .col-rt-modern ul {
            padding-left: 0;
            display: grid;
            gap: 10px;
        }

        .col-rt-modern li {
            padding: 10px 14px;
            background: var(--bg-surface-secondary);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .col-rt-modern li::before {
            content: "";
            display: block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--brand);
        }

        .style-modern {
            color: var(--text-main);
            line-height: 1.8;
        }

        .style-modern h1 {
            font-size: 2.2rem;
            margin: 0 0 0.5em 0;
            font-weight: 800;
        }

        .style-modern h2 {
            font-size: 1.5rem;
            margin: 2em 0 1em 0;
            font-weight: 800;
            border-bottom: 3px solid var(--brand);
            display: inline-block;
            padding-bottom: 5px;
        }

        .style-modern h3 {
            font-size: 1.2rem;
            margin: 1.5em 0 0.8em;
            font-weight: 700;
            color: var(--text-main);
        }

        .style-modern p {
            margin-bottom: 1.2em;
        }

        .style-modern ul {
            margin-bottom: 1.5em;
            padding-left: 1.5em;
        }

        .style-modern li {
            margin-bottom: 0.5em;
        }

        .style-modern blockquote {
            border-left: 4px solid var(--brand);
            margin: 1.5em 0;
            padding: 1em 1.5em;
            background: var(--bg-surface-secondary);
            border-radius: 0 8px 8px 0;
            font-style: italic;
            color: var(--text-secondary);
        }

        .style-modern .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 2em 0;
        }

        .style-modern .data-item {
            background: var(--bg-surface);
            border: var(--card-border);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.02);
        }

        .style-modern .data-val {
            font-size: 1.8rem;
            font-weight: 900;
            display: block;
        }

        .style-modern .data-key {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 700;
            text-transform: uppercase;
        }

        /* Summary */
        .summary-layout {
            display: flex;
            gap: var(--gap);
            height: 100%;
            width: 100%;
        }

        .summary-stats-container {
            flex: 1.5;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-auto-rows: minmax(140px, 1fr);
            gap: 20px;
            height: 100%;
            overflow-y: auto;
            padding-right: 6px;
        }

        .summary-stat-card {
            background: var(--glass-bg);
            border: var(--card-border);
            border-radius: var(--radius);
            box-shadow: var(--card-shadow);
            padding: 0 32px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            cursor: default;
        }

        .summary-stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1);
            background: var(--bg-surface);
        }

        .stat-content-left {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
        }

        .summary-stat-val {
            font-size: 2.8rem;
            font-weight: 900;
            line-height: 1;
            letter-spacing: -1.5px;
            color: var(--text-main);
            margin-bottom: 4px;
        }

        .summary-stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
        }

        .summary-stat-card .bg-icon {
            position: absolute;
            bottom: -20px;
            /* 稍微减少偏移量 */
            right: -20px;
            width: 180px;
            /* [修复] 宽高保持固定，不参与动画 */
            height: 180px;
            opacity: 0.06;
            color: var(--text-main);
            /* [修复] 初始状态设为较小的 scale */
            transform: rotate(-10deg) scale(0.8);
            /* [修复] 明确 transition 属性，确保离开时平滑回归 */
            transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out, bottom 0.4s ease-in-out, right 0.4s ease-in-out, color 0.3s ease;
            pointer-events: none;
            z-index: 1;
        }

        .summary-stat-card:hover .bg-icon {
            bottom: 0;
            right: 0;
            /* [关键] 悬停时放大，离开时会顺着 scale 平滑缩小到 0.8，不会突变 */
            transform: rotate(0deg) scale(0.9);
            opacity: 1;
            color: var(--brand);
        }

        .summary-contributors-card {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--glass-bg);
            border: var(--card-border);
            border-radius: var(--radius);
            box-shadow: var(--card-shadow);
            overflow: hidden;
            height: 100%;
            position: relative;
        }

        .summary-contributors-card .bg-icon-contrib {
            position: absolute;
            bottom: -50px;
            right: -30px;
            width: 300px;
            height: 300px;
            opacity: 0.04;
            color: var(--text-main);
            transform: rotate(-10deg);
            pointer-events: none;
            z-index: 1;
            transition: all 0.5s ease;
        }

        .summary-contributors-card:hover .bg-icon-contrib {
            bottom: 0;
            right: 0;
            width: 280px;
            height: 280px;
            opacity: 1;
            color: var(--brand);
            transform: rotate(0deg);
        }

        .card-header,
        .card-body {
            position: relative;
            z-index: 2;
        }

        .card-header {
            padding: 20px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            flex-shrink: 0;
            background: var(--bg-header-tint);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            color: var(--brand);
        }

        .card-body {
            padding: 0;
            overflow-y: auto;
            flex: 1;
        }

        .contributors-list {
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }

        .contrib-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 28px;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }

        .contrib-item:hover {
            background: var(--brand-tint);
        }

        .contrib-info-block {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .contrib-name {
            font-weight: 700;
            color: var(--text-main);
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .contrib-name::before {
            content: '';
            display: block;
            width: 6px;
            height: 6px;
            background: var(--border-light);
            border-radius: 50%;
        }

        .contrib-item:first-child .contrib-name::before {
            background: var(--brand);
            box-shadow: 0 0 0 2px rgba(131, 205, 32, 0.2);
        }

        .contrib-sub {
            padding-left: 14px;
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            gap: 8px;
            align-items: center;
            font-weight: 500;
        }

        .contrib-sub svg {
            width: 13px;
            height: 13px;
            opacity: 0.8;
        }

        .contrib-email,
        .orcid-link {
            display: flex;
            align-items: center;
            gap: 4px;
            text-decoration: none;
            color: inherit;
            transition: color 0.2s;
            cursor: pointer;
        }

        .contrib-email:hover,
        .orcid-link:hover {
            color: var(--brand);
            text-decoration: underline;
        }

        .cid {
            font-family: var(--font-sans);
            letter-spacing: -0.3px;
            opacity: 0.9;
        }

        .contrib-divider {
            opacity: 0.3;
        }

        .contrib-role-text {
            display: inline-block;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            text-align: right;
        }

        .contrib-role-text.creator-role {
            color: var(--brand);
        }

        /* Media */
        .media-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* margin-bottom: 24px; */
            /* Removed per request */
            flex-shrink: 0;
        }

        .media-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .media-count-badge {
            background: var(--bg-capsule);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .media-controls {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .media-search-box {
            position: relative;
            display: flex;
            align-items: center;
            background: var(--bg-capsule);
            border-radius: 60px;
            /* [修改] 统一圆角为 60px */
            padding: 4px 16px;
            height: 44px;
            /* [修改] 统一使用导航栏胶囊的内阴影 */
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.04), inset -1px -1px 3px rgba(255, 255, 255, 0.1);
            width: 220px;
            box-sizing: border-box;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        /* [新增] 暗色模式阴影适配 */
        [data-theme="dark"] .media-search-box {
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.2);
        }

        .media-search-box:focus-within {
            background: var(--bg-surface);
            border-color: var(--brand);
            /* 聚焦时覆盖原有阴影 */
            box-shadow: 0 0 0 2px var(--brand-tint);
        }

        .media-search-icon {
            color: var(--text-secondary);
            width: 24px;
            /* [修改] 调整为 24px，与参考对象一致 */
            height: 24px;
            /* [修改] 调整为 24px */
            margin-right: 8px;
            transition: color 0.2s;
        }

        .media-search-input {
            border: none;
            background: transparent;
            outline: none;
            font-size: 0.85rem;
            /* 13.6px */
            width: 100%;
            color: var(--text-secondary);
            /* [修改] 颜色改为次级文本色，与按钮一致 */
            font-family: var(--font-sans);
            font-weight: 700;
            /* [新增] 加粗，与按钮字体风格一致 */
        }

        .media-search-input::placeholder {
            color: var(--text-muted);
            font-weight: 500;
        }

        .view-switcher-container {
            position: relative;
            display: flex;
            background: var(--bg-capsule);
            /* 统一导航栏的内阴影 */
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.04), inset -1px -1px 3px rgba(255, 255, 255, 0.1);
            border-radius: 60px;
            /* 统一圆角 */
            padding: 4px;
            height: 44px;
            box-sizing: border-box;
        }

        [data-theme="dark"] .view-switcher-container {
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.2);
        }

        .view-pill {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 4px;
            width: 90px;
            background: var(--brand);
            /* [关键修改] 绿色背景，同导航栏 */
            border-radius: 50px;
            box-shadow: none;
            /* 去除卡片阴影 */
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            z-index: 1;
            pointer-events: none;
        }

        .view-btn {
            position: relative;
            z-index: 2;
            background: transparent;
            border: none;
            padding: 0 20px;
            height: 100%;
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-secondary);
            /* 默认灰色，同导航栏 */
            transition: color 0.25s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: var(--font-sans);
        }

        .view-btn.active {
            color: white;
            /* [关键修改] 激活为白色 */
        }

        .view-btn:not(.active):hover {
            color: var(--brand);
            /* 悬停变绿 */
        }

        .media-scroll-area {
            flex: 1;
            overflow-y: auto;
            /* Updated padding */
            min-height: 0;
        }

        /* Gallery View Styles */
        .media-container.view-gallery {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            /* Fixed 5 columns */
            gap: 32px;
            /* Increased gap */
            padding: 20px;
        }

        .media-container.view-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 20px;
        }

        .media-item-card {
            background: var(--bg-surface);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
            border: 1px solid var(--border-color);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s, border-color 0.3s;
            display: flex;
            flex-direction: column;
            position: relative;
            cursor: default;
            /* Changed from pointer */
        }

        .media-item-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1);
            border-color: rgba(131, 205, 32, 0.4);
        }

        .spectrogram-cover {
            width: 100%;
            aspect-ratio: 2 / 1;
            background: #0f172a;
            position: relative;
            overflow: hidden;
            border-bottom: 1px solid var(--border-color);
        }

        .spectrogram-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            mix-blend-mode: screen;
            filter: sepia(1) hue-rotate(60deg) saturate(3) contrast(1.2);
            transition: transform 0.5s ease;
        }

        .media-item-card:hover .spectrogram-img {
            /* No zoom transform */
            opacity: 1;
        }

        .duration-badge {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 6px;
            font-family: var(--font-sans);
            pointer-events: none;
        }

        .media-card-info {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
            /* Fill remaining height */
        }

        .media-name {
            font-weight: 700;
            font-size: 1rem;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
            text-decoration: none;
            transition: color 0.2s;
            display: block;
        }

        .media-name:hover {
            color: var(--brand);
            text-decoration: underline;
        }

        .tags-row {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            min-height: 24px;
        }

        .media-tag {
            display: inline-flex;
            background: var(--brand);
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 20px;
            letter-spacing: 0.2px;
            box-shadow: 0 2px 5px rgba(131, 205, 32, 0.25);
        }

        /* Updated Footer Style */
        .media-meta-row {
            display: flex;
            justify-content: space-between;
            align-items: center;

            margin-top: auto;
            /* Bottom align */
            margin-left: -16px;
            /* Pull to edges */
            margin-right: -16px;
            margin-bottom: -16px;

            padding: 10px 16px;
            /* Inner spacing */
            background: var(--bg-surface-secondary);
            /* Footer bg */
            border-top: 1px solid var(--border-color);

            color: var(--text-secondary);
            font-size: 0.75rem;
            font-family: var(--font-sans);
            font-weight: 600;
            letter-spacing: -0.2px;
        }

        .meta-icon-text {
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0.8;
            transition: all 0.2s;
        }

        .media-item-card:hover .meta-icon-text {
            opacity: 1;
            color: var(--text-main);
        }

        /* List View Row - Updated Grid & Style */
        .media-item-row {
            background: var(--bg-surface);
            border-radius: 12px;
            display: grid;
            /* [修改] 第一列 auto (由图片容器决定)，中间 360px */
            grid-template-columns: auto 360px 1fr;
            align-items: stretch;
            gap: 24px;
            padding: 20px;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
            overflow: visible;
        }

        .media-item-row:hover {
            background: var(--bg-surface-hover);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
            border-color: rgba(131, 205, 32, 0.3);
        }

        /* List View Spectrogram Container */
        .media-item-row .list-spec-container {
            /* [修改] 使用固定宽度，确保每一行图片大小一致 */
            width: 320px;
            /* 高度自动，由 aspect-ratio 决定 */
            height: auto;
            /* 锁定 2:1 比例 (结果高度为 120px) */
            aspect-ratio: 2 / 1;

            /* [修改] 防止图片被行高拉伸，居中或顶部对齐 */
            align-self: center;

            border-radius: 8px;
            position: relative;
            background: #0f172a;
            border: 1px solid var(--border-color);
            overflow: hidden;
            /* 防止在极端情况下被压缩 */
            flex-shrink: 0;
        }

        .media-item-row .list-spec-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.8;
            mix-blend-mode: screen;
            filter: sepia(1) hue-rotate(60deg) saturate(3);
            transition: 0.3s;
        }

        .media-item-row:hover .list-spec-img {
            opacity: 1;
        }

        .media-item-row .duration-badge {
            position: absolute;
            bottom: 6px;
            right: 6px;
            background: rgba(0, 0, 0, 0.75);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: var(--font-sans);
            pointer-events: none;
            z-index: 2;
        }

        /* Middle Column: Basic Info */
        .row-basic-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
            justify-content: flex-start;
            padding-top: 4px;
            /* [新增] 确保中间列占满高度，以便底部对齐生效 */
            height: 100%;
            box-sizing: border-box;
        }

        a.row-name {
            font-weight: 800;
            font-size: 1.15rem;
            line-height: 1.4;
            color: var(--text-main);
            text-decoration: none;
            transition: color 0.2s;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        a.row-name:hover {
            color: var(--brand);
            text-decoration: underline;
        }

        .row-meta-list {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 16px;
            /* [修改] 使用 auto 将其推到容器底部 */
            margin-top: auto;
        }

        .row-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-family: var(--font-sans);
            font-weight: 500;
        }

        .row-meta-item i {
            opacity: 0.7;
        }

        /* Right Column: Details Grid */
        .row-details-col {
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid var(--border-light);
            height: 100%;
            box-sizing: border-box;
        }

        .rd-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 8px;
            margin-bottom: 4px;
        }

        .rd-site-group {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .rd-site-name {
            font-size: 0.95rem;
            font-weight: 800;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .rd-site-metrics {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: 8px;
            padding-left: 12px;
            border-left: 1px solid var(--border-color);
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: var(--font-mono);
            font-weight: 600;
        }

        .rd-site-metrics span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .rd-hierarchy {
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
        }

        .rd-bread-sep {
            opacity: 0.4;
            font-size: 0.8em;
        }

        .rd-grid {
            display: grid;
            /* [修改] 定义4列，最后一列宽度稍大，留给 Note */
            grid-template-columns: 1fr 1fr 1fr 1.5fr;
            grid-template-rows: auto auto;
            gap: 12px 16px;
            grid-auto-flow: dense;
        }

        .license-img {
            height: 20px;
            width: auto;
            vertical-align: middle;
            opacity: 0.9;
            margin-top: -2px;
        }

        .rd-item {
            display: flex;
            flex-direction: column;
            gap: 3px;
            overflow: hidden;
        }

        /* [新增] Note 专用样式：占据第4列的第1行到第2行 */
        .rd-item.span-v {
            grid-column: 4;
            grid-row: 1 / span 2;
            border-left: 1px solid var(--border-color);
            padding-left: 12px;
            height: 100%;
        }

        .rd-item.span-v .rd-val {
            white-space: normal;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            color: var(--text-secondary);
        }

        .rd-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .rd-val {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- Timeline Matrix Styles --- */

        /* [修改] New Dropdown Styles to Match Navigation */
        .custom-select-wrapper {
            position: relative;
            font-family: var(--font-sans);
        }

        .select-label {
            display: none;
        }

        /* Hide label to match nav style */

        .select-trigger {
            width: auto;
            min-width: 160px;
            height: 40px;
            padding: 0 16px;
            background: var(--bg-capsule);
            border: 1px solid transparent;
            border-radius: 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.2s;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }

        .select-trigger:hover:not(.disabled) {
            background: var(--bg-surface);
            border-color: var(--border-color);
            color: var(--text-main);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .select-trigger.active {
            background: var(--bg-surface);
            color: var(--brand);
            border-color: var(--brand);
        }

        /* [修改] Disabled Style */
        .select-trigger.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--bg-capsule);
            color: var(--text-muted);
            border-color: transparent;
            box-shadow: none;
            pointer-events: none;
        }

        .select-options {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            width: 100%;
            background: var(--bg-surface);
            border-radius: 16px;
            border: var(--card-border);
            box-shadow: var(--card-shadow);
            max-height: 280px;
            overflow-y: auto;
            z-index: 100;
            padding: 6px;
            box-sizing: border-box;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-5px);
            transition: 0.2s;
        }

        .custom-select-wrapper.open .select-options {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .select-option {
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-main);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.1s;
        }

        .select-option:hover {
            background: var(--bg-capsule);
            color: var(--brand);
        }

        .select-option.selected {
            background: rgba(131, 205, 32, 0.1);
            color: var(--brand);
            font-weight: 700;
        }

        /* Timeline Layout & Card Adaptation */
        .timeline-header-styled {
            /* [修改] 移除自定义背景和Padding，与 Media 标题保持完全一致 */
            z-index: 100;
        }

        .timeline-matrix-viewport {
            flex: 1;

            /* [修改] 开启原生滚动条，sticky 定位依赖于此 */
            overflow: auto;

            background: var(--bg-surface-secondary);
            position: relative;
            display: block;
            cursor: grab;

            /* [新增] 优化滚动条体验，防止内容抖动 */
            scrollbar-gutter: stable;
        }

        /* [新增] 单独定制时间轴的滚动条样式，使其更易点击但保持美观 */
        .timeline-matrix-viewport::-webkit-scrollbar {
            width: 10px; /* 纵向滚动条宽度 */
            height: 10px; /* 横向滚动条高度 */
        }

        .timeline-matrix-viewport::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.15); /*稍微加深颜色，提高可见度*/
            border: 2px solid transparent;
            background-clip: content-box;
            border-radius: 10px;
        }

        .timeline-matrix-viewport::-webkit-scrollbar-thumb:hover {
            background-color: var(--brand); /* 悬停变色 */
        }

        .timeline-matrix-viewport::-webkit-scrollbar-corner {
            background: transparent;
        }

        .timeline-matrix-viewport.active {
            cursor: grabbing;
        }

        .tl-matrix-table {
            display: grid;
            width: max-content;
            min-width: 100%;
            min-height: 100%;
        }

        /* Sticky Headers */
        .tl-matrix-corner {
            position: sticky;
            top: 0;
            left: 0;
            z-index: 30;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--brand);
            border-right: 1px solid var(--brand);

            width: 160px;
            min-width: 160px;
            box-sizing: border-box;

            /* [修改] 改回固定大小，与 .tl-col-header-cell 保持一致 */
            padding: 6px 10px;
            font-size: 0.85rem;

            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-weight: 800;
            color: var(--brand);
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.05);
            line-height: 1.3;
            text-align: center;
        }

        .tl-col-header-cell {
            position: sticky;
            top: 0;
            z-index: 20;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--brand);
            border-right: 1px solid var(--border-color);

            /* [修改] 改回固定大小，不再随缩放变化 */
            padding: 6px 10px;
            font-size: 0.85rem;

            font-weight: 700;
            color: var(--text-main);
            text-align: center;

            box-sizing: border-box;
            width: 100%;

            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
            overflow: hidden;
            white-space: nowrap;
        }

        .tl-row-header-cell {
            position: sticky;
            left: 0;
            z-index: 10;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--brand);

            /* [修复] 强制锁定宽度为 160px，严丝合缝对齐 Corner 和 Grid */
            width: 160px;
            min-width: 160px;
            max-width: 160px;
            box-sizing: border-box;

            /* 内容样式 */
            padding: 10px 12px;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            justify-content: center; /* 垂直居中 */
            align-items: flex-start;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.02);
            line-height: 1.3;

            /* 允许长文本换行，防止撑开 */
            overflow: hidden;
            word-wrap: break-word;
        }

        .tl-row-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
            font-weight: 500;
        }

        .tl-data-cell {
            border-bottom: 1px solid var(--border-color);
            border-right: 1px dashed var(--border-color);

            /* [关键修复] 统一盒模型，确保边框位置与表头严格对齐 */
            box-sizing: border-box;

            /* 建议：让内边距也随缩放微调，或者保持固定均可，这里保持固定 */
            padding: 16px;
            background: transparent;
            vertical-align: top;
        }

        .tl-data-cell:hover {
            background: rgba(131, 205, 32, 0.03);
        }

        /* [修改] 布局改由 JS 动态生成 Grid 控制，以支持多列自动扩展 */
        .tl-cell-grid {
            width: 100%;
        }

        /* [新增] 禁止时间轴卡片内的图片交互，防止拖拽 bug */
        .tl-media-card img {
            pointer-events: none;
            -webkit-user-drag: none;
            user-select: none;
        }

        .tl-media-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: calc(12px * var(--tl-scale, 1)); /* 动态圆角 */
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
        }

        .tl-media-card:hover {
            transform: translateY(calc(-3px * var(--tl-scale, 1)));
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            border-color: var(--brand);
            z-index: 5;
        }

        /* [新增] 强制图标缩放 */
        .tl-media-card svg {
            width: calc(14px * var(--tl-scale, 1));
            height: calc(14px * var(--tl-scale, 1));
        }

        .tl-media-card .spectrogram-cover {
            width: 100%;
            aspect-ratio: 2 / 1;
            position: relative;
            overflow: hidden;
            border-bottom: 1px solid var(--border-color);
        }

        .tl-media-card .spectrogram-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.85;
            mix-blend-mode: screen;
            filter: sepia(1) hue-rotate(60deg) saturate(3) contrast(1.2);
        }

        /* [新增] 让频谱图上的时间标签跟随缩放 */
        .tl-media-card .duration-badge {
            font-size: calc(0.7rem * var(--tl-scale, 1));
            padding: calc(3px * var(--tl-scale, 1)) calc(8px * var(--tl-scale, 1));
            border-radius: calc(6px * var(--tl-scale, 1));

            /* 位置偏移也需要缩放，否则缩小后会离边缘太远 */
            bottom: calc(8px * var(--tl-scale, 1));
            right: calc(8px * var(--tl-scale, 1));
        }

        .tl-media-card .play-circle {
            width: calc(40px * var(--tl-scale, 1));
            height: calc(40px * var(--tl-scale, 1));
        }

        /* 播放图标单独处理 */
        .tl-media-card .play-circle svg {
            width: calc(20px * var(--tl-scale, 1));
            height: calc(20px * var(--tl-scale, 1));
        }

        .tl-media-card .media-card-info {
            padding: calc(10px * var(--tl-scale, 1)); /* 动态内边距 */
            display: flex;
            flex-direction: column;
            gap: calc(6px * var(--tl-scale, 1)); /* 动态间距 */
        }

        .tl-media-card .media-name {
            font-weight: 700;
            font-size: calc(0.85rem * var(--tl-scale, 1)); /* 动态字体 */
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tl-media-card .media-tag {
            padding: calc(2px * var(--tl-scale, 1)) calc(8px * var(--tl-scale, 1));
            font-size: calc(0.65rem * var(--tl-scale, 1));
            border-radius: calc(20px * var(--tl-scale, 1));
        }

        .tl-media-card .tags-row {
            gap: calc(6px * var(--tl-scale, 1));
            min-height: calc(20px * var(--tl-scale, 1));
        }

        /* [新增] Timeline Card Meta Row 适配 - 全部动态计算 */
        .tl-media-card .media-meta-row {
            margin-left: calc(-10px * var(--tl-scale, 1));
            margin-right: calc(-10px * var(--tl-scale, 1));
            margin-bottom: calc(-10px * var(--tl-scale, 1));

            /* [修改] 稍微减小内边距，让底部更紧凑 */
            padding: calc(6px * var(--tl-scale, 1)) calc(10px * var(--tl-scale, 1));

            margin-top: auto;

            /* [修改] 字体减小：从 0.75rem -> 0.65rem */
            font-size: calc(0.5rem * var(--tl-scale, 1));

            /* [新增] 稍微调淡颜色，增加层次感 */
            color: var(--text-muted);
            font-weight: 600;
        }

        /* [新增] 专门缩小底部栏的图标，使其与小字体匹配 (从全局14px -> 11px) */
        .tl-media-card .media-meta-row svg {
            width: calc(11px * var(--tl-scale, 1));
            height: calc(11px * var(--tl-scale, 1));
            opacity: 0.8;
        }

        .tl-media-card .meta-icon-text {
            /* [修改] 间距稍微收紧 */
            gap: calc(3px * var(--tl-scale, 1));
        }

        .placeholder-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            text-align: center;
            background: var(--glass-bg);
            border-radius: var(--radius);
            border: var(--card-border);
            box-shadow: var(--card-shadow);
            color: var(--text-muted);
        }

        .placeholder-card h2 {
            font-size: 1.4rem;
            color: var(--text-main);
            margin-bottom: 8px;
            margin-top: 0;
        }

        .placeholder-card p {
            font-size: 1rem;
            line-height: 1.6;
        }

        /* =========================================
   MAP & FILTER & SIDEBAR STYLES (Merged from Project 2)
   ========================================= */
        .map-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
        }

        #full-map {
            width: 100%;
            height: 100%;
            z-index: 1;
            outline: none;
            background: #f0f3f8;
        }

        /* Cluster Icons */
        .custom-cluster-icon {
            background: transparent;
        }

        .donut-cluster {
            position: relative;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
        }

        .donut-cluster:hover {
            transform: scale(1.15);
            z-index: 9000;
        }

        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: var(--bg-surface); /* 修复：改为变量 */
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-main); /* 修复：改为变量 */
            line-height: 1;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: background 0.3s, color 0.3s; /* 新增过渡动画 */
        }

        .dc-num {
            font-family: var(--font-sans);
            font-weight: 800;
            font-size: 0.85rem;
        }

        .dc-label {
            font-size: 0.5rem;
            font-weight: 700;
            color: var(--text-muted); /* 修复：改为变量 */
            margin-top: 1px;
        }

        .site-marker-pin {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: var(--bg-surface); /* 修复：改为变量 */
            border: 4px solid var(--border-light); /* 修复：边框颜色也适配暗色 */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.75rem;
            color: var(--text-main); /* 修复：改为变量 */
            transition: transform 0.2s, background 0.3s, border-color 0.3s;
        }

        .site-marker-pin:hover {
            transform: scale(1.2);
        }

        /* Filter Drawer */
        .filter-trigger-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1001;
            width: 44px;
            height: 44px;
            background: var(--bg-surface);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--brand);
            border: 1px solid transparent;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .filter-trigger-btn:hover {
            transform: scale(1.05);
            color: var(--brand-hover);
            box-shadow: 0 8px 20px rgba(131, 205, 32, 0.2);
        }

        .filter-trigger-btn.active {
            opacity: 0;
            pointer-events: none;
            transform: translateX(-20px);
        }

        .filter-drawer {
            position: absolute;
            top: 20px;
            bottom: 20px;
            left: 20px;
            width: 280px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            z-index: 1002;
            display: flex;
            flex-direction: column;
            transform: translateX(-150%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            border: var(--card-border);
        }

        .filter-drawer.active {
            transform: translateX(0);
        }

        .fd-header {
            padding: 24px 24px 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            border-bottom: 1px solid var(--border-light);
        }

        .fd-title {
            font-size: 1.1rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-main);
        }

        .fd-close {
            width: 32px;
            height: 32px;
            background: var(--bg-capsule);
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            cursor: pointer;
            transition: 0.2s;
        }

        .fd-close:hover {
            background: var(--brand);
            color: white;
        }

        .fd-content {
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            flex: 1;
        }

        .btn-reset-filters {
            margin-top: 12px;
            width: 100%;
            height: 40px;
            padding: 0;
            border: 1px solid var(--border-light);
            background: transparent;
            border-radius: 50px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: 0.2s;
        }

        .btn-reset-filters:hover {
            border-color: var(--brand);
            background: var(--brand);
            color: white;
            box-shadow: 0 4px 12px rgba(131, 205, 32, 0.3);
        }

        /* Sidebar */
        .sidebar {
            position: absolute;
            top: 20px;
            bottom: 20px;
            right: 20px;
            width: 380px;
            background: var(--bg-surface);
            border-radius: 24px;
            box-shadow: -10px 0 40px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: none;
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .sb-header {
            padding: 20px;
            flex-shrink: 0;
            background: var(--site-color);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            transition: background-color 0.3s;
        }

        .sb-header-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-right: 12px;
        }

        .sb-title {
            font-size: 1.6rem;
            font-weight: 800;
            margin: 0;
            line-height: 1.2;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .sb-meta-row {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
            flex-wrap: wrap;
        }

        .sb-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: var(--font-mono);
            font-size: 0.8rem;
        }

        .sb-meta-divider {
            width: 1px;
            height: 12px;
            background: rgba(255, 255, 255, 0.4);
        }

        .sb-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            cursor: pointer;
            color: white;
            transition: 0.2s;
            margin-left: 0;
            backdrop-filter: blur(4px);
        }

        .sb-close:hover {
            background: white;
            color: var(--site-color);
            transform: rotate(90deg);
        }

        .sb-content {
            flex: 1;
            overflow: hidden;
            background: var(--bg-surface);
            padding: 24px 24px 0 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 0;
            /* [关键] 允许子元素滚动 */
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            border-bottom: 1px dashed var(--border-light);
            flex-shrink: 0;
            /* 防止数据行被压缩 */
        }

        .data-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .data-val {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-main);
            text-align: right;
        }

        .section-title {
            font-size: 0.8rem;
            font-weight: 800;
            color: var(--text-main);
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        /* [修改] 媒体滚动容器：使用 Flex Column 并允许滚动 */
        .media-scroll-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding-right: 4px;
            padding-top: 10px;
            padding-bottom: 20px;
        }

        /* [修改] 侧边栏卡片：防止被压缩 */
        .media-scroll-container .media-item-card {
            flex-shrink: 0;
        }

        .sidebar .media-item-card .media-name {
            font-size: 0.9rem;
        }

        .media-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 12px;
            background: var(--bg-surface);
            border: 1px solid var(--border-light);
            text-decoration: none;
            transition: all 0.2s;
        }

        .media-item:hover {
            border-color: var(--site-color);
            background: var(--bg-surface-hover);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .media-item:hover .media-icon {
            background: var(--site-color);
            color: white;
            border-color: var(--site-color);
        }

        .media-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--bg-surface-secondary);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
            transition: 0.2s;
            border: 1px solid var(--border-light);
        }

        .media-meta {
            flex: 1;
            min-width: 0;
        }

        .media-dur {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: var(--font-sans);
        }

        .opt-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        /* --- DATA TAB STYLES --- */
        .data-layout-wrapper {
            display: flex;
            height: 100%;
            width: 100%;
            gap: 24px;
        }

        .data-sidebar {
            width: 240px;
            flex-shrink: 0;
            background: var(--glass-bg);
            border: var(--card-border);
            border-radius: var(--radius);
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .data-sidebar-header {
            padding: 20px;
            font-size: 1rem;
            font-weight: 800;
            color: var(--text-main);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .data-table-list {
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .dt-item {
            padding: 10px 14px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: 0.2s;
        }

        .dt-item:hover {
            background: var(--bg-surface-secondary);
            color: var(--brand);
        }

        .dt-item.active {
            background: var(--brand);
            color: white;
            box-shadow: 0 4px 12px rgba(131, 205, 32, 0.3);
        }

        .dt-count {
            font-size: 0.75rem;
            opacity: 0.7;
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 10px;
        }

        .data-main-content {
            flex: 1;
            min-width: 0;
            background: var(--glass-bg);
            border: var(--card-border);
            border-radius: var(--radius);
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .data-toolbar {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-header-tint);
        }

        .data-table-container {
            flex: 1;
            overflow: auto;
            position: relative;
        }

        .crud-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .crud-table th {
            text-align: left;
            padding: 14px 20px;
            background: var(--bg-surface-secondary);
            color: var(--text-muted);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 1px solid var(--border-color);
        }

        .crud-table td {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-main);
            white-space: nowrap;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .crud-table tr:hover {
            background: var(--bg-surface-hover);
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-true {
            background: #dcfce7;
            color: #166534;
        }

        .status-false {
            background: #fee2e2;
            color: #991b1b;
        }

        [data-theme="dark"] .status-true {
            background: rgba(22, 101, 52, 0.3);
            color: #86efac;
        }

        [data-theme="dark"] .status-false {
            background: rgba(153, 27, 27, 0.3);
            color: #fca5a5;
        }

        .action-btn-group {
            display: flex;
            gap: 8px;
        }

        .action-icon-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .action-icon-btn:hover {
            background: var(--brand);
            color: white;
            border-color: var(--brand);
        }

        .action-icon-btn.delete:hover {
            background: #ef4444;
            border-color: #ef4444;
        }

        /* Modal */
        .crud-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
        }

        .crud-modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .crud-modal {
            background: var(--bg-surface);
            width: 500px;
            max-width: 90%;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            border: var(--card-border);
            transform: translateY(20px);
            transition: 0.3s cubic-bezier(0.19, 1, 0.22, 1);
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-height: 85vh;
        }

        .crud-modal-overlay.active .crud-modal {
            transform: translateY(0);
        }

        .form-grid {
            display: grid;
            gap: 16px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .form-input {
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid var(--border-light);
            background: var(--bg-capsule);
            color: var(--text-main);
            font-family: var(--font-sans);
            outline: none;
        }

        .form-input:focus {
            border-color: var(--brand);
            background: var(--bg-surface);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }

        .btn-primary {
            background: var(--brand);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 10px 24px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
        }

        /* --- 排序与筛选增强样式 --- */
        .crud-table th {
            vertical-align: top;
            padding: 10px 12px;
            background: var(--bg-surface-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .th-header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 700;
        }

        .th-header-content:hover {
            color: var(--brand);
        }

        .th-header-content.active-sort {
            color: var(--brand);
        }

        .th-filter-box {
            width: 100%;
        }

        .th-filter-input {
            width: 100%;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--bg-surface);
            font-size: 0.8rem;
            color: var(--text-main);
            box-sizing: border-box;
            outline: none;
            transition: 0.2s;
        }

        .th-filter-input:focus {
            border-color: var(--brand);
            box-shadow: 0 0 0 2px var(--brand-tint);
        }

        select.th-filter-input {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 24px;
        }
    </style>
</head>

<body>

<nav class="project-nav-bar">
    <div class="nav-left">
        <div class="nav-capsule-box">
            <a href="index.html" class="nav-logo">
                <div class="logo-icon-box"><i data-lucide="activity"></i></div>
                <span>ecoSignal</span>
            </a>
            <div class="nav-divider"></div>
            <div class="breadcrumb-group">
                <div class="crumb-wrapper" id="project-wrap">
                    <button class="crumb-btn" onclick="toggleMenu('project-wrap')">
                        <span id="label-project" class="block-anim">Loading...</span><i data-lucide="chevron-down"
                                                                                        size="14"></i>
                    </button>
                    <div class="crumb-dropdown" id="dropdown-project">
                        <div class="dropdown-search-box">
                            <div class="search-input-wrapper"><i data-lucide="search"
                                                                 class="search-icon-small"></i><input type="text" class="dropdown-input"
                                                                                                      placeholder="Search..." oninput="handleSearchProject(this.value)"
                                                                                                      onclick="event.stopPropagation()"></div>
                        </div>
                        <div id="project-list-container" class="dropdown-list-scroll"></div>
                    </div>
                </div>
                <span class="crumb-separator">/</span>
                <div class="crumb-wrapper" id="collection-wrap">
                    <button class="crumb-btn" onclick="toggleMenu('collection-wrap')">
                        <span id="label-collection" class="block-anim">Loading...</span><i
                            data-lucide="chevron-down" size="14"></i>
                    </button>
                    <div class="crumb-dropdown" id="dropdown-collection">
                        <div class="dropdown-search-box">
                            <div class="search-input-wrapper"><i data-lucide="search"
                                                                 class="search-icon-small"></i><input type="text" class="dropdown-input"
                                                                                                      placeholder="Search..." oninput="handleSearchCollection(this.value)"
                                                                                                      onclick="event.stopPropagation()"></div>
                        </div>
                        <div id="collection-list-container" class="dropdown-list-scroll"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="nav-center">
        <div class="nav-capsule-box">
            <div class="sliding-pill" id="nav-sliding-pill"></div>
            <button class="nav-item active" onclick="switchTab(this, 'desc')">Description</button>
            <button class="nav-item" onclick="switchTab(this, 'summary')">Summary</button>
            <button class="nav-item" onclick="switchTab(this, 'media')">Media</button>
            <button class="nav-item" onclick="switchTab(this, 'map')">Map</button>
            <button class="nav-item" onclick="switchTab(this, 'timeline')">Timeline</button>
            <button class="nav-item" onclick="switchTab(this, 'data')">Data</button>
        </div>
    </div>
    <div class="nav-right">
        <div class="nav-capsule-box">
            <button class="nav-btn-simple" onclick="toggleTheme()" title="Switch Theme">
                <i data-lucide="moon" id="theme-icon-el" size="20"></i>
            </button>
            <div class="nav-divider"></div>

            <button class="nav-btn-simple" title="Information"><i data-lucide="info" size="20"></i></button>
            <div class="nav-divider"></div>
            <div class="user-wrapper" id="user-menu">
                <div class="user-capsule-btn" onclick="toggleUserMenu()">
                    <div class="user-avatar-icon"><i data-lucide="user" size="16"></i></div>
                    <span class="user-name-text">Liudilong</span>
                    <i data-lucide="chevron-down" class="chevron-icon" size="14"></i>
                </div>
                <div class="dropdown-menu">
                    <a href="#" class="dropdown-item"><i data-lucide="settings" size="18"></i> Settings</a>
                    <div class="dropdown-divider"></div>
                    <a href="index.html" class="dropdown-item danger"><i data-lucide="log-out" size="18"></i>
                        Logout</a>
                </div>
            </div>
        </div>
    </div>
</nav>

<div class="content-wrapper">
    <div id="tab-desc" class="tab-page active">
        <div class="desc-layout" id="desc-layout-container">
            <div id="panel-proj-desc" class="panel-anim">
                <div class="desc-header-section block-anim">
                    <div class="title-row">
                        <h1 class="desc-title-text" id="desc-project-title">Loading...</h1>
                        <a href="#" target="_blank" class="title-link-icon" id="meta-link"
                           title="Visit Project Website"><i data-lucide="link"></i></a>
                    </div>
                    <div class="meta-row">
                        <div class="meta-capsule-box">
                            <div class="meta-item-btn" title="Creator">
                                <div class="meta-item-icon"><i data-lucide="user" size="14"></i></div>
                                <span id="meta-creator-name">...</span>
                            </div>
                            <div class="meta-divider"></div>
                            <div class="meta-item-btn" title="Creation Date">
                                <div class="meta-item-icon"><i data-lucide="calendar" size="14"></i></div>
                                <span id="meta-date">...</span>
                            </div>
                            <div class="meta-divider"></div>
                            <div class="meta-item-btn" title="DOI">
                                <div class="meta-item-icon"><i data-lucide="bookmark" size="14"></i></div>
                                <span id="meta-doi-text">...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="desc-content-area block-anim">
                    <div id="rich-text-container">Loading...</div>
                </div>
            </div>
            <div id="panel-visual" class="panel-anim">
                <div class="desc-image-container">
                    <img src="" alt="Project Visual" class="desc-project-img" id="main-project-image">
                </div>
            </div>
            <div id="panel-col-desc" class="panel-anim"></div>
        </div>
    </div>

    <div id="tab-summary" class="tab-page">
        <div class="summary-layout">
            <div class="summary-stats-container block-anim" id="summary-stats-grid"></div>
            <div class="summary-contributors-card block-anim">
                <div class="card-header">
                    <div class="card-title" id="contrib-title"><i data-lucide="users"></i> Project Contributors
                    </div>
                </div>
                <div class="card-body">
                    <div class="contributors-list" id="summary-contributors-list"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="tab-media" class="tab-page">
        <div class="dashboard-card" style="height: 100%;">
            <div class="card-header media-header">
                <div class="media-title"><i data-lucide="music" size="24"></i> Media <span class="media-count-badge"
                                                                                           id="media-count-badge">Loading...</span></div>
                <div class="media-controls">
                    <div class="media-search-box"><i data-lucide="search" class="media-search-icon"></i><input
                            type="text" class="media-search-input" placeholder="Search media or tags..."
                            oninput="handleSearchMedia(this.value)"></div>
                    <div class="view-switcher-container">
                        <div class="view-pill" id="view-pill"></div>
                        <button class="view-btn active"
                                onclick="switchMediaView('gallery', this)"><i data-lucide="grid" size="14"></i>
                            Gallery
                        </button>
                        <button class="view-btn" onclick="switchMediaView('list', this)"><i
                                data-lucide="list" size="14"></i> List
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body media-scroll-area">
                <div class="media-container view-gallery block-anim" id="media-grid-container"></div>
            </div>
        </div>
    </div>
    <div id="tab-map" class="tab-page">
        <div class="map-wrapper">
            <div id="full-map"></div>
            <button class="filter-trigger-btn" id="filter-btn-main"
                    onclick="openFilterDrawer()"><i data-lucide="sliders-horizontal" size="22"></i></button>
            <div class="filter-drawer" id="filter-drawer">
                <div class="fd-header">
                    <div class="fd-title"><i data-lucide="sliders-horizontal" size="20"
                                             color="var(--brand)"></i><span>Filters</span></div>
                    <button class="fd-close"
                            onclick="closeFilterDrawer()"><i data-lucide="chevrons-left" size="20"></i></button>
                </div>
                <div class="fd-content">
                    <div class="custom-select-wrapper" id="sel-realm">
                        <div class="select-trigger" onclick="toggleSelect('sel-realm')"><span class="trigger-text"
                                                                                              id="text-realm">All Realms</span><i data-lucide="chevron-down" size="16"></i></div>
                        <div class="select-options" id="opt-realm"></div>
                    </div>
                    <div class="custom-select-wrapper" id="sel-biome">
                        <div class="select-trigger disabled" id="trig-biome" onclick="toggleSelect('sel-biome')">
                            <span class="trigger-text" id="text-biome">All Biomes</span><i
                                data-lucide="chevron-down" size="16"></i>
                        </div>
                        <div class="select-options" id="opt-biome"></div>
                    </div>
                    <div class="custom-select-wrapper" id="sel-group">
                        <div class="select-trigger disabled" id="trig-group" onclick="toggleSelect('sel-group')">
                            <span class="trigger-text" id="text-group">All Groups</span><i
                                data-lucide="chevron-down" size="16"></i>
                        </div>
                        <div class="select-options" id="opt-group"></div>
                    </div>
                    <button class="btn-reset-filters" onclick="resetFilters()"><i data-lucide="rotate-ccw"
                                                                                  size="16"></i> Reset Filters
                    </button>
                </div>
            </div>
            <div id="sidebar" class="sidebar">
                <div class="sb-header" id="sb-header-bg">
                    <div class="sb-header-content">
                        <h2 class="sb-title" id="sb-name">Site Name</h2>
                        <div class="sb-meta-row" id="sb-meta-container"></div>
                    </div>
                    <button class="sb-close" onclick="closeSidebar()"><i data-lucide="x" size="18"></i></button>
                </div>
                <div class="sb-content">
                    <div class="data-row"><span class="data-label">Realm</span><span class="data-val"
                                                                                     id="val-realm">--</span></div>
                    <div class="data-row"><span class="data-label">Biome</span><span class="data-val"
                                                                                     id="val-biome">--</span></div>
                    <div class="data-row" style="border-bottom:none;"><span class="data-label">Group</span><span
                            class="data-val" id="val-group">--</span></div>

                    <div class="section-title"><i data-lucide="play-circle" size="16"></i> Media</div>
                    <div class="media-scroll-container" id="media-container"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-timeline" class="tab-page">
        <div class="dashboard-card" style="height: 100%;">
            <div class="card-header media-header timeline-header-styled" style="z-index: 100;">
                <div class="media-title">
                    <i data-lucide="kanban" size="24"></i> Timeline
                    <span class="media-count-badge" id="tl-count-badge">Loading...</span>
                </div>

                <div class="media-controls" style="gap: 12px;">
                    <div class="custom-select-wrapper" id="tl-sel-group" style="width: 200px;">
                        <div class="select-trigger" onclick="toggleSelect('tl-sel-group')">
                            <span class="trigger-text" id="tl-text-group">Realm</span>
                            <i data-lucide="chevron-down" size="16"></i>
                        </div>
                        <div class="select-options">
                            <div class="select-option" onclick="setTimelineGrouping('all')">All Data</div>
                            <div style="height:1px; background:var(--border-color); margin:4px 0;"></div>
                            <div class="select-option" onclick="setTimelineGrouping('realm')">Realm</div>
                            <div class="select-option" onclick="setTimelineGrouping('biome')">Biome</div>
                            <div class="select-option" onclick="setTimelineGrouping('group')">Group</div>
                            <div class="select-option" onclick="setTimelineGrouping('site')">Site</div>
                        </div>
                    </div>

                    <div class="custom-select-wrapper" id="tl-sel-time" style="width: 200px;">
                        <div class="select-trigger" onclick="toggleSelect('tl-sel-time')">
                            <span class="trigger-text" id="tl-text-time">Year</span>
                            <i data-lucide="chevron-down" size="16"></i>
                        </div>
                        <div class="select-options">
                            <div class="select-option" onclick="setTimelineResolution('all')">All Time</div>
                            <div style="height:1px; background:var(--border-color); margin:4px 0;"></div>
                            <div
                                    style="padding:4px 8px; font-size:0.7rem; color:var(--text-muted); font-weight:700;">
                                ABSOLUTE TIME
                            </div>
                            <div class="select-option" onclick="setTimelineResolution('y')">Year</div>
                            <div class="select-option" onclick="setTimelineResolution('yq')">Year / Quarter</div>
                            <div class="select-option" onclick="setTimelineResolution('ym')">Year / Month</div>
                            <div class="select-option" onclick="setTimelineResolution('ymd')">Year / Month / Day
                            </div>
                            <div style="height:1px; background:var(--border-color); margin:4px 0;"></div>
                            <div
                                    style="padding:4px 8px; font-size:0.7rem; color:var(--text-muted); font-weight:700;">
                                SEASONAL CYCLES
                            </div>
                            <div class="select-option" onclick="setTimelineResolution('q')">Quarter</div>
                            <div class="select-option" onclick="setTimelineResolution('m')">Month</div>
                            <div class="select-option" onclick="setTimelineResolution('md')">Month / Day</div>
                            <div class="select-option" onclick="setTimelineResolution('d')">Day</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-body" style="padding:0; overflow:hidden; display:flex; flex-direction:column;">
                <div class="timeline-matrix-viewport" id="tl-matrix-container">
                    <div style="margin: auto; color: var(--text-muted);">Loading Matrix...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-data" class="tab-page">
        <div class="data-layout-wrapper">
            <div class="data-sidebar">
                <div class="data-sidebar-header">
                    <i data-lucide="database" size="18" style="color:var(--brand);"></i> Tables
                </div>
                <div class="data-table-list" id="table-nav-list">
                </div>
            </div>

            <div class="data-main-content">
                <div class="data-toolbar">
                    <div class="card-title" id="current-table-title"><i data-lucide="table"></i> Project</div>
                    <div class="media-controls">
                        <div class="media-search-box">
                            <i data-lucide="search" class="media-search-icon"></i>
                            <input type="text" class="media-search-input" id="data-search-input" placeholder="Search records..." oninput="handleDataSearch(this.value)">
                        </div>
                        <button class="nav-btn-simple" onclick="refreshTable()" title="Refresh"><i data-lucide="rotate-ccw" size="18"></i></button>
                        <button class="btn-primary" onclick="openCrudModal('add')" style="display:flex; align-items:center; gap:6px; font-size:0.9rem;">
                            <i data-lucide="plus" size="16"></i> Add Record
                        </button>
                    </div>
                </div>
                <div class="data-table-container">
                    <table class="crud-table">
                        <thead id="crud-thead">
                        </thead>
                        <tbody id="crud-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="crud-modal-overlay" id="crud-modal-overlay">
        <div class="crud-modal">
            <div class="card-title" id="modal-title">Edit Record</div>
            <div class="form-grid" id="modal-form-container">
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeCrudModal()">Cancel</button>
                <button class="btn-primary" onclick="saveCrudData()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
    lucide.createIcons();

    // --- [新增] 富文本内容生成器 ---
    const generateRichText = (type, title, location, latinName) => {
        if (type === 'modern') {
            return `
                    <div class="style-modern">
                        <span class="tag-label" style="display:inline-block;padding:4px 8px;background:var(--brand);color:white;border-radius:4px;font-size:0.7rem;font-weight:700;margin-bottom:10px;text-transform:uppercase;">Live Monitoring</span>
                        <h1>${title} Digital Overview</h1>
                        <p style="font-size:1.1rem;color:var(--text-secondary);">Deploying next-generation <strong>edge-computing nodes</strong> in ${location} to capture high-fidelity acoustic data.</p>
                        
                        <div class="data-grid">
                            <div class="data-item"><span class="data-val">98.5%</span><span class="data-key">Uptime</span></div>
                            <div class="data-item"><span class="data-val">24/7</span><span class="data-key">Streaming</span></div>
                            <div class="data-item"><span class="data-val">AI</span><span class="data-key">Detection</span></div>
                        </div>

                        <h3>System Architecture</h3>
                        <ul>
                            <li><strong>Edge Nodes:</strong> Solar-powered Raspberry Pi units with AudioMoth sensors.</li>
                            <li><strong>Connectivity:</strong> LoRaWAN mesh network for real-time metadata transmission.</li>
                            <li><strong>Cloud Sync:</strong> Daily batch uploads via Starlink satellite link.</li>
                        </ul>
                    </div>
                `;
        } else if (type === 'academic') {
            return `
                    <div class="style-modern">
                        <div style="background:var(--bg-surface-secondary);padding:20px;border-left:4px solid var(--text-main);margin-bottom:24px;">
                            <h4 style="margin:0 0 8px 0;font-size:0.9rem;text-transform:uppercase;color:var(--text-muted);">Abstract</h4>
                            <p style="margin:0;font-style:italic;">This study investigates the acoustic signature of <em>${latinName}</em> within the ${location} ecosystem, focusing on temporal variations in vocalization intensity.</p>
                        </div>
                        
                        <h2>1. Introduction</h2>
                        <p>Passive Acoustic Monitoring (PAM) has emerged as a non-invasive method for assessing biodiversity.</p>
                        
                        <h2>2. Methodology</h2>
                        <p>We deployed <strong>50 autonomous recording units (ARUs)</strong> across a stratified random grid.</p>
                        <ul>
                            <li>Sampling Rate: 48 kHz</li>
                            <li>Duty Cycle: 10 mins / hour</li>
                            <li>Duration: 6 months</li>
                        </ul>

                        <blockquote>"The results suggest a significant correlation between rainfall patterns and biological acoustic activity."</blockquote>
                    </div>
                `;
        } else { // Editorial / Blog
            return `
                    <div class="style-modern">
                        <p style="font-family:serif;font-size:1.2rem;line-height:1.8;color:var(--text-main);">
                            The jungle was alive. Not with the roar of engines, but with the <strong>symphony of life</strong>.
                        </p>
                        <p>Our team trekked for three days into the heart of ${location}. The humidity was oppressive, but the soundscape was mesmerizing.</p>
                        
                        <div style="margin:24px 0;border-radius:12px;overflow:hidden;border:1px solid var(--border-color);">
                            <img src="https://images.unsplash.com/photo-1542273917363-3b1817f69a2d?auto=format&fit=crop&w=800&q=80" style="width:100%;height:200px;object-fit:cover;display:block;">
                            <div style="padding:12px;background:var(--bg-surface-secondary);font-size:0.8rem;color:var(--text-muted);">Figure 1: Field deployment site at sunrise.</div>
                        </div>

                        <h3>Field Notes: Day 3</h3>
                        <p>We encountered a rare species of <em>${latinName}</em> near the riverbank. The recordings captured here are pristine.</p>
                        <ul>
                            <li>Equipment: Sony PCM-D10</li>
                            <li>Conditions: Light rain</li>
                            <li>Team: K. Mbeki, J. Doe</li>
                        </ul>
                    </div>
                `;
        }
    };

    const colGenerators = [
        (n) => `<div class="col-rt-modern"><h3><i data-lucide="activity"></i> Spectral Analysis</h3><p>${n} exhibits high-frequency harmonics typical of neotropical avian species. The spectrogram reveals distinct banding patterns.</p><ul><li>Bandwidth: 2kHz - 8kHz</li><li>Duration: 1.5s pulses</li></ul></div>`,
        (n) => `<div class="col-rt-modern"><h3><i data-lucide="clock"></i> Temporal Patterns</h3><p>${n} activity peaks during the dawn chorus (05:00 - 06:30) with a secondary, lower intensity peak at dusk.</p></div>`,
        (n) => `<div class="col-rt-modern"><h3><i data-lucide="map-pin"></i> Spatial Distribution</h3><p>Recorded primarily in the riparian zones of the transect. ${n} density decreases significantly >500m from water sources.</p></div>`
    ];

    const projectImages = [
        'https://ecosound-web.de/ecosound_web/sounds/projects/108.jpeg', 'https://ecosound-web.de/ecosound_web/sounds/projects/117.jpeg',
        'https://ecosound-web.de/ecosound_web/sounds/projects/121.jpeg', 'https://ecosound-web.de/ecosound_web/sounds/projects/105.jpeg',
        'https://ecosound-web.de/ecosound_web/sounds/projects/114.jpeg', 'https://ecosound-web.de/ecosound_web/sounds/projects/123.jpeg'
    ];
    const getImg = (idx) => projectImages[idx % projectImages.length];
    const rInt = (min, max) => Math.floor(Math.random() * (max - min + 1) + min);

    // --- 贡献者生成逻辑 (Mock Data) ---
    const mockNames = ["A. Schmidt", "B. Cohen", "C. Kim", "D. Mwangi", "E. Rossi", "F. Yamamoto", "G. Dubois", "H. Petrov", "I. Al-Fayed", "J. Smith", "K. Gupta", "L. Wei"];
    // 项目角色池
    const projRoles = ["Principal Investigator", "Lead Researcher", "Field Technician", "Data Analyst", "Project Manager", "Ecologist"];
    // 集合角色池
    const colRoles = ["Field Recorder", "Annotator", "Reviewer", "Data Curator", "Metadata Specialist", "Logistics"];

    // [修改] getContributors 接受一个可选的 leadName
    const getContributors = (count, type, leadName = null) => {
        const list = [];
        const rolePool = type === 'project' ? projRoles : colRoles;

        for (let i = 0; i < count; i++) {
            let name, role;

            // 第一位如果是 leadName，则使用该名字和最高级别角色
            if (i === 0 && leadName) {
                name = leadName;
                role = rolePool[0]; // PI or Field Recorder
            } else {
                // 其他随机
                name = mockNames[Math.floor(Math.random() * mockNames.length)];
                role = rolePool[Math.floor(Math.random() * (rolePool.length - 1)) + 1];
            }

            list.push({
                name: name,
                role: role,
                email: name.toLowerCase().replace('. ', '.').replace(' ', '.') + "@lab.edu",
                uid: `0000-000${Math.floor(Math.random() * 9)}-${Math.floor(Math.random() * 9999)}-${Math.floor(Math.random() * 9999)}`
            });
        }
        return list;
    };

    const createCollections = (baseName, count, startImgIdx, creatorName) => {
        return Array.from({length: count}, (_, i) => {
            const collectionCreator = `Researcher ${String.fromCharCode(65 + (i % 26))}`; // 生成集合特定的创建者
            return {
                id: `c${i}`,
                name: `${baseName} - Phase ${String.fromCharCode(65 + i)}`,
                active: false,
                creator: collectionCreator, // 绑定到 metadata
                date: `2025-0${(i % 9) + 1}-15`,
                doi: `10.ECO/col.${i + 1}`,
                sphere: ["Atmosphere", "Biosphere", "Hydrosphere"][i % 3],
                external_media_url: "#",
                project_url: "#",
                description: colGenerators[i % 3](`${baseName}`),
                image: getImg(startImgIdx + i + 1),
                stats: {users: rInt(2, 10), projects: 1, audio: rInt(100, 5000), photos: rInt(10, 200), videos: rInt(0, 50), metadata: rInt(1000, 10000), tags: rInt(50, 300), sites: rInt(1, 5)},
                // [修改] 传递集合创建者给生成函数
                contributors: getContributors(rInt(3, 5), 'collection', collectionCreator)
            };
        });
    };

    const initialProjects = [
        {
            id: "p1", name: "Amazon Rainforest Survey", creator: "Dr. Silva", date: "2025-01-10", doi: "10.1234/amz.01", externalUrl: "#",
            description: generateRichText('modern', "Amazon Basin", "Manaus", "Panthera onca"),
            styleClass: "style-modern", image: getImg(0),
            collections: createCollections("Canopy Audio", 8, 0, "Dr. Silva"),
            stats: {users: 45, collections: 8, audio: "120k", photos: 850, videos: 120, metadata: "1.2M", tags: 4500, sites: 12},
            // [修改] 使用 Dr. Silva 作为项目 PI
            contributors: getContributors(4, 'project', "Dr. Silva")
        },
        {
            id: "p2", name: "Marine Ecosystems Study", creator: "Prof. Ocean", date: "2024-11-05", doi: "10.5678/mar.02", externalUrl: "#",
            description: generateRichText('academic', "Coral Reefs", "Great Barrier Reef", "Megaptera novaeangliae"),
            styleClass: "style-academic", image: getImg(1),
            collections: createCollections("Hydrophone Data", 6, 5, "Prof. Ocean"),
            stats: {users: 32, collections: 6, audio: "80k", photos: 200, videos: 500, metadata: "800k", tags: 2100, sites: 5},
            // [修改] 使用 Prof. Ocean 作为 PI
            contributors: getContributors(3, 'project', "Prof. Ocean")
        },
        {
            id: "p3", name: "African Savanna Project", creator: "K. Mbeki", date: "2025-02-15", doi: "10.9999/sav.03", externalUrl: "#",
            description: generateRichText('blog', "Serengeti", "Tanzania", "Loxodonta africana"),
            styleClass: "style-editorial", image: getImg(2),
            collections: createCollections("Seismic", 5, 2, "K. Mbeki"),
            stats: {users: 28, collections: 5, audio: "45k", photos: 1200, videos: 50, metadata: "500k", tags: 1200, sites: 8},
            // [修改] 使用 K. Mbeki 作为 PI
            contributors: getContributors(5, 'project', "K. Mbeki")
        }
    ];
    const rawProjects = [...initialProjects];

    let currProjIdx = 0;
    let currColIdx = 0;
    let projSearchQuery = "";
    let colSearchQuery = "";

    // --- MAP VARIABLES & LOGIC (省略部分未变代码以节省空间) ---
    let map = null;
    let clusterGroup = null;
    let polyLayer = null;
    let currentSites = [];
    let currentSelectedSiteId = null;
    let filterState = {realm: "", biome: "", group: ""};
    const REALM_COLORS = {"Terrestrial": "#65a30d", "Marine": "#0284c7", "Freshwater": "#0891b2", "Subterranean": "#71717a", "Atmospheric": "#f59e0b", "Estuarine": "#14b8a6", "Cryogenic": "#a8a29e", "Artificial": "#db2777", "Introduced": "#9333ea", "Unknown": "#f97316"};
    const TAXONOMY = {
        "Terrestrial": {"Tropical Forests": ["Lowland Rainforest", "Montane Rainforest"], "Savannas": ["Shrubland", "Grassland"]},
        "Marine": {"Coastal": ["Coral Reefs", "Seagrass"], "Pelagic": ["Epipelagic", "Mesopelagic"]},
        "Freshwater": {"Riverine": ["Permanent Rivers", "Seasonal Streams"], "Palustrine": ["Peatlands", "Marshes"]},
        "Subterranean": {"Cave Systems": ["Limestone Caves", "Lava Tubes"], "Aquifers": ["Shallow", "Deep"]},
        "Atmospheric": {"Aerial": ["Lower Troposphere", "Upper Canopy"], "Urban Air": ["City Center", "Industrial"]},
        "Estuarine": {"Brackish Water": ["Mangroves", "Salt Marshes"], "Deltas": ["Active Delta", "Inactive Delta"]},
        "Cryogenic": {"Ice Sheets": ["Polar", "Glacial"], "Tundra": ["Permafrost", "Alpine"]},
        "Artificial": {"Urban": ["Parks", "Gardens"], "Agricultural": ["Farms", "Plantations"]},
        "Introduced": {"Invasive Zones": ["Islands", "Mainland"], "Rehabilitation": ["Forest", "Wetland"]},
        "Unknown": {"Unclassified": ["Region A", "Region B"], "Pending": ["Survey 1", "Survey 2"]}
    };

    function getRealmColor(r) {
        return REALM_COLORS[r] || "#0f172a";
    }

    function generateSitesForContext(projId, colId) {
        let seed = projId.charCodeAt(1) + (colId ? colId.charCodeAt(1) * 10 : 0);
        const count = 50 + (seed % 20);
        let baseLat = -3.4, baseLng = -62.2;
        if (projId === "p2") {
            baseLat = -18.2;
            baseLng = 147.7;
        }
        if (projId === "p3") {
            baseLat = -2.3;
            baseLng = 34.8;
        }
        const realmKeys = Object.keys(TAXONOMY);
        return Array.from({length: count}, (_, i) => {
            let rIndex = Math.floor(Math.random() * realmKeys.length);
            if (projId === "p1" && Math.random() > 0.3) rIndex = 0;
            if (projId === "p2" && Math.random() > 0.3) rIndex = 1;
            const r = realmKeys[rIndex];
            const bKeys = Object.keys(TAXONOMY[r]);
            const b = bKeys[Math.floor(Math.random() * bKeys.length)];
            const gKeys = TAXONOMY[r][b];
            const g = gKeys[Math.floor(Math.random() * gKeys.length)];
            const lat = baseLat + (Math.random() - 0.5) * 8;
            const lng = baseLng + (Math.random() - 0.5) * 8;
            const vertices = 3 + Math.floor(Math.random() * 5);
            const baseRadius = 0.03;
            const poly = [];
            const rotation = Math.random() * Math.PI;
            for (let k = 0; k < vertices; k++) {
                const angle = (k / vertices) * Math.PI * 2 + rotation;
                const r = baseRadius * (0.8 + Math.random() * 0.4);
                poly.push([lat + Math.sin(angle) * r, lng + Math.cos(angle) * r]);
            }
            return {
                id: `${projId}-${colId || 'all'}-${i}`,
                name: `Site ${String.fromCharCode(65 + (i % 26))}-${100 + i}`,
                center: [lat, lng],
                polygon: poly,
                realm: r,
                biome: b,
                group: g,
                topography_m: Math.floor(Math.random() * 800),
                freshwater_depth_m: r === 'Freshwater' ? (Math.random() * 15).toFixed(1) : "N/A",
                mediaCount: Math.floor(Math.random() * 10) + 2,
                media: Array.from({length: Math.floor(Math.random() * 10) + 2}, (_, m) => ({name: `${r.slice(0, 3).toUpperCase()}_REC_${202500 + m}.wav`, date: "2025-01-15", duration: "01:00:00"}))
            };
        });
    }

    function loadMapData() {
        // [Fix] 移除了 if (!map) return; 以便在地图显示前也能生成 Site 数据供 Media 使用
        const projId = rawProjects[currProjIdx].id;
        const colId = currColIdx > 0 ? rawProjects[currProjIdx].collections[currColIdx - 1].id : null;

        if (!colId) {
            currentSites = [];
            rawProjects[currProjIdx].collections.forEach(c => {
                currentSites = [...currentSites, ...generateSitesForContext(projId, c.id)];
            });
        } else {
            currentSites = generateSitesForContext(projId, colId);
        }

        // 只有当过滤器 UI 存在时才重置过滤器 (通常一直存在)
        resetFilters();
    }

    function initMap() {
        if (map) return;
        map = L.map('full-map', {zoomControl: false}).setView([-3.465, -62.215], 6);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
        L.control.zoom({position: 'bottomright'}).addTo(map);
        polyLayer = L.layerGroup().addTo(map);
        clusterGroup = L.markerClusterGroup({
            showCoverageOnHover: false, zoomToBoundsOnClick: true, spiderfyOnMaxZoom: true, maxClusterRadius: 60, iconCreateFunction: function (cluster) {
                const markers = cluster.getAllChildMarkers();
                const n = markers.length;
                const realmCounts = {};
                let totalMedia = 0;
                markers.forEach(m => {
                    const r = m.options.customData.realm;
                    realmCounts[r] = (realmCounts[r] || 0) + 1;
                    totalMedia += m.options.customData.mediaCount;
                });
                let gradientParts = [];
                let currentPercentage = 0;
                Object.keys(realmCounts).sort((a, b) => realmCounts[b] - realmCounts[a]).forEach(r => {
                    const pct = (realmCounts[r] / n) * 100;
                    gradientParts.push(`${getRealmColor(r)} ${currentPercentage}% ${currentPercentage + pct}%`);
                    currentPercentage += pct;
                });
                return L.divIcon({
                    html: `<div class="donut-cluster" style="background: conic-gradient(${gradientParts.join(', ')});"><div class="donut-center"><span class="dc-num">${totalMedia}</span><span class="dc-label">MEDIA</span></div></div>`,
                    className: 'custom-cluster-icon',
                    iconSize: L.point(50, 50),
                    iconAnchor: [25, 25]
                });
            }
        });
        map.addLayer(clusterGroup);
        loadMapData();
    }

    function renderMap(shouldZoom = false) {
        if (!map) return;
        polyLayer.clearLayers();
        clusterGroup.clearLayers();
        let visibleBounds = L.latLngBounds([]);
        let visibleCount = 0;
        let isCurrentSiteVisible = false;
        currentSites.forEach(site => {
            if (filterState.realm && site.realm !== filterState.realm) return;
            if (filterState.biome && site.biome !== filterState.biome) return;
            if (filterState.group && site.group !== filterState.group) return;
            if (currentSelectedSiteId && site.id === currentSelectedSiteId) isCurrentSiteVisible = true;
            visibleCount++;
            const siteColor = getRealmColor(site.realm);
            const poly = L.polygon(site.polygon, {color: siteColor, weight: 2, opacity: 0.8, fillColor: siteColor, fillOpacity: 0.15}).addTo(polyLayer);
            poly.on('click', (e) => {
                L.DomEvent.stopPropagation(e);
                openSidebar(site);
            });
            const marker = L.marker(site.center, {
                customData: {realm: site.realm, mediaCount: site.mediaCount},
                icon: L.divIcon({html: `<div class="site-marker-pin" style="border-color:${siteColor}; color:${siteColor}">${site.mediaCount}</div>`, className: 'custom-cluster-icon', iconSize: [28, 28]})
            });
            marker.on('click', () => openSidebar(site));
            clusterGroup.addLayer(marker);
            visibleBounds.extend(site.center);
        });
        if (currentSelectedSiteId && !isCurrentSiteVisible) closeSidebar();
        if ((shouldZoom || visibleCount > 0) && visibleCount > 0) {
            if (visibleCount === 1) map.flyTo(visibleBounds.getCenter(), 14, {duration: 0.8, easeLinearity: 0.5}); else map.fitBounds(visibleBounds, {padding: [50, 50], maxZoom: 15, duration: 0.8, easeLinearity: 0.5});
        }
    }

    function openSidebar(site) {
        currentSelectedSiteId = site.id;
        const color = getRealmColor(site.realm);
        document.documentElement.style.setProperty('--site-color', color);
        document.documentElement.style.setProperty('--site-color-tint', color + '12');

        // 1. 填充文本信息
        document.getElementById('sb-name').textContent = site.name;
        document.getElementById('val-realm').textContent = site.realm;
        document.getElementById('val-realm').style.color = color;
        document.getElementById('val-biome').textContent = site.biome;
        document.getElementById('val-group').textContent = site.group;

        // 2. 渲染头部元数据 (Topography / Water Depth)
        const topoHtml = `<div class="sb-meta-item" title="Topography"><i data-lucide="mountain" size="14"></i> ${site.topography_m}m</div>`;
        const depthHtml = site.freshwater_depth_m !== "N/A"
            ? `<div class="sb-meta-divider"></div><div class="sb-meta-item" title="Water Depth"><i data-lucide="waves" size="14"></i> ${site.freshwater_depth_m}m</div>`
            : '';

        // 确保容器存在后再写入
        const metaContainer = document.getElementById('sb-meta-container');
        if (metaContainer) metaContainer.innerHTML = topoHtml + depthHtml;

        // 3. 渲染 Media (Gallery 样式卡片 - 保持与 Media 页面完全一致的结构)
        const mockSpectrogram = "https://ecosound-web.de/ecosound_web/sounds/images/51/27/6533-player_s.png";

        const mediaHtml = site.media.map((m) => {
            // 为了保持视觉一致性，这里模拟一些标签和数据
            const mockTagsHtml = `<span class="media-tag">Bio</span><span class="media-tag">Aves</span>`;
            const mockTime = "14:30:00";
            const mockSize = "2.4 MB";

            return `
                <div class="media-item-card" onclick="event.stopPropagation();">
                    <div class="spectrogram-cover">
                        <img src="${mockSpectrogram}" class="spectrogram-img" alt="Spec">
                        <div class="play-overlay"><div class="play-circle"><i data-lucide="play" fill="currentColor"></i></div></div>
                        <div class="duration-badge">${m.duration}</div>
                    </div>
                    <div class="media-card-info">
                        <a href="#" class="media-name" title="${m.name}" onclick="return false;">${m.name}</a>
                        
                        <div class="tags-row">${mockTagsHtml}</div>
                        
                        <div class="media-meta-row">
                            <div class="meta-icon-text"><i data-lucide="calendar" size="14"></i> ${m.date}</div>
                            <div class="meta-icon-text"><i data-lucide="clock" size="14"></i> ${mockTime}</div>
                            <div class="meta-icon-text"><i data-lucide="hard-drive" size="14"></i> ${mockSize}</div>
                        </div>
                    </div>
                </div>`;
        }).join('');

        // [修改] 获取容器并重置滚动条位置
        const mediaListContainer = document.getElementById('media-container');
        mediaListContainer.innerHTML = mediaHtml;
        mediaListContainer.scrollTop = 0;

        lucide.createIcons();
        document.getElementById('sidebar').classList.add('active');
        map.flyTo(site.center, 14, {duration: 0.8, easeLinearity: 0.5});
    }

    function closeSidebar() {
        currentSelectedSiteId = null;
        document.getElementById('sidebar').classList.remove('active');
    }

    function openFilterDrawer() {
        document.getElementById('filter-drawer').classList.add('active');
        document.getElementById('filter-btn-main').classList.add('active');
    }

    function closeFilterDrawer() {
        document.getElementById('filter-drawer').classList.remove('active');
        document.getElementById('filter-btn-main').classList.remove('active');
    }

    function toggleSelect(id) {
        const el = document.getElementById(id);
        if (el.querySelector('.select-trigger').classList.contains('disabled')) return;
        const isOpen = el.classList.contains('open');
        closeSelects();
        if (!isOpen) el.classList.add('open');
    }

    function closeSelects() {
        document.querySelectorAll('.custom-select-wrapper').forEach(d => d.classList.remove('open'));
    }

    function getUniqueValues(data, key) {
        const set = new Set();
        data.forEach(s => {
            if (s[key]) set.add(s[key]);
        });
        return Array.from(set).sort();
    }

    function initFilters() {
        renderSelectOptions('realm');
        updateSelectOptions('biome');
        updateSelectOptions('group');
    }

    function renderSelectOptions(targetType) {
        const list = document.getElementById('opt-' + targetType);
        const options = getUniqueValues(currentSites, 'realm');
        let html = `<div class="select-option" onclick="applyFilter('${targetType}', '')"><div class="opt-dot" style="background:#ccc"></div>All Realms</div>`;
        options.forEach(opt => html += `<div class="select-option" onclick="applyFilter('${targetType}', '${opt}')"><div class="opt-dot" style="background:${getRealmColor(opt)}"></div>${opt}</div>`);
        list.innerHTML = html;
    }

    function applyFilter(type, value) {
        closeSidebar();
        if (type === 'realm') {
            filterState.realm = value;
            filterState.biome = "";
            filterState.group = "";
            updateSelectUI('realm', value);
            updateSelectOptions('biome');
            updateSelectUI('biome', '');
            updateSelectOptions('group');
            updateSelectUI('group', '');
        } else if (type === 'biome') {
            filterState.biome = value;
            filterState.group = "";
            updateSelectUI('biome', value);
            updateSelectOptions('group');
            updateSelectUI('group', '');
        } else if (type === 'group') {
            filterState.group = value;
            updateSelectUI('group', value);
        }
        closeSelects();
        renderMap(true);
    }

    function updateSelectUI(type, value) {
        const textEl = document.getElementById('text-' + type);
        const trigger = type === 'realm' ? document.getElementById('sel-realm').querySelector('.select-trigger') : document.getElementById('trig-' + type);
        const labelMap = {realm: "All Realms", biome: "All Biomes", group: "All Groups"};

        if (!value) {
            textEl.innerHTML = labelMap[type]; // 使用 innerHTML 以防万一
            trigger.classList.remove('active');
        } else {
            if (type === 'realm') {
                // 获取对应颜色并添加圆点
                const color = getRealmColor(value);
                textEl.innerHTML = `<span class="opt-dot" style="background:${color}; display:inline-block; margin-right:8px;"></span>${value}`;
            } else {
                textEl.innerText = value;
            }
            trigger.classList.add('active');
        }
    }

    function updateSelectOptions(targetType) {
        const list = document.getElementById('opt-' + targetType);
        const trigger = document.getElementById('trig-' + targetType);
        let filteredData = currentSites;
        if (targetType === 'biome') {
            if (!filterState.realm) {
                trigger.classList.add('disabled');
                return;
            }
            filteredData = currentSites.filter(s => s.realm === filterState.realm);
        } else if (targetType === 'group') {
            if (!filterState.biome) {
                trigger.classList.add('disabled');
                return;
            }
            filteredData = currentSites.filter(s => s.realm === filterState.realm && s.biome === filterState.biome);
        }
        trigger.classList.remove('disabled');
        const options = getUniqueValues(filteredData, targetType);
        const labelMap = {biome: "All Biomes", group: "All Groups"};
        let html = `<div class="select-option" onclick="applyFilter('${targetType}', '')">${labelMap[targetType]}</div>`;
        if (options.length === 0) html = `<div style="padding:10px;color:#999;font-size:0.85rem">No options</div>`; else options.forEach(opt => html += `<div class="select-option" onclick="applyFilter('${targetType}', '${opt}')">${opt}</div>`);
        list.innerHTML = html;
    }

    function resetFilters() {
        closeSidebar();
        filterState = {realm: "", biome: "", group: ""};
        updateSelectUI('realm', '');
        initFilters();
        renderMap(true);
    }

    // --- MEDIA PAGE LOGIC (DYNAMIC) ---
    let mediaItems = [];
    let mediaSearchQuery = "";
    const taxonTags = ["Aves", "Insecta", "Chiroptera", "Anura", "Anthrophony", "Geophony"];
    const getRandomTags = () => {
        const count = rInt(1, 3);
        const shuffled = taxonTags.sort(() => 0.5 - Math.random());
        return shuffled.slice(0, count);
    };

    // [修改] 年份随机化 (2021 - 2025)
    const generateMediaForContext = (proj, col) => {
        const prefix = col ? `COL_${col.id}` : `PROJ_${proj.id}`;
        const count = col ? rInt(8, 15) : rInt(24, 40);
        return Array.from({length: count}, (_, i) => {
            const h = Math.floor(Math.random() * 24).toString().padStart(2, '0');
            const m = Math.floor(Math.random() * 60).toString().padStart(2, '0');
            const s = Math.floor(Math.random() * 60).toString().padStart(2, '0');
            const year = 2021 + Math.floor(Math.random() * 5); // 2021-2025
            const month = Math.floor(Math.random() * 12) + 1;
            const day = Math.floor(Math.random() * 28) + 1;
            const fullDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

            return {
                id: i,
                name: `${prefix}_REC_${20250000 + i}.wav`,
                date: fullDate,
                time: `${h}:${m}:${s}`,
                fullDate: `${fullDate} ${h}:${m}`,
                duration: `00:${rInt(10, 59)}`,
                tags: getRandomTags(),
                size: `${(Math.random() * 5 + 0.5).toFixed(1)} MB`,
                sr: "48kHz",
                spectrogram: "https://ecosound-web.de/ecosound_web/sounds/images/51/27/6533-player_s.png",
                creator: ["Dr. Silva", "M. Lewis", "Field Team A", "Auto-Recorder"][rInt(0, 3)],
                site: `Site-${rInt(1, 12).toString().padStart(2, '0')}`,
                sensor: ["AudioMoth v1.2", "Song Meter Micro", "Zoom F3 + Clippy", "Sony PCM-D10"][rInt(0, 3)],
                license: ["CC BY 4.0", "CC BY-NC", "CC0"][rInt(0, 2)]
            };
        });
    };

    function updateMediaContext() {
        const proj = rawProjects[currProjIdx];
        const col = currColIdx > 0 ? proj.collections[currColIdx - 1] : null;
        mediaItems = generateMediaForContext(proj, col);
        mediaSearchQuery = "";
        const searchInput = document.querySelector('.media-search-input');
        if (searchInput) searchInput.value = "";

        // [新增] 切换上下文时，强制滚动区域回到顶部
        const scrollArea = document.querySelector('.media-scroll-area');
        if (scrollArea) scrollArea.scrollTop = 0;

        const container = document.getElementById('media-grid-container');
        animateBlockSwap(container, () => {
            renderMedia();
        });
    }

    function handleSearchMedia(val) {
        mediaSearchQuery = val.toLowerCase();
        renderMedia();
    }

    function renderMedia() {
        // [新增] 渲染前确保数据字段完整
        enrichMediaData();

        const container = document.getElementById('media-grid-container');
        const badge = document.getElementById('media-count-badge');
        const isGallery = container.classList.contains('view-gallery');
        const filteredItems = mediaItems.filter(item => item.name.toLowerCase().includes(mediaSearchQuery) || item.tags.some(t => t.toLowerCase().includes(mediaSearchQuery)) || item.site.toLowerCase().includes(mediaSearchQuery) || item.sensor.toLowerCase().includes(mediaSearchQuery));
        badge.textContent = `${filteredItems.length} Items`;

        if (filteredItems.length === 0) {
            container.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:60px; color:var(--text-muted); display:flex; flex-direction:column; align-items:center; gap:10px;"><i data-lucide="filter" size="32" style="opacity:0.3"></i><span>No media matches your filter</span></div>`;
            lucide.createIcons();
            return;
        }

        let html = '';
        filteredItems.forEach(item => {
            const tagsHtml = item.tags.map(t => `<span class="media-tag">${t}</span>`).join('');

            if (isGallery) {
                // [Gallery View] 保持不变
                html += `<div class="media-item-card"><div class="spectrogram-cover"><img src="${item.spectrogram}" class="spectrogram-img" alt="Spec"><div class="play-overlay"><div class="play-circle"><i data-lucide="play" fill="currentColor"></i></div></div><div class="duration-badge">${item.duration}</div></div><div class="media-card-info"><a href="#" class="media-name" title="${item.name}" onclick="event.stopPropagation(); return false;">${item.name}</a><div class="tags-row">${tagsHtml}</div><div class="media-meta-row"><div class="meta-icon-text"><i data-lucide="calendar" size="14"></i> ${item.date}</div><div class="meta-icon-text"><i data-lucide="clock" size="14"></i> ${item.time}</div><div class="meta-icon-text"><i data-lucide="hard-drive" size="14"></i> ${item.size}</div></div></div></div>`;
            } else {
                // [List View] 调整布局：Topography 和 Water Depth 移至 Site Header
                const realmColor = getRealmColor(item.realm);

                // 构建水深显示逻辑 (如果是 N/A 则不显示图标，保持整洁，或者您可以选择显示灰色)
                const depthHtml = item.freshwater_depth_m !== 'N/A'
                    ? `<span title="Water Depth"><i data-lucide="waves" size="12"></i> ${item.freshwater_depth_m}m</span>`
                    : '';

                html += `
                    <div class="media-item-row">
                        <div class="list-spec-container">
                            <img src="${item.spectrogram}" class="list-spec-img" alt="Spec">
                            <div class="duration-badge">${item.duration}</div>
                        </div>

                        <div class="row-basic-info">
                            <a href="#" class="row-name" title="${item.name}" onclick="event.stopPropagation(); return false;">${item.name}</a>
                            <div class="tags-row">${tagsHtml}</div>
                            <div class="row-meta-list">
                                <div class="row-meta-item"><i data-lucide="calendar" size="14"></i> ${item.date}</div>
                                <div class="row-meta-item"><i data-lucide="clock" size="14"></i> ${item.time}</div>
                                <div class="row-meta-item"><i data-lucide="hard-drive" size="14"></i> ${item.size}</div>
                            </div>
                        </div>

                        <div class="row-details-col">
                            <div class="rd-header-row">
                                <div class="rd-site-group">
                                    <div class="rd-site-name"><i data-lucide="map-pin" size="14" style="color:var(--brand);"></i>${item.site}</div>
                                    <div class="rd-site-metrics">
                                        <span title="Topography"><i data-lucide="mountain" size="12"></i> ${item.topography_m}m</span>
                                        ${depthHtml}
                                    </div>
                                </div>
                                <div class="rd-hierarchy">
                                    <span style="color:${realmColor}">${item.realm}</span>
                                    <span class="rd-bread-sep"><i data-lucide="chevron-right" size="12"></i></span>
                                    <span>${item.biome}</span>
                                    <span class="rd-bread-sep"><i data-lucide="chevron-right" size="12"></i></span>
                                    <span>${item.group}</span>
                                </div>
                            </div>
                            <div class="rd-grid">
                                <div class="rd-item"><span class="rd-label">Medium</span><span class="rd-val">${item.medium}</span></div>
                                <div class="rd-item"><span class="rd-label">Sensor</span><span class="rd-val" title="${item.sensor}">${item.sensor}</span></div>
                                <div class="rd-item"><span class="rd-label">License</span><span class="rd-val" title="${item.license}">${item.license}</span></div>
                                
                                <div class="rd-item span-v"><span class="rd-label">Note</span><span class="rd-val" title="${item.note}">${item.note}</span></div>

                                <div class="rd-item"><span class="rd-label">Uploader</span><span class="rd-val" title="${item.uploader}">${item.uploader}</span></div>
                                <div class="rd-item"><span class="rd-label">Creator</span><span class="rd-val" title="${item.creator}">${item.creator}</span></div>
                                <div class="rd-item"><span class="rd-label">DOI</span><span class="rd-val" title="${item.doi}">${item.doi}</span></div>
                            </div>
                        </div>
                    </div>`;
            }
        });
        container.innerHTML = html;
        lucide.createIcons();
    }

    function switchMediaView(mode, btn) {
        const container = document.getElementById('media-grid-container');
        const btns = document.querySelectorAll('.view-btn');
        const pill = document.getElementById('view-pill');

        if (mode === 'gallery') {
            container.classList.remove('view-list');
            container.classList.add('view-gallery');
        } else {
            container.classList.remove('view-gallery');
            container.classList.add('view-list');
        }

        // [新增] 切换视图时，让滚动区域回到顶部
        const scrollArea = document.querySelector('.media-scroll-area');
        if (scrollArea) scrollArea.scrollTop = 0;

        btns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        pill.style.width = btn.offsetWidth + 'px';
        pill.style.left = btn.offsetLeft + 'px';
        renderMedia();
    }

    // --- TIMELINE MATRIX LOGIC ---

    let tlScale = 1; // [新增] 全局缩放比例
    let tlConfig = {
        grouping: 'realm',
        resolution: 'y',
        groupLabels: {
            'all': 'All Data',
            'realm': 'Realm',
            'biome': 'Biome',
            'group': 'Group',
            'site': 'Site'
        },
        resLabels: {
            'all': 'All Time',
            'y': 'Year',
            'yq': 'Year / Quarter',
            'ym': 'Year / Month',
            'm': 'Month',
            'q': 'Quarter',
            'ymd': 'Year / Month / Day',
            'md': 'Month / Day',
            'd': 'Day'
        }
    };

    function setTimelineGrouping(val) {
        tlConfig.grouping = val;
        const labelMap = {
            'all': 'All Data',
            'realm': 'Realm',
            'biome': 'Biome',
            'group': 'Group',
            'site': 'Site'
        };
        document.getElementById('tl-text-group').textContent = labelMap[val] || tlConfig.groupLabels[val];
        closeSelects();
        renderTimeline();
    }

    function setTimelineResolution(val) {
        tlConfig.resolution = val;
        document.getElementById('tl-text-time').textContent = tlConfig.resLabels[val];
        closeSelects();
        renderTimeline();
    }

    function getTimeKey(item, res) {
        const d = new Date(item.date);
        const y = d.getFullYear();
        const m = d.getMonth(); // 0-11
        const mStr = String(m + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const q = Math.ceil((m + 1) / 3);
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

        switch (res) {
            case 'all':
                return 'Total';
            case 'y':
                return `${y}`;
            case 'yq':
                return `${y}-Q${q}`; // New
            case 'ym':
                return `${y}-${mStr}`;
            case 'm':
                return monthNames[m];
            case 'q':
                return `Q${q}`; // New
            case 'ymd':
                return `${y}-${mStr}-${day}`;
            case 'md':
                return `${monthNames[m]} ${day}`;
            case 'd':
                return `Day ${day}`;
            default:
                return item.date;
        }
    }

    // 强关联数据：确保 MediaItems 的 Realm/Biome/Group 与 currentSites 完全一致
    function enrichMediaData() {
        if (currentSites.length === 0) return;

        // 1. 建立真实站点池
        const realSites = currentSites;

        mediaItems.forEach((item, index) => {
            // 如果该 Item 还没有关联到真实地图数据，或者需要刷新
            if (!item.enriched || !item.realSiteLinked) {
                const siteIndex = (item.id + index) % realSites.length;
                const linkedSite = realSites[siteIndex];

                // 覆写 Item 的属性，使其与 Map 数据一致
                item.site = linkedSite.name; // 显示名称
                item.realm = linkedSite.realm;
                item.biome = linkedSite.biome;
                item.group = linkedSite.group;

                // [New] 补充详细地理信息
                item.topography_m = linkedSite.topography_m;
                item.freshwater_depth_m = linkedSite.freshwater_depth_m;

                // [New] 补充其他模拟元数据
                if (!item.uploader) item.uploader = ["UserA", "LabAdmin", "J.Doe"][rInt(0, 2)];

                // Medium 逻辑: 如果 Realm 是水相关则为 Water，否则为 Air
                const waterRealms = ['Marine', 'Freshwater', 'Estuarine', 'Subterranean'];
                // 注：Subterranean 可能是水也可能是空气，这里简化处理为 Water (或根据具体逻辑调整)
                if (!item.medium) item.medium = waterRealms.includes(item.realm) ? 'Water' : 'Air';

                if (!item.note) item.note = "Standard survey recording during peak activity.";
                if (!item.doi) item.doi = "10.5281/zenodo." + rInt(100000, 999999);

                // 确保 Creator 存在
                if (!item.creator) item.creator = ["Dr. Silva", "M. Lewis", "Field Team A"][rInt(0, 2)];

                item.realSiteLinked = true;
                item.enriched = true;
            }
        });
    }

    function getRowInfo(item, grouping) {
        // 返回: { key, label, sub, color }
        // 颜色优先使用 Realm 颜色
        const color = getRealmColor(item.realm);

        if (grouping === 'all') {
            return {key: 'all', label: 'All Data', sub: null, color: '#666'};
        }
        if (grouping === 'realm') {
            return {key: item.realm, label: item.realm, sub: null, color: color};
        } else if (grouping === 'biome') {
            return {key: item.biome, label: item.biome, sub: item.realm, color: color};
        } else if (grouping === 'group') {
            return {key: item.group, label: item.group, sub: `${item.realm}<br>${item.biome}`, color: color};
        } else if (grouping === 'site') {
            return {key: item.site, label: item.site, sub: `${item.realm}<br>${item.biome}<br>${item.group}`, color: color};
        }
        return {key: 'Unknown', label: 'Unknown', sub: '', color: '#333'};
    }

    function renderTimeline() {
        enrichMediaData();

        const container = document.getElementById('tl-matrix-container');
        const badge = document.getElementById('tl-count-badge');
        const grouping = tlConfig.grouping;
        const resolution = tlConfig.resolution;

        if (badge) badge.textContent = `${mediaItems.length} Items`;

        // 1. 构建矩阵
        const matrix = {};
        const colKeys = new Set();
        const rowKeys = new Set();
        const rowMetaMap = {};

        mediaItems.forEach(item => {
            const rowInfo = getRowInfo(item, grouping);
            const cKey = getTimeKey(item, resolution);
            const rKey = rowInfo.key;

            rowKeys.add(rKey);
            colKeys.add(cKey);

            if (!rowMetaMap[rKey]) rowMetaMap[rKey] = rowInfo;

            if (!matrix[rKey]) matrix[rKey] = {};
            if (!matrix[rKey][cKey]) matrix[rKey][cKey] = [];
            matrix[rKey][cKey].push(item);
        });

        const sortedColKeys = Array.from(colKeys).sort();
        const sortedRowKeys = Array.from(rowKeys).sort();

        if (sortedColKeys.length === 0) {
            container.innerHTML = `<div style="margin: auto; display:flex; flex-direction:column; align-items:center; color:var(--text-muted); gap:10px;"><i data-lucide="calendar-x" size="32"></i><span>No timeline data available</span></div>`;
            lucide.createIcons();
            return;
        }

        // --- [核心逻辑] 动态计算列宽倍数 ---
        // 遍历每一列，找出该列中最大的行数据量
        const colWidthMultipliers = sortedColKeys.map(cKey => {
            let maxItemsInCol = 0;
            sortedRowKeys.forEach(rKey => {
                const count = matrix[rKey][cKey] ? matrix[rKey][cKey].length : 0;
                if (count > maxItemsInCol) maxItemsInCol = count;
            });
            // 规则：最多5个一列。例如 7个 => ceil(7/5) = 2列宽
            return Math.max(1, Math.ceil(maxItemsInCol / 5));
        });

        // 生成 Grid 定义：第一列固定160px，其余动态计算
        const trackDefinitions = colWidthMultipliers.map(m => `calc(${m} * 240px * var(--tl-scale, 1))`).join(" ");
        // [关键] 在这里注入 --tl-scale 变量
        const gridStyle = `grid-template-columns: 160px ${trackDefinitions}; --tl-scale: ${tlScale};`;

        let html = `<div class="tl-matrix-table" style="${gridStyle}">`;

        // Corner Cell
        const yLabel = tlConfig.groupLabels[grouping];
        const xLabel = tlConfig.resLabels[resolution].split(' ')[0];

        html += `<div class="tl-matrix-corner">
                <span>${yLabel}</span>
                <span style="font-size:0.7rem; opacity:0.5; margin:2px 0;">\\</span>
                <span>${xLabel}</span>
            </div>`;

        // Column Headers
        sortedColKeys.forEach(dateKey => {
            html += `<div class="tl-col-header-cell">${dateKey}</div>`;
        });

        // Data Rows
        sortedRowKeys.forEach(rowKey => {
            const meta = rowMetaMap[rowKey];
            let headerHtml = `<span style="font-size:0.95rem; color:${meta.color};">${meta.label}</span>`;
            if (meta.sub) {
                headerHtml += `<span class="tl-row-meta" style="display:block; margin-top:4px; font-weight:500; opacity:0.7; font-size:0.7rem; line-height:1.4;">${meta.sub}</span>`;
            }
            const totalInRow = sortedColKeys.reduce((acc, cKey) => acc + (matrix[rowKey][cKey] ? matrix[rowKey][cKey].length : 0), 0);
            headerHtml += `<span class="tl-row-meta" style="margin-top:6px; color:var(--text-muted); font-weight:700;">${totalInRow} recordings</span>`;

            html += `<div class="tl-row-header-cell">${headerHtml}</div>`;

            // Cells
            sortedColKeys.forEach((colKey, colIndex) => {
                const items = matrix[rowKey][colKey] || [];
                const multiplier = colWidthMultipliers[colIndex];

                html += `<div class="tl-data-cell">`;

                if (items.length > 0) {
                    // [关键 CSS] 先填满垂直5个，再向右扩展
                    const cellInnerStyle = `
                        display: grid;
                        grid-template-rows: repeat(5, min-content);
                        grid-auto-flow: column;
                        grid-template-columns: repeat(${multiplier}, 1fr);
                        gap: calc(12px * var(--tl-scale, 1));
                        width: 100%;
                    `;

                    html += `<div class="tl-cell-grid" style="${cellInnerStyle}">`;
                    items.forEach(item => {
                        const tagsHtml = item.tags.slice(0, 2).map(t => `<span class="media-tag">${t}</span>`).join('');
                        html += `
                                <div class="tl-media-card">
                                    <div class="spectrogram-cover">
                                        <img src="${item.spectrogram}" class="spectrogram-img" loading="lazy" alt="Spec">
                                        <div class="play-overlay"><div class="play-circle"><i data-lucide="play" fill="currentColor" size="14"></i></div></div>
                                        <div class="duration-badge">${item.duration}</div>
                                    </div>
                                    <div class="media-card-info">
                                        <div class="media-name" title="${item.name}">${item.name}</div>
                                        <div class="tags-row">${tagsHtml}</div>
                                        <div class="media-meta-row">
                                            <div class="meta-icon-text"><i data-lucide="calendar"></i> ${item.date}</div>
                                            <div class="meta-icon-text"><i data-lucide="clock"></i> ${item.time}</div>
                                            <div class="meta-icon-text"><i data-lucide="hard-drive"></i> ${item.size}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                    });
                    html += `</div>`;
                } else {
                    html += `<div style="opacity:0.1; text-align:center; font-size:2rem; font-weight:100; margin-top:10px;">·</div>`;
                }
                html += `</div>`;
            });
        });

        html += `</div>`;
        container.innerHTML = html;
        lucide.createIcons();
    }

    // --- GENERAL LOGIC ---
    function getIconForStat(key) {
        const map = {'Users': 'users', 'Collections': 'library', 'Audio': 'mic', 'Photos': 'image', 'Videos': 'video', 'Metadata': 'file-json', 'Tags': 'tags', 'Sites': 'map-pin', 'Projects': 'folder-kanban'};
        return map[key] || 'activity';
    }

    function renderSummary() { /* ... same ... */
        const statsContainer = document.getElementById('summary-stats-grid');
        const contribCard = document.querySelector('.summary-contributors-card');
        const contribList = document.getElementById('summary-contributors-list');
        const contribTitle = document.getElementById('contrib-title');
        let statsObj = {};
        let contributorsArr = [];
        let type = "Project";
        let contribBgIconName = 'users';
        if (currColIdx === 0) {
            const proj = rawProjects[currProjIdx];
            type = "Project";
            statsObj = proj.stats;
            order = ['Users', 'Collections', 'Audio', 'Photos', 'Videos', 'Metadata', 'Tags', 'Sites'];
            contributorsArr = proj.contributors;
            contribBgIconName = 'folder-kanban';
        } else {
            const col = rawProjects[currProjIdx].collections[currColIdx - 1];
            type = "Collection";
            statsObj = col.stats;
            order = ['Users', 'Projects', 'Audio', 'Photos', 'Videos', 'Metadata', 'Tags', 'Sites'];
            contributorsArr = col.contributors;
            contribBgIconName = 'library';
        }
        let statsHTML = '';
        order.forEach((key) => {
            let val = statsObj[key.toLowerCase()] || 0;
            const icon = getIconForStat(key);
            statsHTML += `<div class="summary-stat-card"><div class="stat-content-left"><div class="summary-stat-val ${key === 'Users' ? 'highlight' : ''}">${val}</div><div class="summary-stat-label">${key}</div></div><i data-lucide="${icon}" class="bg-icon"></i></div>`;
        });
        animateBlockSwap(statsContainer, () => {
            statsContainer.innerHTML = statsHTML;
            lucide.createIcons();
        });
        animateBlockSwap(contribCard, () => {
            contribTitle.innerHTML = `<i data-lucide="${type === 'Project' ? 'folder-kanban' : 'library'}"></i> ${type} Contributors`;
            let contribHTML = '';
            contributorsArr.forEach((p, index) => {
                const isCreator = index === 0;
                contribHTML += `<div class="contrib-item"><div class="contrib-info-block"><span class="contrib-name">${p.name}</span><div class="contrib-sub"><a href="mailto:${p.email}" class="contrib-email"><i data-lucide="mail"></i>${p.email}</a><span class="contrib-divider">•</span><a href="https://orcid.org/${p.uid}" target="_blank" class="orcid-link" title="ORCID: ${p.uid}"><i data-lucide="id-card"></i><span class="cid">${p.uid}</span></a></div></div><span class="contrib-role-text ${isCreator ? 'creator-role' : ''}">${p.role}</span></div>`;
            });
            contribList.innerHTML = contribHTML;
            const existingIcon = contribCard.querySelector('.bg-icon-contrib');
            if (existingIcon) existingIcon.remove();
            const bgIcon = document.createElement('i');
            bgIcon.setAttribute('data-lucide', contribBgIconName);
            bgIcon.className = 'bg-icon-contrib';
            contribCard.appendChild(bgIcon);
            lucide.createIcons();
        });
    }

    function renderProjectList() { /* ... same ... */
        const container = document.getElementById('project-list-container');
        const filteredProjs = rawProjects.map((p, i) => ({...p, originalIndex: i})).filter(p => p.name.toLowerCase().includes(projSearchQuery.toLowerCase()));
        if (filteredProjs.length === 0) {
            container.innerHTML = `<div class="empty-state"><i data-lucide="search-x" size="20"></i>No projects found</div>`;
            lucide.createIcons();
            return;
        }
        let html = '';
        filteredProjs.forEach(proj => {
            const isSel = proj.originalIndex === currProjIdx;
            html += `<div class="crumb-item ${isSel ? 'selected' : ''}" onclick="selectProject(${proj.originalIndex})"><span>${proj.name}</span><i data-lucide="check" class="check-icon"></i></div>`;
        });
        container.innerHTML = html;
        lucide.createIcons();
    }

    function renderCollectionList() { /* ... same ... */
        const container = document.getElementById('collection-list-container');
        const rawCols = rawProjects[currProjIdx].collections;
        const displayList = [{name: "All Collections"}, ...rawCols];
        const filteredCols = displayList.map((c, i) => ({...c, originalIndex: i})).filter(c => c.name.toLowerCase().includes(colSearchQuery.toLowerCase()));
        if (filteredCols.length === 0) {
            container.innerHTML = `<div class="empty-state"><i data-lucide="search-x" size="20"></i>No collections found</div>`;
            lucide.createIcons();
            return;
        }
        let html = '';
        filteredCols.forEach(col => {
            const isSel = col.originalIndex === currColIdx;
            html += `<div class="crumb-item ${isSel ? 'selected' : ''}" onclick="selectCollection(${col.originalIndex})"><span>${col.name}</span><i data-lucide="check" class="check-icon"></i></div>`;
        });
        container.innerHTML = html;
        lucide.createIcons();
    }

    const animateBlockSwap = async (containerOrId, updateCallback) => {
        const el = typeof containerOrId === 'string' ? document.getElementById(containerOrId) : containerOrId;
        if (!el) {
            if (updateCallback) updateCallback();
            return;
        }
        el.classList.add('fading-out');
        await new Promise(r => setTimeout(r, 300));
        if (updateCallback) updateCallback();
        el.classList.remove('fading-out');
    };
    const animateImageSwap = async (img, newSrc) => {
        if (img.getAttribute('data-current-src') === newSrc) return;
        img.style.opacity = 0;
        await new Promise(r => setTimeout(r, 300));
        img.src = newSrc;
        img.setAttribute('data-current-src', newSrc);
        const handleLoad = () => {
            img.style.opacity = 1;
            img.removeEventListener('load', handleLoad);
        };
        img.addEventListener('load', handleLoad);
        if (img.complete && img.naturalWidth > 0) {
            handleLoad();
        }
    };
    const animateTextSwap = async (elementOrId, newContent) => {
        const el = typeof elementOrId === 'string' ? document.getElementById(elementOrId) : elementOrId;
        if (!el) return;
        if (el.textContent === newContent) return;
        el.classList.add('fading-out');
        await new Promise(r => setTimeout(r, 300));
        el.textContent = newContent;
        el.classList.remove('fading-out');
    };

    function updateContent(project, immediate = false) {
        const updateLogic = () => {
            document.getElementById('desc-project-title').textContent = project.name;
            document.getElementById('meta-creator-name').textContent = project.creator;
            document.getElementById('meta-date').textContent = project.date;
            const doiDisplay = project.doi.includes('/') ? project.doi.split('/')[1] : project.doi;
            document.getElementById('meta-doi-text').textContent = doiDisplay;
            document.getElementById('meta-link').href = project.externalUrl || "#";
            const projContainer = document.getElementById('rich-text-container');
            projContainer.innerHTML = project.description;
            projContainer.className = "";
            if (project.styleClass) projContainer.classList.add(project.styleClass);
        };
        /* ... same animation logic ... */
        if (immediate) {
            updateLogic();
            const img = document.getElementById('main-project-image');
            img.src = project.image;
            img.setAttribute('data-current-src', project.image);
            img.onload = () => {
                img.style.opacity = 1;
            };
        } else {
            const headerSection = document.querySelector('.desc-header-section');
            const contentArea = document.querySelector('.desc-content-area');
            animateBlockSwap(headerSection, null);
            animateBlockSwap(contentArea, updateLogic);
            const img = document.getElementById('main-project-image');
            animateImageSwap(img, project.image);
        }
        const projLabel = document.getElementById('label-project');
        if (immediate) projLabel.textContent = project.name; else animateTextSwap(projLabel, project.name);
        const fullList = [{name: "All Collections"}, ...project.collections];
        const colName = fullList[0] ? fullList[0].name : "Select...";
        if (immediate) document.getElementById('label-collection').textContent = colName; else animateTextSwap('label-collection', colName);
        const refreshAllViews = () => {
            renderSummary();
            updateMediaContext();
            if (document.getElementById('tab-timeline').classList.contains('active')) renderTimeline();
            loadMapData();
            if (document.getElementById('tab-map').classList.contains('active')) renderMap(true);
        };
        if (immediate) setTimeout(refreshAllViews, 50); else refreshAllViews();
        lucide.createIcons();
    }

    function selectProject(idx) {
        // [Bug 修复] 立即隐藏菜单，防止闪烁
        const dropdown = document.getElementById('dropdown-project');
        dropdown.style.display = 'none';

        const container = document.getElementById('desc-layout-container');
        const isCollectionMode = container.classList.contains('mode-collection');
        if (currProjIdx !== idx) {
            currProjIdx = idx;
            currColIdx = 0;

            // --- [修改] 仅重置滚动位置，保留当前缩放倍数 ---
            const tlContainer = document.getElementById('tl-matrix-container');
            if (tlContainer) {
                tlContainer.scrollTop = 0;
                tlContainer.scrollLeft = 0;
            }
            // ------------------------------------

            projSearchQuery = "";
            document.querySelector('#dropdown-project input').value = "";
            colSearchQuery = "";
            document.querySelector('#dropdown-collection input').value = "";
            if (isCollectionMode) {
                const colPanel = document.getElementById('panel-col-desc');
                colPanel.style.opacity = 0;
                updateContent(rawProjects[currProjIdx], false);
                setTimeout(() => {
                    container.classList.remove('mode-collection');
                    setTimeout(() => {
                        colPanel.style.opacity = 1;
                    }, 800);
                }, 300);
            } else {
                updateContent(rawProjects[currProjIdx], false);
            }
            renderCollectionList();
            renderProjectList();
        }
        // 稍后恢复显示属性（此时 opacity 已经是 0，所以用户看不见）
        setTimeout(() => {
            dropdown.style.display = '';
            closeAllMenus();
        }, 50);
    }

    function selectCollection(idx) {
        // [Bug 修复] 立即隐藏菜单
        const dropdown = document.getElementById('dropdown-collection');
        dropdown.style.display = 'none';

        if (currColIdx !== idx) {
            currColIdx = idx;

            // --- [修改] 仅重置滚动位置，保留当前缩放倍数 ---
            const tlContainer = document.getElementById('tl-matrix-container');
            if (tlContainer) {
                tlContainer.scrollTop = 0;
                tlContainer.scrollLeft = 0;
            }
            // ------------------------------------

            colSearchQuery = "";
            document.querySelector('#dropdown-collection input').value = "";
            const container = document.getElementById('desc-layout-container');
            const project = rawProjects[currProjIdx];
            if (currColIdx === 0) {
                container.classList.remove('mode-collection');
                animateTextSwap('label-collection', "All Collections");
            } else {
                const colData = project.collections[currColIdx - 1];
                const colContainer = document.getElementById('panel-col-desc');
                const colDoiShort = colData.doi.split('/')[1];
                const updateCollectionHTML = () => {
                    // [优化] 集合视图也使用新的胶囊风格
                    colContainer.innerHTML = `
                            <div class="collection-card block-anim">
                                <div class="col-header-group">
                                    <div class="col-badge"><i data-lucide="globe-2" size="14"></i> ${colData.sphere}</div>
                                    <div class="title-row">
                                        <h2 class="col-title smooth-text">${colData.name}</h2>
                                        <a href="${colData.external_media_url}" target="_blank" class="title-link-icon" title="External Media"><i data-lucide="link" size="20"></i></a>
                                    </div>
                                    <div class="col-meta-row smooth-text">
                                        <div class="meta-capsule-box">
                                            <div class="meta-item-btn"><div class="meta-item-icon"><i data-lucide="user" size="14"></i></div>${colData.creator}</div>
                                            <div class="meta-divider"></div>
                                            <div class="meta-item-btn"><div class="meta-item-icon"><i data-lucide="calendar" size="14"></i></div>${colData.date}</div>
                                            <div class="meta-divider"></div>
                                            <div class="meta-item-btn"><div class="meta-item-icon"><i data-lucide="bookmark" size="14"></i></div>${colDoiShort}</span></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-rich-text smooth-text">${colData.description}</div>
                            </div>`;
                    lucide.createIcons();
                };
                if (!container.classList.contains('mode-collection')) {
                    updateCollectionHTML();
                    requestAnimationFrame(() => container.classList.add('mode-collection'));
                } else {
                    const card = colContainer.querySelector('.collection-card');
                    if (card) animateBlockSwap(card, updateCollectionHTML); else updateCollectionHTML();
                }
                const newLabel = project.collections[currColIdx - 1].name;
                animateTextSwap('label-collection', newLabel);
            }

            renderSummary();
            updateMediaContext();
            if (document.getElementById('tab-timeline').classList.contains('active')) renderTimeline();
            loadMapData();
            if (document.getElementById('tab-map').classList.contains('active')) renderMap(true);
            renderCollectionList();
        }
        setTimeout(() => {
            dropdown.style.display = '';
            closeAllMenus();
        }, 50);
    }

    function handleSearchProject(val) {
        projSearchQuery = val;
        renderProjectList();
    }

    function handleSearchCollection(val) {
        colSearchQuery = val;
        renderCollectionList();
    }

    function toggleMenu(id) {
        const el = document.getElementById(id);
        const isActive = el.classList.contains('active');
        closeAllMenus();
        if (!isActive) {
            el.classList.add('active');
            const input = el.querySelector('input');
            if (input) {
                input.value = '';
                setTimeout(() => input.focus(), 50);
            }
            if (id === 'project-wrap') {
                projSearchQuery = "";
                renderProjectList();
            } else if (id === 'collection-wrap') {
                colSearchQuery = "";
                renderCollectionList();
            }
        }
    }

    function closeAllMenus() {
        document.querySelectorAll('.crumb-wrapper, .user-wrapper').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.custom-select-wrapper').forEach(d => d.classList.remove('open'));
    }

    function toggleUserMenu() {
        const el = document.getElementById('user-menu');
        const isActive = el.classList.contains('active');
        closeAllMenus();
        if (!isActive) el.classList.add('active');
    }

    document.addEventListener('click', e => {
        if (e.target.closest('.dropdown-search-box')) return;
        if (!e.target.closest('.crumb-wrapper') && !e.target.closest('.user-wrapper')) {
            document.querySelectorAll('.crumb-wrapper, .user-wrapper').forEach(el => el.classList.remove('active'));
        }
        if (!e.target.closest('.custom-select-wrapper')) closeSelects();
    });

    function movePill(el) {
        const pill = document.getElementById('nav-sliding-pill');
        if (pill && el) {
            pill.style.width = el.offsetWidth + 'px';
            pill.style.left = el.offsetLeft + 'px';
        }
    }

    function switchTab(btn, tabName) {
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        movePill(btn);
        document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
        document.getElementById('tab-' + tabName).classList.add('active');
        if (tabName === 'media') {
            requestAnimationFrame(() => {
                const activeView = document.querySelector('.view-btn.active');
                const pill = document.getElementById('view-pill');
                if (activeView && pill) {
                    pill.style.width = activeView.offsetWidth + 'px';
                    pill.style.left = activeView.offsetLeft + 'px';
                }
            });
        }
        if (tabName === 'timeline') renderTimeline();
        if (tabName === 'map') {
            if (!map) initMap();
            setTimeout(() => {
                map.invalidateSize();
                renderMap(false);
            }, 100);
        }
    }

    window.addEventListener('resize', () => {
        const active = document.querySelector('.nav-item.active');
        if (active) movePill(active);
    });

    function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        const target = current === 'dark' ? 'light' : 'dark';
        setTheme(target);
    }

    function setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        const iconEl = document.getElementById('theme-icon-el');
        if (iconEl) {
            iconEl.setAttribute('data-lucide', theme === 'dark' ? 'sun' : 'moon');
            lucide.createIcons();
        }
        if (currentSelectedSiteId) {
            const site = currentSites.find(s => s.id === currentSelectedSiteId);
            if (site) {
                const color = getRealmColor(site.realm);
                document.documentElement.style.setProperty('--site-color', color);
                document.documentElement.style.setProperty('--site-color-tint', color + '12');
            }
        }
    }

    function init() {
        const saved = localStorage.getItem('theme');
        const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const defaultTheme = saved || (systemDark ? 'dark' : 'light');
        setTheme(defaultTheme);
        renderProjectList();
        renderCollectionList();
        updateContent(rawProjects[0], true);
        const activeView = document.querySelector('.view-btn.active');
        if (activeView) {
            const p = document.getElementById('view-pill');
            p.style.width = activeView.offsetWidth + 'px';
            p.style.left = activeView.offsetLeft + 'px';
        }
        const active = document.querySelector('.nav-item.active');
        if (active) movePill(active);
    }

    // --- TIMELINE INTERACTION (DRAG & ZOOM) ---
    const tlContainer = document.getElementById('tl-matrix-container');
    let isPanning = false;
    let startX = 0, startY = 0, initialScrollLeft = 0, initialScrollTop = 0;

    // 鼠标按下：开始拖拽
    tlContainer.addEventListener('mousedown', (e) => {
        // [修复] 阻止默认行为（防止选中图片导致拖拽卡顿）
        e.preventDefault();

        isPanning = true;
        tlContainer.classList.add('active');
        startX = e.pageX - tlContainer.offsetLeft;
        startY = e.pageY - tlContainer.offsetTop;
        initialScrollLeft = tlContainer.scrollLeft;
        initialScrollTop = tlContainer.scrollTop;
    });

    // 鼠标松开/离开：停止拖拽
    window.addEventListener('mouseup', () => {
        if (isPanning) {
            isPanning = false;
            tlContainer.classList.remove('active');
        }
    });

    // 鼠标移动：执行滚动
    tlContainer.addEventListener('mousemove', (e) => {
        if (!isPanning) return;
        e.preventDefault();
        const x = e.pageX - tlContainer.offsetLeft;
        const y = e.pageY - tlContainer.offsetTop;
        tlContainer.scrollLeft = initialScrollLeft - (x - startX);
        tlContainer.scrollTop = initialScrollTop - (y - startY);
    });

    // 鼠标滚轮：缩放
    tlContainer.addEventListener('wheel', (e) => {
        if (document.getElementById('tab-timeline').classList.contains('active')) {
            e.preventDefault();
            const delta = -Math.sign(e.deltaY) * 0.1;
            tlScale = Math.min(Math.max(0.5, tlScale + delta), 2.0); // 范围 0.5x - 2.0x

            const table = tlContainer.querySelector('.tl-matrix-table');
            // [修复] 更新 CSS 变量而非 transform，确保 sticky 表头不消失
            if (table) table.style.setProperty('--tl-scale', tlScale);
        }
    }, {passive: false});
    // --- CRUD / DATA TAB LOGIC ---

    // 1. Define Schema based on 'database_postgresql_clean(fixed).sql'
    const dbSchema = {
        project: {
            label: "Projects",
            icon: "folder-kanban",
            pk: "project_id",
            columns: [
                {key: "project_id", label: "ID", type: "number", readonly: true},
                {key: "name", label: "Project Name", type: "text"},
                {key: "creator_id", label: "Creator ID", type: "number"},
                {key: "public", label: "Public", type: "boolean"},
                {key: "active", label: "Active", type: "boolean"},
                {key: "creation_date", label: "Created", type: "datetime", readonly: true}
            ]
        },
        collection: {
            label: "Collections",
            icon: "library",
            pk: "collection_id",
            columns: [
                {key: "collection_id", label: "ID", type: "number", readonly: true},
                {key: "name", label: "Name", type: "text"},
                {key: "sphere", label: "Sphere", type: "select", options: ["Atmosphere", "Biosphere", "Hydrosphere", "Lithosphere"]},
                {key: "public_access", label: "Public Access", type: "boolean"},
                {key: "doi", label: "DOI", type: "text"}
            ]
        },
        site: {
            label: "Sites",
            icon: "map-pin",
            pk: "site_id",
            columns: [
                {key: "site_id", label: "ID", type: "number", readonly: true},
                {key: "name", label: "Site Name", type: "text"},
                {key: "realm_id", label: "Realm", type: "text"}, // Simplified
                {key: "topography_m", label: "Elevation (m)", type: "number"},
                {key: "freshwater_depth_m", label: "Water Depth (m)", type: "number"}
            ]
        },
        "user": {
            label: "Users",
            icon: "users",
            pk: "user_id",
            columns: [
                {key: "user_id", label: "ID", type: "number", readonly: true},
                {key: "username", label: "Username", type: "text"},
                {key: "email", label: "Email", type: "text"},
                {key: "role_id", label: "Role ID", type: "number"},
                {key: "active", label: "Active", type: "boolean"}
            ]
        },
        media: {
            label: "Media",
            icon: "file-audio",
            pk: "media_id",
            columns: [
                {key: "media_id", label: "ID", type: "number", readonly: true},
                {key: "name", label: "Filename", type: "text"},
                {key: "media_type", label: "Type", type: "select", options: ["audio", "photo", "video"]},
                {key: "site_id", label: "Site ID", type: "number"},
                {key: "duration_s", label: "Duration (s)", type: "text", readonly: true} // Simplified logic
            ]
        },
        taxon: {
            label: "Taxonomy",
            icon: "sprout",
            pk: "taxon_id",
            columns: [
                {key: "taxon_id", label: "ID", type: "number", readonly: true},
                {key: "cached_scientific_name", label: "Scientific Name", type: "text"},
                {key: "cached_common_name", label: "Common Name", type: "text"},
                {key: "col_species_id", label: "CoL ID", type: "text"}
            ]
        },
        sensor: {
            label: "Sensors",
            icon: "cpu",
            pk: "sensor_id",
            columns: [
                {key: "sensor_id", label: "ID", type: "number", readonly: true},
                {key: "name", label: "Model Name", type: "text"},
                {key: "sensor_type", label: "Type", type: "select", options: ["audio", "photo"]}
            ]
        }
    };

    // 2. Mock Data Store
    let mockDB = {
        project: [
            {project_id: 1, name: "Amazon Rainforest Survey", creator_id: 101, public: true, active: true, creation_date: "2025-01-10"},
            {project_id: 2, name: "Marine Ecosystems Study", creator_id: 102, public: true, active: true, creation_date: "2024-11-05"},
            {project_id: 3, name: "African Savanna Project", creator_id: 105, public: true, active: false, creation_date: "2025-02-15"}
        ],
        collection: [
            {collection_id: 1, name: "Canopy Audio Phase A", sphere: "Biosphere", public_access: true, doi: "10.123/col.1"},
            {collection_id: 2, name: "Hydrophone Data", sphere: "Hydrosphere", public_access: false, doi: "10.123/col.2"}
        ],
        site: [
            {site_id: 1, name: "Site A-101", realm_id: "Terrestrial", topography_m: 450, freshwater_depth_m: 0},
            {site_id: 2, name: "Reef Zone B", realm_id: "Marine", topography_m: -20, freshwater_depth_m: 25.5}
        ],
        "user": [
            {user_id: 101, username: "drsilva", email: "silva@lab.edu", role_id: 2, active: true},
            {user_id: 102, username: "profocean", email: "ocean@uni.edu", role_id: 2, active: true},
            {user_id: 103, username: "student1", email: "s1@uni.edu", role_id: 3, active: false}
        ],
        media: [
            {media_id: 501, name: "REC_20250101.wav", media_type: "audio", site_id: 1, duration_s: "60.0"},
            {media_id: 502, name: "IMG_0023.jpg", media_type: "photo", site_id: 1, duration_s: "-"}
        ],
        taxon: [
            {taxon_id: 1, cached_scientific_name: "Panthera onca", cached_common_name: "Jaguar", col_species_id: "COL:123"},
            {taxon_id: 2, cached_scientific_name: "Ara macao", cached_common_name: "Scarlet Macaw", col_species_id: "COL:456"}
        ],
        sensor: [
            {sensor_id: 1, name: "AudioMoth v1.2", sensor_type: "audio"},
            {sensor_id: 2, name: "GoPro Hero 10", sensor_type: "photo"}
        ]
    };

    let currentTable = "project";
    let crudSearchQuery = "";
    let editingId = null;

    // [新增] 排序和筛选状态
    let sortState = { key: null, direction: 'asc' };
    let crudFilterState = {}; // [修改] 重命名为 crudFilterState 避免与地图 filterState 冲突

    // 3. Functions
    function initDataTab() {
        renderTableNav();
        renderCrudTable();
    }

    function renderTableNav() {
        const navList = document.getElementById('table-nav-list');
        let html = "";
        Object.keys(dbSchema).forEach(key => {
            const table = dbSchema[key];
            const isActive = currentTable === key ? 'active' : '';
            const count = mockDB[key] ? mockDB[key].length : 0;
            html += `
                <div class="dt-item ${isActive}" onclick="switchCrudTable('${key}')">
                    <span style="display:flex; align-items:center; gap:8px;">
                        <i data-lucide="${table.icon}" size="16"></i> ${table.label}
                    </span>
                    <span class="dt-count">${count}</span>
                </div>
            `;
        });
        navList.innerHTML = html;
        lucide.createIcons();
    }

    function switchCrudTable(tableName) {
        currentTable = tableName;
        crudSearchQuery = "";

        // [修复] 使用 ID 精确清空 Data 页面的搜索框
        const searchInput = document.getElementById('data-search-input');
        if (searchInput) searchInput.value = "";

        // [新增] 重置高级状态
        sortState = { key: null, direction: 'asc' };
        crudFilterState = {}; // [修改] 重置新变量

        renderTableNav();
        renderCrudTable();
    }

    function handleDataSearch(val) {
        crudSearchQuery = val.toLowerCase();
        renderCrudTable();
    }

    // [新增] 排序处理函数
    function handleSort(key) {
        if (sortState.key === key) {
            if (sortState.direction === 'asc') {
                sortState.direction = 'desc';
            } else {
                sortState.key = null;
                sortState.direction = 'asc';
            }
        } else {
            sortState.key = key;
            sortState.direction = 'asc';
        }
        renderCrudTable();
    }

    // [新增] 筛选处理函数
    function handleColumnFilter(key, value) {
        if (value === "" || value === "all") {
            delete crudFilterState[key]; // [修改] 使用新变量
        } else {
            crudFilterState[key] = value; // [修改] 使用新变量
        }
        renderCrudTable();
    }

    function renderCrudTable() {
        const schema = dbSchema[currentTable];
        const rawData = mockDB[currentTable] || [];
        const thead = document.getElementById('crud-thead');
        const tbody = document.getElementById('crud-tbody');
        const titleEl = document.getElementById('current-table-title');

        // Update Header Title
        titleEl.innerHTML = `<i data-lucide="${schema.icon}"></i> ${schema.label}`;

        // --- Step A: 生成带排序和筛选的表头 ---
        let headHtml = "<tr>";
        schema.columns.forEach(col => {
            const isSorted = sortState.key === col.key;
            const sortIcon = isSorted
                ? (sortState.direction === 'asc' ? 'arrow-up' : 'arrow-down')
                : 'arrow-up-down';
            const activeClass = isSorted ? 'active-sort' : '';
            const iconOpacity = isSorted ? '1' : '0.3';

            // 确定筛选输入框类型
            let filterInputHtml = '';
            const currentFilterVal = crudFilterState[col.key] || ""; // [修改] 读取新变量

            if (col.type === 'boolean') {
                filterInputHtml = `
                    <select class="th-filter-input" onchange="handleColumnFilter('${col.key}', this.value)" onclick="event.stopPropagation()">
                        <option value="all">All</option>
                        <option value="true" ${currentFilterVal === 'true' ? 'selected' : ''}>True</option>
                        <option value="false" ${currentFilterVal === 'false' ? 'selected' : ''}>False</option>
                    </select>`;
            } else if (col.type === 'select') {
                let opts = `<option value="all">All</option>`;
                col.options.forEach(o => {
                    opts += `<option value="${o}" ${currentFilterVal === o ? 'selected' : ''}>${o}</option>`;
                });
                filterInputHtml = `
                    <select class="th-filter-input" onchange="handleColumnFilter('${col.key}', this.value)" onclick="event.stopPropagation()">
                        ${opts}
                    </select>`;
            } else {
                filterInputHtml = `
                    <input type="text" class="th-filter-input" placeholder="Filter..."
                        value="${currentFilterVal}"
                        oninput="handleColumnFilter('${col.key}', this.value)"
                        onclick="event.stopPropagation()">`;
            }

            headHtml += `
                <th style="min-width: 140px;">
                    <div class="th-header-content ${activeClass}" onclick="handleSort('${col.key}')">
                        <span>${col.label}</span>
                        <i data-lucide="${sortIcon}" size="14" style="opacity:${iconOpacity}"></i>
                    </div>
                    <div class="th-filter-box">
                        ${filterInputHtml}
                    </div>
                </th>`;
        });
        headHtml += `<th style="width: 80px; text-align:right; vertical-align:middle;">Actions</th></tr>`;
        thead.innerHTML = headHtml;

        // --- Step B: 筛选数据 ---
        let processedData = rawData.filter(row => {
            // 1. 全局搜索
            const matchesGlobal = !crudSearchQuery || Object.values(row).some(v => String(v).toLowerCase().includes(crudSearchQuery));
            if (!matchesGlobal) return false;

            // 2. 列筛选
            return Object.keys(crudFilterState).every(key => { // [修改] 遍历新变量
                const filterVal = crudFilterState[key].toLowerCase();
                const rowVal = String(row[key] !== undefined ? row[key] : "").toLowerCase();

                if (filterVal === 'true' || filterVal === 'false') {
                     return rowVal === filterVal;
                }
                return rowVal.includes(filterVal);
            });
        });

        // --- Step C: 排序数据 ---
        if (sortState.key) {
            processedData.sort((a, b) => {
                let valA = a[sortState.key];
                let valB = b[sortState.key];
                if (valA === null || valA === undefined) valA = "";
                if (valB === null || valB === undefined) valB = "";

                if (typeof valA === 'number' && typeof valB === 'number') {
                    return sortState.direction === 'asc' ? valA - valB : valB - valA;
                }

                valA = String(valA).toLowerCase();
                valB = String(valB).toLowerCase();

                if (valA < valB) return sortState.direction === 'asc' ? -1 : 1;
                if (valA > valB) return sortState.direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // --- Step D: 渲染行 ---
        let bodyHtml = "";
        if (processedData.length === 0) {
            bodyHtml = `<tr><td colspan="${schema.columns.length + 1}" style="text-align:center; padding:40px; color:var(--text-muted); font-style:italic;">No matching records found</td></tr>`;
        } else {
            processedData.forEach(row => {
                bodyHtml += `<tr>`;
                schema.columns.forEach(col => {
                    let val = row[col.key];
                    if (val === undefined || val === null) val = "";

                    if (col.type === 'boolean') {
                        val = val ? `<span class="status-badge status-true">True</span>` : `<span class="status-badge status-false">False</span>`;
                    }
                    bodyHtml += `<td>${val}</td>`;
                });
                bodyHtml += `
                    <td style="text-align:right;">
                        <div class="action-btn-group" style="justify-content:flex-end">
                            <button class="action-icon-btn" onclick="openCrudModal('edit', ${row[schema.pk]})" title="Edit"><i data-lucide="pencil" size="14"></i></button>
                            <button class="action-icon-btn delete" onclick="deleteCrudRow(${row[schema.pk]})" title="Delete"><i data-lucide="trash-2" size="14"></i></button>
                        </div>
                    </td>`;
                bodyHtml += `</tr>`;
            });
        }
        tbody.innerHTML = bodyHtml;
        lucide.createIcons();
    }

    function deleteCrudRow(id) {
        if (!confirm("Are you sure you want to delete this record?")) return;
        const pk = dbSchema[currentTable].pk;
        mockDB[currentTable] = mockDB[currentTable].filter(row => row[pk] !== id);
        renderTableNav(); // Update counts
        renderCrudTable();
    }

    function openCrudModal(mode, id = null) {
        const schema = dbSchema[currentTable];
        const modal = document.getElementById('crud-modal-overlay');
        const container = document.getElementById('modal-form-container');
        const title = document.getElementById('modal-title');

        editingId = id;
        title.textContent = mode === 'edit' ? `Edit ${schema.label.slice(0, -1)}` : `New ${schema.label.slice(0, -1)}`;

        // Get existing data if editing
        let currentRow = {};
        if (mode === 'edit') {
            currentRow = mockDB[currentTable].find(r => r[schema.pk] === id) || {};
        }

        // Build Form
        let formHtml = "";
        schema.columns.forEach(col => {
            if (col.readonly && mode === 'add') return; // Skip read-only on add (like ID/Date if auto-generated)

            const val = mode === 'edit' ? (currentRow[col.key] !== undefined ? currentRow[col.key] : "") : "";
            const disabled = (col.readonly && mode === 'edit') ? "disabled style='opacity:0.6; cursor:not-allowed'" : "";

            formHtml += `<div class="form-group"><label class="form-label">${col.label}</label>`;

            if (col.type === 'select') {
                formHtml += `<select class="form-input" id="input-${col.key}" ${disabled}>`;
                col.options.forEach(opt => {
                    const selected = val === opt ? 'selected' : '';
                    formHtml += `<option value="${opt}" ${selected}>${opt}</option>`;
                });
                formHtml += `</select>`;
            } else if (col.type === 'boolean') {
                formHtml += `<select class="form-input" id="input-${col.key}" ${disabled}>
                    <option value="true" ${val === true ? 'selected' : ''}>True</option>
                    <option value="false" ${val === false ? 'selected' : ''}>False</option>
                </select>`;
            } else {
                formHtml += `<input type="text" class="form-input" id="input-${col.key}" value="${val}" ${disabled}>`;
            }
            formHtml += `</div>`;
        });

        container.innerHTML = formHtml;
        modal.classList.add('active');
    }

    function closeCrudModal() {
        document.getElementById('crud-modal-overlay').classList.remove('active');
    }

    function saveCrudData() {
        const schema = dbSchema[currentTable];
        const inputs = document.querySelectorAll('#modal-form-container .form-input');
        let newRow = {};

        inputs.forEach(input => {
            const key = input.id.replace('input-', '');
            let val = input.value;

            // Type conversion
            const colDef = schema.columns.find(c => c.key === key);
            if (colDef) {
                if (colDef.type === 'number') val = Number(val);
                if (colDef.type === 'boolean') val = (val === 'true');
            }
            newRow[key] = val;
        });

        if (editingId !== null) {
            // Update
            const idx = mockDB[currentTable].findIndex(r => r[schema.pk] === editingId);
            if (idx !== -1) {
                // Keep ID and other fields not in form if any
                mockDB[currentTable][idx] = {...mockDB[currentTable][idx], ...newRow};
            }
        } else {
            // Create
            // Auto-generate ID (simulated)
            const maxId = mockDB[currentTable].reduce((max, r) => Math.max(max, r[schema.pk] || 0), 0);
            newRow[schema.pk] = maxId + 1;

            // Auto-date if exists in schema but not form
            if (schema.columns.find(c => c.key === 'creation_date')) {
                newRow.creation_date = new Date().toISOString().split('T')[0];
            }

            mockDB[currentTable].push(newRow);
        }

        renderTableNav();
        renderCrudTable();
        closeCrudModal();
    }

    function refreshTable() {
        // Just re-renders in this mock, would fetch API in real app
        const icon = document.querySelector('.nav-btn-simple i[data-lucide="rotate-ccw"]');
        icon.style.transition = 'transform 0.5s';
        icon.style.transform = 'rotate(360deg)';
        setTimeout(() => icon.style.transform = 'none', 500);
        renderCrudTable();
    }

    // Call init when tab is switched
    const originalSwitchTab = window.switchTab;
    window.switchTab = function (btn, tabName) {
        originalSwitchTab(btn, tabName);
        if (tabName === 'data') {
            initDataTab();
        }
    };
    init();
</script>
</body>

</html>