<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ecoSignal | Dashboard</title>

    <script src="https://unpkg.com/lucide@latest"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <style>
        :root {

            --brand: #83CD20;
            --brand-tint: rgba(131, 205, 32, 0.08);
            --brand-hover: #72b51b;


            --bg-page: radial-gradient(circle at top left, #ffffff, #f8fafc);
            --bg-nav: rgba(255, 255, 255, 0.85);
            --bg-capsule: #f1f5f9;
            --bg-surface: #ffffff;
            --bg-surface-hover: #fcfcfc;
            --bg-surface-secondary: #f8fafc;
            --bg-input: #ffffff;
            --bg-header-tint: rgba(255, 255, 255, 0.4);

            --text-main: #1e293b;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border-light: #e2e8f0;
            --border-color: rgba(0, 0, 0, 0.06);


            --glass-bg: rgba(255, 255, 255, 0.9);
            --card-bg: #ffffff;
            --card-border: 1px solid rgba(0, 0, 0, 0.06);
            --card-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.08),
            0 0 0 1px rgba(255, 255, 255, 0.8) inset;


            --nav-height: 80px;
            --capsule-height: 48px;
            --radius: 24px;


            --w-wide: 60%;
            --gap: 32px;


            --anim-layout-duration: 0.8s;
            --anim-layout-ease: cubic-bezier(0.19, 1, 0.22, 1);
            --anim-fade-duration: 0.3s;
            --anim-fade-ease: ease-out;


            --font-sans: 'Inter', sans-serif;


            --site-color: #0f172a;
            --site-color-tint: rgba(15, 23, 42, 0.05);


            --h-std: 40px;
            --h-sm: 32px;
        }


        [data-theme="dark"] {
            --bg-page: radial-gradient(circle at top left, #0f172a, #020617);
            --bg-nav: rgba(15, 23, 42, 0.85);
            --bg-capsule: #334155;
            --bg-surface: #1e293b;
            --bg-surface-hover: #334155;
            --bg-surface-secondary: #020617;
            --bg-input: #0f172a;
            --bg-header-tint: rgba(0, 0, 0, 0.2);

            --text-main: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;

            --border-light: #334155;
            --border-color: rgba(255, 255, 255, 0.1);

            --glass-bg: rgba(30, 41, 59, 0.85);
            --card-bg: #1e293b;
            --card-border: 1px solid rgba(255, 255, 255, 0.08);
            --card-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.4),
            0 0 0 1px rgba(255, 255, 255, 0.05) inset;

            --site-color: #f8fafc;
        }


        [data-theme="dark"] .leaflet-layer,
        [data-theme="dark"] .leaflet-control-zoom-in,
        [data-theme="dark"] .leaflet-control-zoom-out,
        [data-theme="dark"] .leaflet-control-attribution {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }

        [data-theme="dark"] #full-map {
            background: #0f172a;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: var(--font-sans);
            background: var(--bg-page);
            color: var(--text-main);
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.3); /* 加深颜色 */
            border-radius: 10px;
            transition: background 0.2s;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--brand);
        }


        .project-nav-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--nav-height);
            z-index: 5000;
            background: var(--bg-nav);
            backdrop-filter: blur(25px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 30px;
            box-sizing: border-box;
            gap: 16px;
        }

        .nav-capsule-box {
            position: relative;
            display: flex;
            align-items: center;
            background: var(--bg-capsule);
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.04), inset -1px -1px 3px rgba(255, 255, 255, 0.1);
            border-radius: 60px;
            padding: 4px;
            height: var(--capsule-height);
            box-sizing: border-box;
        }

        [data-theme="dark"] .nav-capsule-box {
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.2);
        }

        .nav-left {
            display: flex;
            align-items: center;
            margin-right: auto;
        }

        .nav-center {
            flex: 0 0 auto;
        }

        .nav-right {
            display: flex;
            justify-content: flex-end;
        }

        .nav-divider {
            width: 1px;
            height: 16px;
            background: var(--border-color);
            margin: 0 6px;
            flex-shrink: 0;
        }

        .nav-logo span,
        .crumb-btn,
        .nav-item,
        .user-name-text {
            font-family: var(--font-sans);
            font-size: 0.9rem;
            font-weight: 600;
            letter-spacing: -0.2px;
        }


        .nav-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--text-main);
            padding: 0 12px;
            height: 100%;
            border-radius: 40px;
            margin-right: 0;
            transition: all 0.2s ease;
        }

        .nav-logo:hover {
            background: var(--brand);
            color: white;
            box-shadow: 0 4px 12px rgba(131, 205, 32, 0.3);
        }

        .logo-icon-box {
            width: 28px;
            height: 28px;
            background: var(--brand);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(131, 205, 32, 0.4);
            transition: all 0.2s ease;
        }

        .nav-logo:hover .logo-icon-box {
            background: white;
            color: var(--brand);
        }


        .breadcrumb-group {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 100%;
        }

        .crumb-wrapper {
            position: relative;
            height: 100%;
        }

        .crumb-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: transparent;
            border: none;
            padding: 0 12px;
            height: 100%;
            border-radius: 40px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
        }

        .crumb-btn:hover {
            background: var(--brand);
            color: white;
            box-shadow: 0 4px 12px rgba(131, 205, 32, 0.3);
        }

        .crumb-wrapper.active .crumb-btn {
            color: var(--brand);
            background: var(--bg-surface-secondary);
        }

        .crumb-separator {
            margin: 0 2px;
            color: var(--text-muted);
            opacity: 0.6;
            font-size: 0.9rem;
        }

        .crumb-dropdown {
            position: absolute;
            top: calc(100% + 14px);
            left: 0;
            min-width: 320px;
            background: var(--bg-surface);
            border-radius: 16px;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
            padding: 0;
            z-index: 5002;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: 0.2s;
            border: var(--card-border);
        }

        .crumb-wrapper.active .crumb-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-search-box {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-icon-small {
            position: absolute;
            left: 12px;
            width: 16px;
            height: 16px;
            color: var(--text-muted);
            z-index: 2;
        }

        .dropdown-input {
            width: 100%;
            padding: 10px 12px 10px 36px;
            border: 1px solid var(--border-light);
            background: var(--bg-input);
            color: var(--text-main);
            border-radius: 10px;
            outline: none;
            font-family: var(--font-sans);
            font-size: 0.9rem;
            transition: all 0.2s;
            box-sizing: border-box;
        }

        .dropdown-input:focus {
            border-color: var(--brand);
            box-shadow: 0 0 0 2px var(--brand-tint);
        }

        .dropdown-list-scroll {
            max-height: 280px;
            overflow-y: auto;
            padding: 6px;
        }

        .crumb-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 2px;
        }

        .crumb-item:hover {
            background: var(--bg-surface-secondary);
            color: var(--brand);
        }

        .crumb-item.selected {
            background: var(--brand-tint);
            color: var(--brand);
        }

        .crumb-item .check-icon {
            opacity: 0;
            transition: opacity 0.2s;
            width: 16px;
            height: 16px;
            color: var(--brand);
        }

        .crumb-item.selected .check-icon {
            opacity: 1;
        }

        .empty-state {
            padding: 20px;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.85rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }


        .sliding-pill {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 4px;
            background: var(--brand);
            border-radius: 50px;
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            z-index: 1;
            width: 0;
            pointer-events: none;
        }

        .nav-item {
            position: relative;
            z-index: 2;
            background: transparent;
            border: none;
            padding: 0 24px;
            height: 100%;
            border-radius: 50px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.25s ease;
        }

        .nav-item.active {
            color: white;
        }

        .nav-item:not(.active):hover {
            color: var(--brand);
        }


        .nav-btn-simple {
            background: transparent;
            border: none;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            width: 40px;
            height: 100%;
            border-radius: 40px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .nav-btn-simple:hover {
            background: var(--brand);
            color: white;
            box-shadow: 0 4px 12px rgba(131, 205, 32, 0.3);
        }

        .user-wrapper {
            position: relative;
            height: 100%;
        }

        .user-capsule-btn {
            padding: 0 16px 0 10px;
            border-radius: 40px;
            gap: 10px;
            height: 100%;
            display: flex;
            align-items: center;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .user-capsule-btn:hover {
            background: var(--brand);
            color: white;
            box-shadow: 0 4px 12px rgba(131, 205, 32, 0.3);
        }

        .user-avatar-icon {
            width: 30px;
            height: 30px;
            background: transparent;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .user-capsule-btn:hover .user-avatar-icon {
            background: white;
            color: var(--brand);
            box-shadow: none;
        }

        .user-wrapper.active .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 14px);
            right: 0;
            width: 220px;
            background: var(--bg-surface);
            border-radius: 20px;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.1);
            padding: 6px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: 0.2s;
            z-index: 5005;
            border: var(--card-border);
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            border-radius: 12px;
            text-decoration: none;
            color: var(--text-main);
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .dropdown-item:hover {
            background: var(--brand-tint);
            color: var(--brand);
        }

        .dropdown-item.danger:hover {
            background: #fee2e2;
            color: #ef4444;
        }

        [data-theme="dark"] .dropdown-item.danger:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .dropdown-divider {
            height: 1px;
            background: var(--border-color);
            margin: 4px 10px;
            opacity: 0.6;
        }


        .content-wrapper {
            position: absolute;
            top: var(--nav-height);
            bottom: 0;
            left: 0;
            right: 0;
            padding: 30px 40px 40px 40px;
            box-sizing: border-box;
            overflow: hidden;
        }

        #tab-map.tab-page {
            padding: 0;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: 0;
            width: 100%;
            height: 100%;
        }

        .tab-page {
            width: 100%;
            height: 100%;
            display: none;
            animation: fadeIn 0.5s ease forwards;
        }

        .tab-page.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: none;

            }
        }

        .block-anim {
            transition: opacity var(--anim-fade-duration) var(--anim-fade-ease);
            opacity: 1;
        }

        .block-anim.fading-out {
            opacity: 0;
        }

        .dashboard-card {
            background: var(--glass-bg);
            border: var(--card-border);
            border-radius: var(--radius);
            box-shadow: var(--card-shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }


        .desc-layout {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .panel-anim {
            transition: transform var(--anim-layout-duration) var(--anim-layout-ease), left var(--anim-layout-duration) var(--anim-layout-ease), width var(--anim-layout-duration) var(--anim-layout-ease), opacity var(--anim-fade-duration) var(--anim-fade-ease);
        }

        #panel-proj-desc {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: var(--w-wide);
            opacity: 1;
            transform: translateX(0);
            z-index: 10;
            background: var(--glass-bg);
            border: var(--card-border);
            border-radius: var(--radius);
            box-shadow: var(--card-shadow);
            padding: 48px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        #panel-visual {
            position: absolute;
            top: 0;
            bottom: 0;
            left: calc(var(--w-wide) + var(--gap));
            width: calc(100% - var(--w-wide) - var(--gap));
            z-index: 20;
            will-change: left, width;
        }

        #panel-col-desc {
            position: absolute;
            top: 0;
            bottom: 0;
            left: calc(var(--w-wide) + var(--gap));
            width: calc(100% - var(--w-wide) - var(--gap));
            transform: translateX(150%);
            opacity: 0;
            z-index: 15;
            display: flex;
            flex-direction: column;
        }

        .desc-layout.mode-collection #panel-proj-desc {
            transform: translateX(-100%);
            opacity: 0;
        }

        .desc-layout.mode-collection #panel-visual {
            left: 0;
            width: var(--w-wide);
        }

        .desc-layout.mode-collection #panel-col-desc {
            transform: translateX(0);
            opacity: 1;
        }


        .desc-header-section {
            flex-shrink: 0;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .title-row {
            display: flex;
            align-items: center;
            gap: 14px;
            margin: 0;
        }

        .desc-title-text {
            font-size: 2.8rem;
            font-weight: 800;
            letter-spacing: -1px;
            margin: 0;
            line-height: 1.1;
            color: var(--text-main);
            font-family: var(--font-sans);
        }

        .title-link-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-surface);
            color: var(--text-muted);
            transition: 0.3s;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .title-link-icon:hover {
            background: var(--brand);
            color: white;
        }

        .desc-content-area {
            flex: 1;
            overflow-y: auto;
            padding-right: 12px;
        }

        .desc-image-container {
            width: 100%;
            height: 100%;
            border-radius: var(--radius);
            overflow: hidden;
            background: #e2e8f0;
            box-shadow: var(--card-shadow);
            border: var(--card-border);
            transform: translateZ(0);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .desc-project-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.4s var(--anim-fade-ease);
        }

        .desc-project-img.loaded {
            opacity: 1;
        }

        .meta-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .meta-capsule-box {
            display: inline-flex;
            align-items: center;
            background: var(--bg-capsule);
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.04), inset -1px -1px 3px rgba(255, 255, 255, 0.1);
            border-radius: 60px;
            padding: 4px;
            gap: 4px;
        }

        [data-theme="dark"] .meta-capsule-box {
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.2);
        }

        .meta-item-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 4px 12px 4px 10px;
            border-radius: 40px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: default;
            transition: all 0.2s ease;
            text-decoration: none;
            height: 32px;
            box-sizing: border-box;
        }

        .meta-item-btn:hover {
            background: var(--bg-surface);
            color: var(--brand);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .meta-item-icon {
            width: 24px;
            height: 24px;
            background: transparent;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: inherit;
            box-shadow: none;
            transition: none;
        }

        .meta-divider {
            width: 1px;
            height: 16px;
            background: var(--border-color);
            margin: 0 2px;
        }

        .collection-card {
            background: var(--card-bg);
            width: 100%;
            height: 100%;
            border-radius: var(--radius);
            box-shadow: var(--card-shadow);
            border: var(--card-border);
            padding: 48px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 24px;
            position: relative;
            overflow: hidden;
        }

        .col-header-group {
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex-shrink: 0;
        }

        .col-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--brand);
            color: white;
            padding: 6px 14px;
            border-radius: 30px;
            font-weight: 700;
            font-size: 0.8rem;
            text-transform: uppercase;
            align-self: flex-start;
            margin-bottom: -5px;
        }

        .col-title {
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin: 0;
            color: var(--text-secondary);
        }

        .col-rich-text {
            font-size: 1.05rem;
            color: var(--text-secondary);
            line-height: 1.8;
            flex: 1;
            border-top: 1px solid var(--border-color);
            padding-top: 24px;
            overflow-y: auto;
        }

        .col-meta-row {
            display: flex;
            gap: 8px;
            margin-top: 4px;
        }

        .col-rt-modern h3 {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-main);
            margin: 1.5em 0 1em 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .col-rt-modern h3 i {
            color: var(--brand);
        }

        .col-rt-modern ul {
            padding-left: 0;
            display: grid;
            gap: 10px;
        }

        .col-rt-modern li {
            padding: 10px 14px;
            background: var(--bg-surface-secondary);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .col-rt-modern li::before {
            content: "";
            display: block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--brand);
        }

        .style-modern {
            color: var(--text-main);
            line-height: 1.8;
        }

        .style-modern h1 {
            font-size: 2.2rem;
            margin: 0 0 0.5em 0;
            font-weight: 800;
        }

        .style-modern h2 {
            font-size: 1.5rem;
            margin: 2em 0 1em 0;
            font-weight: 800;
            border-bottom: 3px solid var(--brand);
            display: inline-block;
            padding-bottom: 5px;
        }

        .style-modern h3 {
            font-size: 1.2rem;
            margin: 1.5em 0 0.8em;
            font-weight: 700;
            color: var(--text-main);
        }

        .style-modern p {
            margin-bottom: 1.2em;
        }

        .style-modern ul {
            margin-bottom: 1.5em;
            padding-left: 1.5em;
        }

        .style-modern li {
            margin-bottom: 0.5em;
        }

        .style-modern blockquote {
            border-left: 4px solid var(--brand);
            margin: 1.5em 0;
            padding: 1em 1.5em;
            background: var(--bg-surface-secondary);
            border-radius: 0 8px 8px 0;
            font-style: italic;
            color: var(--text-secondary);
        }

        .style-modern .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 2em 0;
        }

        .style-modern .data-item {
            background: var(--bg-surface);
            border: var(--card-border);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.02);
        }

        .style-modern .data-val {
            font-size: 1.8rem;
            font-weight: 900;
            display: block;
        }

        .style-modern .data-key {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 700;
            text-transform: uppercase;
        }


        .summary-layout {
            display: flex;
            gap: var(--gap);
            height: 100%;
            width: 100%;
        }

        .summary-stats-container {
            flex: 1.5;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-auto-rows: minmax(140px, 1fr);
            gap: 20px;
            height: 100%;
            overflow-y: auto;
            padding-right: 6px;
        }

        .summary-stat-card {
            background: var(--glass-bg);
            border: var(--card-border);
            border-radius: var(--radius);
            box-shadow: var(--card-shadow);
            padding: 0 32px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            cursor: default;
        }

        .summary-stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1);
            background: var(--bg-surface);
        }

        .stat-content-left {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
        }

        .summary-stat-val {
            font-size: 2.8rem;
            font-weight: 900;
            line-height: 1;
            letter-spacing: -1.5px;
            color: var(--text-main);
            margin-bottom: 4px;
        }

        .summary-stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
        }

        .summary-stat-card .bg-icon {
            position: absolute;
            bottom: -20px;

            right: -20px;
            width: 180px;

            height: 180px;
            opacity: 0.06;
            color: var(--text-main);

            transform: rotate(-10deg) scale(0.8);

            transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out, bottom 0.4s ease-in-out, right 0.4s ease-in-out, color 0.3s ease;
            pointer-events: none;
            z-index: 1;
        }

        .summary-stat-card:hover .bg-icon {
            bottom: 0;
            right: 0;

            transform: rotate(0deg) scale(0.9);
            opacity: 1;
            color: var(--brand);
        }

        .summary-contributors-card {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--glass-bg);
            border: var(--card-border);
            border-radius: var(--radius);
            box-shadow: var(--card-shadow);
            overflow: hidden;
            height: 100%;
            position: relative;
        }

        .summary-contributors-card .bg-icon-contrib {
            position: absolute;
            bottom: -50px;
            right: -30px;
            width: 300px;
            height: 300px;
            opacity: 0.04;
            color: var(--text-main);
            transform: rotate(-10deg);
            pointer-events: none;
            z-index: 1;
            transition: all 0.5s ease;
        }

        .summary-contributors-card:hover .bg-icon-contrib {
            bottom: 0;
            right: 0;
            width: 280px;
            height: 280px;
            opacity: 1;
            color: var(--brand);
            transform: rotate(0deg);
        }

        .card-header,
        .card-body {
            position: relative;
            z-index: 2;
        }

        .card-header {
            padding: 20px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            flex-shrink: 0;
            background: var(--bg-header-tint);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            color: var(--brand);
        }

        .card-body {
            padding: 0;
            overflow-y: auto;
            flex: 1;
        }

        .contributors-list {
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }

        .contrib-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 28px;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }

        .contrib-item:hover {
            background: var(--brand-tint);
        }

        .contrib-info-block {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .contrib-name {
            font-weight: 700;
            color: var(--text-main);
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .contrib-name::before {
            content: '';
            display: block;
            width: 6px;
            height: 6px;
            background: var(--border-light);
            border-radius: 50%;
        }

        .contrib-item:first-child .contrib-name::before {
            background: var(--brand);
            box-shadow: 0 0 0 2px rgba(131, 205, 32, 0.2);
        }

        .contrib-sub {
            padding-left: 14px;
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            gap: 8px;
            align-items: center;
            font-weight: 500;
        }

        .contrib-sub svg {
            width: 13px;
            height: 13px;
            opacity: 0.8;
        }

        .contrib-email,
        .orcid-link {
            display: flex;
            align-items: center;
            gap: 4px;
            text-decoration: none;
            color: inherit;
            transition: color 0.2s;
            cursor: pointer;
        }

        .contrib-email:hover,
        .orcid-link:hover {
            color: var(--brand);
            text-decoration: underline;
        }

        .cid {
            font-family: var(--font-sans);
            letter-spacing: -0.3px;
            opacity: 0.9;
        }

        .contrib-divider {
            opacity: 0.3;
        }

        .contrib-role-text {
            display: inline-block;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            text-align: right;
        }

        .contrib-role-text.creator-role {
            color: var(--brand);
        }


        .media-header {
            display: flex;
            justify-content: space-between;
            align-items: center;


            flex-shrink: 0;
        }

        .media-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .media-count-badge {
            background: var(--bg-capsule);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .media-controls {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .media-search-box {
            position: relative;
            display: flex;
            align-items: center;
            background: var(--bg-capsule);
            border-radius: 60px;

            padding: 0 16px;
            height: var(--h-std);

            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.04), inset -1px -1px 3px rgba(255, 255, 255, 0.1);
            width: 220px;
            box-sizing: border-box;
            border: 1px solid transparent;
            transition: all 0.2s;
        }


        [data-theme="dark"] .media-search-box {
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.2);
        }

        .media-search-box:focus-within {
            background: var(--bg-surface);
            border-color: var(--brand);

            box-shadow: 0 0 0 2px var(--brand-tint);
        }

        .media-search-icon {
            color: var(--text-secondary);
            width: 24px;

            height: 24px;

            margin-right: 8px;
            transition: color 0.2s;
        }

        .media-search-input {
            border: none;
            background: transparent;
            outline: none;
            font-size: 0.85rem;

            width: 100%;
            color: var(--text-secondary);

            font-family: var(--font-sans);
            font-weight: 700;

        }

        .media-search-input::placeholder {
            color: var(--text-muted);
            font-weight: 500;
        }

        .view-switcher-container {
            position: relative;
            display: flex;
            background: var(--bg-capsule);

            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.04), inset -1px -1px 3px rgba(255, 255, 255, 0.1);
            border-radius: 60px;

            padding: 4px;
            height: var(--h-std);
            box-sizing: border-box;
        }

        [data-theme="dark"] .view-switcher-container {
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.2);
        }

        .view-pill {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 4px;
            width: 90px;
            background: var(--brand);

            border-radius: 50px;
            box-shadow: none;

            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            z-index: 1;
            pointer-events: none;
        }

        .view-btn {
            position: relative;
            z-index: 2;
            background: transparent;
            border: none;
            padding: 0 20px;
            height: 100%;
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-secondary);

            transition: color 0.25s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: var(--font-sans);
        }

        .view-btn.active {
            color: white;

        }

        .view-btn:not(.active):hover {
            color: var(--brand);

        }

        .media-scroll-area {
            flex: 1;
            overflow-y: auto;

            min-height: 0;
        }


        .media-container.view-gallery {
            display: grid;
            grid-template-columns: repeat(5, 1fr);

            gap: 32px;

            padding: 20px;
        }

        .media-container.view-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 20px;
        }

        .media-item-card {
            background: var(--bg-surface);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
            border: 1px solid var(--border-color);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s, border-color 0.3s;
            display: flex;
            flex-direction: column;
            position: relative;
            cursor: default;

        }

        .media-item-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1);
            border-color: rgba(131, 205, 32, 0.4);
        }

        .spectrogram-cover {
            width: 100%;
            aspect-ratio: 2 / 1;
            background: #0f172a;
            position: relative;
            overflow: hidden;
            border-bottom: 1px solid var(--border-color);
        }

        .spectrogram-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            mix-blend-mode: screen;
            filter: sepia(1) hue-rotate(60deg) saturate(3) contrast(1.2);
            transition: transform 0.5s ease;
        }

        .media-item-card:hover .spectrogram-img {

            opacity: 1;
        }

        .duration-badge {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 6px;
            font-family: var(--font-sans);
            pointer-events: none;
        }

        .media-card-info {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;

        }

        .media-name {
            font-weight: 700;
            font-size: 1rem;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
            text-decoration: none;
            transition: color 0.2s;
            display: block;
        }

        .media-name:hover {
            color: var(--brand);
            text-decoration: underline;
        }

        .tags-row {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            min-height: 24px;
        }

        .media-tag {
            display: inline-flex;
            background: var(--brand);
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 20px;
            letter-spacing: 0.2px;
            box-shadow: 0 2px 5px rgba(131, 205, 32, 0.25);
        }


        .media-meta-row {
            display: flex;
            justify-content: space-between;
            align-items: center;

            margin-top: auto;

            margin-left: -16px;

            margin-right: -16px;
            margin-bottom: -16px;

            padding: 10px 16px;

            background: var(--bg-surface-secondary);

            border-top: 1px solid var(--border-color);

            color: var(--text-secondary);
            font-size: 0.75rem;
            font-family: var(--font-sans);
            font-weight: 600;
            letter-spacing: -0.2px;
        }

        .meta-icon-text {
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0.8;
            transition: all 0.2s;
        }

        .media-item-card:hover .meta-icon-text {
            opacity: 1;
            color: var(--text-main);
        }


        .media-item-row {
            background: var(--bg-surface);
            border-radius: 12px;
            display: grid;

            grid-template-columns: auto 360px 1fr;
            align-items: stretch;
            gap: 24px;
            padding: 20px;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
            overflow: visible;
        }

        .media-item-row:hover {
            background: var(--bg-surface-hover);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
            border-color: rgba(131, 205, 32, 0.3);
        }


        .media-item-row .list-spec-container {

            width: 320px;

            height: auto;

            aspect-ratio: 2 / 1;


            align-self: center;

            border-radius: 8px;
            position: relative;
            background: #0f172a;
            border: 1px solid var(--border-color);
            overflow: hidden;

            flex-shrink: 0;
        }

        .media-item-row .list-spec-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.8;
            mix-blend-mode: screen;
            filter: sepia(1) hue-rotate(60deg) saturate(3);
            transition: 0.3s;
        }

        .media-item-row:hover .list-spec-img {
            opacity: 1;
        }

        .media-item-row .duration-badge {
            position: absolute;
            bottom: 6px;
            right: 6px;
            background: rgba(0, 0, 0, 0.75);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: var(--font-sans);
            pointer-events: none;
            z-index: 2;
        }


        .row-basic-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
            justify-content: flex-start;
            padding-top: 4px;

            height: 100%;
            box-sizing: border-box;
        }

        a.row-name {
            font-weight: 800;
            font-size: 1.15rem;
            line-height: 1.4;
            color: var(--text-main);
            text-decoration: none;
            transition: color 0.2s;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        a.row-name:hover {
            color: var(--brand);
            text-decoration: underline;
        }

        .row-meta-list {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 16px;

            margin-top: auto;
        }

        .row-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-family: var(--font-sans);
            font-weight: 500;
        }

        .row-meta-item i {
            opacity: 0.7;
        }


        .row-details-col {
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid var(--border-light);
            height: 100%;
            box-sizing: border-box;
        }

        .rd-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 8px;
            margin-bottom: 4px;
        }

        .rd-site-group {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .rd-site-name {
            font-size: 0.95rem;
            font-weight: 800;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .rd-site-metrics {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: 8px;
            padding-left: 12px;
            border-left: 1px solid var(--border-color);
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: var(--font-sans);
            font-weight: 600;
        }

        .rd-site-metrics span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .rd-hierarchy {
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
        }

        .rd-bread-sep {
            opacity: 0.4;
            font-size: 0.8em;
        }

        .rd-grid {
            display: grid;

            grid-template-columns: 1fr 1fr 1fr 1.5fr;
            grid-template-rows: auto auto;
            gap: 12px 16px;
            grid-auto-flow: dense;
        }

        .license-img {
            height: 20px;
            width: auto;
            vertical-align: middle;
            opacity: 0.9;
            margin-top: -2px;
        }

        .rd-item {
            display: flex;
            flex-direction: column;
            gap: 3px;
            overflow: hidden;
        }


        .rd-item.span-v {
            grid-column: 4;
            grid-row: 1 / span 2;
            border-left: 1px solid var(--border-color);
            padding-left: 12px;
            height: 100%;
        }

        .rd-item.span-v .rd-val {
            white-space: normal;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            color: var(--text-secondary);
        }

        .rd-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .rd-val {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }


        .custom-select-wrapper {
            position: relative;
            font-family: var(--font-sans);
        }

        .select-label {
            display: none;
        }


        .select-trigger {
            width: auto;
            min-width: 160px;
            height: var(--h-std);
            padding: 0 16px;
            background: var(--bg-capsule);
            border: 1px solid transparent;
            border-radius: 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.2s;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }

        .select-trigger:hover:not(.disabled) {
            background: var(--bg-surface);
            border-color: var(--border-color);
            color: var(--text-main);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .select-trigger.active {
            background: var(--bg-surface);
            color: var(--brand);
            border-color: var(--brand);
        }


        .select-trigger.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--bg-capsule);
            color: var(--text-muted);
            border-color: transparent;
            box-shadow: none;
            pointer-events: none;
        }

        .select-options {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            width: 100%;
            background: var(--bg-surface);
            border-radius: 16px;
            border: var(--card-border);
            box-shadow: var(--card-shadow);
            max-height: 280px;
            overflow-y: auto;
            z-index: 100;
            padding: 6px;
            box-sizing: border-box;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-5px);
            transition: 0.2s;
        }

        .custom-select-wrapper.open .select-options {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .select-option {
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-main);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.1s;
        }

        .select-option:hover {
            background: var(--bg-capsule);
            color: var(--brand);
        }

        .select-option.selected {
            background: rgba(131, 205, 32, 0.1);
            color: var(--brand);
            font-weight: 700;
        }


        .placeholder-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            text-align: center;
            background: var(--glass-bg);
            border-radius: var(--radius);
            border: var(--card-border);
            box-shadow: var(--card-shadow);
            color: var(--text-muted);
        }

        .placeholder-card h2 {
            font-size: 1.4rem;
            color: var(--text-main);
            margin-bottom: 8px;
            margin-top: 0;
        }

        .placeholder-card p {
            font-size: 1rem;
            line-height: 1.6;
        }


        .map-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
        }

        #full-map {
            width: 100%;
            height: 100%;
            z-index: 1;
            outline: none;
            background: #f0f3f8;
        }


        .custom-cluster-icon {
            background: transparent;
        }

        .donut-cluster {
            position: relative;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
        }

        .donut-cluster:hover {
            transform: scale(1.15);
            z-index: 9000;
        }

        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: var(--bg-surface);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-main);
            line-height: 1;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: background 0.3s, color 0.3s;
        }

        .dc-num {
            font-family: var(--font-sans);
            font-weight: 800;
            font-size: 0.85rem;
        }

        .dc-label {
            font-size: 0.5rem;
            font-weight: 700;
            color: var(--text-muted);
            margin-top: 1px;
        }

        .site-marker-pin {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: var(--bg-surface);
            border: 4px solid var(--border-light);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.75rem;
            color: var(--text-main);
            transition: transform 0.2s, background 0.3s, border-color 0.3s;
        }

        .site-marker-pin:hover {
            transform: scale(1.2);
        }


        .filter-trigger-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1001;
            width: 44px;
            height: 44px;
            background: var(--bg-surface);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--brand);
            border: 1px solid transparent;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .filter-trigger-btn:hover {
            transform: scale(1.05);
            color: var(--brand-hover);
            box-shadow: 0 8px 20px rgba(131, 205, 32, 0.2);
        }

        .filter-trigger-btn.active {
            opacity: 0;
            pointer-events: none;
            transform: translateX(-20px);
        }

        .filter-drawer {
            position: absolute;
            top: 20px;
            bottom: 20px;
            left: 20px;
            width: 280px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            z-index: 1002;
            display: flex;
            flex-direction: column;
            transform: translateX(-150%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            border: var(--card-border);
        }

        .filter-drawer.active {
            transform: translateX(0);
        }

        .fd-header {
            padding: 24px 24px 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            border-bottom: 1px solid var(--border-light);
        }

        .fd-title {
            font-size: 1.1rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-main);
        }

        .fd-close {
            width: 32px;
            height: 32px;
            background: var(--bg-capsule);
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            cursor: pointer;
            transition: 0.2s;
        }

        .fd-close:hover {
            background: var(--brand);
            color: white;
        }

        .fd-content {
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            flex: 1;
        }


        .btn-toolbar {
            height: var(--h-std);
            padding: 0 20px;
            border: 1px solid var(--border-light);
            background: transparent;
            border-radius: 50px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }


        .btn-toolbar:hover:not(:disabled) {
            border-color: var(--brand);
            background: var(--brand);
            color: white;
            box-shadow: 0 4px 12px rgba(131, 205, 32, 0.3);
        }


        .btn-toolbar.danger:hover:not(:disabled) {
            border-color: #ef4444;
            background: #ef4444;
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }


        .btn-toolbar:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--bg-capsule);
            color: var(--text-muted);
            border-color: transparent;
        }


        .crud-checkbox {
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: var(--brand);
            vertical-align: middle;
            margin: 0;
        }


        .sidebar {
            position: absolute;
            top: 20px;
            bottom: 20px;
            right: 20px;
            width: 380px;
            background: var(--bg-surface);
            border-radius: 24px;
            box-shadow: -10px 0 40px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: none;
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .sb-header {
            padding: 20px;
            flex-shrink: 0;
            background: var(--site-color);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            transition: background-color 0.3s;
        }

        .sb-header-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-right: 12px;
        }

        .sb-title {
            font-size: 1.6rem;
            font-weight: 800;
            margin: 0;
            line-height: 1.2;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .sb-meta-row {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
            flex-wrap: wrap;
        }

        .sb-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: var(--font-sans);
            font-size: 0.8rem;
        }

        .sb-meta-divider {
            width: 1px;
            height: 12px;
            background: rgba(255, 255, 255, 0.4);
        }

        .sb-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            cursor: pointer;
            color: white;
            transition: 0.2s;
            margin-left: 0;
            backdrop-filter: blur(4px);
        }

        .sb-close:hover {
            background: white;
            color: var(--site-color);
            transform: rotate(90deg);
        }

        .sb-content {
            flex: 1;
            overflow: hidden;
            background: var(--bg-surface);
            padding: 24px 24px 0 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 0;

        }

        .data-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            border-bottom: 1px dashed var(--border-light);
            flex-shrink: 0;

        }

        .data-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .data-val {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-main);
            text-align: right;
        }

        .section-title {
            font-size: 0.8rem;
            font-weight: 800;
            color: var(--text-main);
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }


        .media-scroll-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding-right: 4px;
            padding-top: 10px;
            padding-bottom: 20px;
        }


        .media-scroll-container .media-item-card {
            flex-shrink: 0;
        }

        .sidebar .media-item-card .media-name {
            font-size: 0.9rem;
        }

        .media-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 12px;
            background: var(--bg-surface);
            border: 1px solid var(--border-light);
            text-decoration: none;
            transition: all 0.2s;
        }

        .media-item:hover {
            border-color: var(--site-color);
            background: var(--bg-surface-hover);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .media-item:hover .media-icon {
            background: var(--site-color);
            color: white;
            border-color: var(--site-color);
        }

        .media-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--bg-surface-secondary);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
            transition: 0.2s;
            border: 1px solid var(--border-light);
        }

        .media-meta {
            flex: 1;
            min-width: 0;
        }

        .media-dur {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: var(--font-sans);
        }

        .opt-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }


        .data-layout-wrapper {
            display: flex;
            height: 100%;
            width: 100%;
            gap: 24px;
        }

        .data-sidebar {
            width: 240px;
            flex-shrink: 0;
            background: var(--glass-bg);
            border: var(--card-border);
            border-radius: var(--radius);
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .data-sidebar-header {
            padding: 20px;
            font-size: 1rem;
            font-weight: 800;
            color: var(--text-main);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .data-table-list {
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .dt-item {
            padding: 10px 14px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: 0.2s;
        }

        .dt-item:hover {
            background: var(--bg-surface-secondary);
            color: var(--brand);
        }

        .dt-item.active {
            background: var(--brand);
            color: white;
            box-shadow: 0 4px 12px rgba(131, 205, 32, 0.3);
        }

        .dt-count {
            font-size: 0.75rem;
            opacity: 0.7;
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 10px;
        }

        .data-main-content {
            flex: 1;
            min-width: 0;
            background: var(--glass-bg);
            border: var(--card-border);
            border-radius: var(--radius);
            box-shadow: var(--card-shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .data-toolbar {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-header-tint);
        }

        .data-table-container {
            flex: 1;
            overflow: auto;
            position: relative;
        }

        .crud-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .crud-table th {
            text-align: left;
            padding: 14px 20px;
            background: var(--bg-surface-secondary);
            color: var(--text-muted);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 1px solid var(--border-color);
        }

        .crud-table td {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-main);
            white-space: nowrap;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .crud-table tr {
            cursor: pointer;
            transition: background 0.1s;
        }

        .crud-table tr:hover {
            background: var(--bg-surface-hover);
        }


        .crud-table tr.selected {
            background: var(--brand-tint) !important;
            box-shadow: inset 3px 0 0 var(--brand) !important;
            border-left: none;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-true {
            background: #dcfce7;
            color: #166534;
        }

        .status-false {
            background: #fee2e2;
            color: #991b1b;
        }

        [data-theme="dark"] .status-true {
            background: rgba(22, 101, 52, 0.3);
            color: #86efac;
        }

        [data-theme="dark"] .status-false {
            background: rgba(153, 27, 27, 0.3);
            color: #fca5a5;
        }




        .crud-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
        }

        .crud-modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .crud-modal {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 480px; /* 侧边栏宽度 */
            max-width: 100%;
            background: var(--bg-surface);
            padding: 30px;
            box-shadow: -10px 0 40px rgba(0, 0, 0, 0.15); /* 阴影改为向左投射 */
            border-left: var(--card-border);
            border-radius: 0; /* 修改：完全直角，去掉圆角 */

            transform: translateX(100%); /* 初始状态在屏幕右侧外 */
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);

            display: flex;
            flex-direction: column;
            gap: 20px;
            max-height: 100%; /* 占满高度 */
        }

        .crud-modal-overlay.active .crud-modal {
            transform: translateX(0); /* 滑入屏幕 */
        }

        /* 针对移动端优化，宽度占满 */
        @media (max-width: 600px) {
            .crud-modal {
                width: 100%;
                border-radius: 0;
            }
        }

        .form-grid {
            display: grid;
            gap: 16px;
            overflow-y: auto;
            padding-right: 5px;
            flex: 1; /* 关键：撑满剩余空间 */
            min-height: 0; /* 防止溢出 */
            align-content: start; /* 内容较少时靠上对齐 */
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .form-input {
            height: var(--h-std);
            padding: 0 14px;
            border-radius: 8px;
            border: 1px solid var(--border-light);
            background: var(--bg-capsule);
            color: var(--text-main);
            font-family: var(--font-sans);
            outline: none;
            box-sizing: border-box;
        }

        .form-input:focus {
            border-color: var(--brand);
            background: var(--bg-surface);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            margin-top: 0;
            flex-shrink: 0; /* 防止被压缩 */
        }

        .btn-primary {
            background: var(--brand);
            color: white;
            border: none;
            height: var(--h-std);
            padding: 0 24px;
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            height: var(--h-std);
            padding: 0 24px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }


        .crud-table th {
            vertical-align: top;
            padding: 10px 12px;
            background: var(--bg-surface-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .th-header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 700;
        }

        .th-header-content:hover {
            color: var(--brand);
        }

        .th-header-content.active-sort {
            color: var(--brand);
        }

        .th-filter-box {
            width: 100%;
        }

        .th-filter-input {
            width: 100%;
            height: var(--h-sm);
            padding: 0 8px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--bg-surface);
            font-size: 0.8rem;
            color: var(--text-main);
            box-sizing: border-box;
            outline: none;
            transition: 0.2s;
        }

        .th-filter-input:focus {
            border-color: var(--brand);
            box-shadow: 0 0 0 2px var(--brand-tint);
        }

        select.th-filter-input {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 24px;
        }
    </style>
</head>

<body>

<nav class="project-nav-bar">
    <div class="nav-left">
        <div class="nav-capsule-box">
            <a href="index.html" class="nav-logo">
                <div class="logo-icon-box"><i data-lucide="activity"></i></div>
                <span>ecoSignal</span>
            </a>
            <div class="nav-divider"></div>
            <div class="breadcrumb-group">
                <div class="crumb-wrapper" id="project-wrap">
                    <button class="crumb-btn" onclick="toggleMenu('project-wrap')">
                        <span id="label-project" class="block-anim">Loading...</span><i data-lucide="chevron-down"
                                                                                        size="14"></i>
                    </button>
                    <div class="crumb-dropdown" id="dropdown-project">
                        <div class="dropdown-search-box">
                            <div class="search-input-wrapper"><i data-lucide="search"
                                                                 class="search-icon-small"></i><input type="text" class="dropdown-input"
                                                                                                      placeholder="Search..." oninput="handleSearchProject(this.value)"
                                                                                                      onclick="event.stopPropagation()"></div>
                        </div>
                        <div id="project-list-container" class="dropdown-list-scroll"></div>
                    </div>
                </div>
                <span class="crumb-separator">/</span>
                <div class="crumb-wrapper" id="collection-wrap">
                    <button class="crumb-btn" onclick="toggleMenu('collection-wrap')">
                        <span id="label-collection" class="block-anim">Loading...</span><i
                            data-lucide="chevron-down" size="14"></i>
                    </button>
                    <div class="crumb-dropdown" id="dropdown-collection">
                        <div class="dropdown-search-box">
                            <div class="search-input-wrapper"><i data-lucide="search"
                                                                 class="search-icon-small"></i><input type="text" class="dropdown-input"
                                                                                                      placeholder="Search..." oninput="handleSearchCollection(this.value)"
                                                                                                      onclick="event.stopPropagation()"></div>
                        </div>
                        <div id="collection-list-container" class="dropdown-list-scroll"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="nav-center">
        <div class="nav-capsule-box">
            <div class="sliding-pill" id="nav-sliding-pill"></div>
            <button class="nav-item active" onclick="switchTab(this, 'desc')">Description</button>
            <button class="nav-item" onclick="switchTab(this, 'summary')">Summary</button>
            <button class="nav-item" onclick="switchTab(this, 'media')">Media</button>
            <button class="nav-item" onclick="switchTab(this, 'map')">Map</button>
            <button class="nav-item" onclick="switchTab(this, 'timeline')">Timeline</button>
            <button class="nav-item" onclick="switchTab(this, 'data')">Data</button>
        </div>
    </div>
    <div class="nav-right">
        <div class="nav-capsule-box">
            <button class="nav-btn-simple" onclick="toggleTheme()" title="Switch Theme">
                <i data-lucide="moon" id="theme-icon-el" size="20"></i>
            </button>
            <div class="nav-divider"></div>

            <button class="nav-btn-simple" title="Information"><i data-lucide="info" size="20"></i></button>
            <div class="nav-divider"></div>
            <div class="user-wrapper" id="user-menu">
                <div class="user-capsule-btn" onclick="toggleUserMenu()">
                    <div class="user-avatar-icon"><i data-lucide="user" size="16"></i></div>
                    <span class="user-name-text">Liudilong</span>
                    <i data-lucide="chevron-down" class="chevron-icon" size="14"></i>
                </div>
                <div class="dropdown-menu">
                    <a href="#" class="dropdown-item"><i data-lucide="settings" size="18"></i> Settings</a>
                    <div class="dropdown-divider"></div>
                    <a href="index.html" class="dropdown-item danger"><i data-lucide="log-out" size="18"></i>
                        Logout</a>
                </div>
            </div>
        </div>
    </div>
</nav>

<div class="content-wrapper">
    <div id="tab-desc" class="tab-page active">
        <div class="desc-layout" id="desc-layout-container">
            <div id="panel-proj-desc" class="panel-anim">
                <div class="desc-header-section block-anim">
                    <div class="title-row">
                        <h1 class="desc-title-text" id="desc-project-title">Loading...</h1>
                        <a href="#" target="_blank" class="title-link-icon" id="meta-link"
                           title="Visit Project Website"><i data-lucide="link"></i></a>
                    </div>
                    <div class="meta-row">
                        <div class="meta-capsule-box">
                            <div class="meta-item-btn" title="Creator">
                                <div class="meta-item-icon"><i data-lucide="user" size="14"></i></div>
                                <span id="meta-creator-name">...</span>
                            </div>
                            <div class="meta-divider"></div>
                            <div class="meta-item-btn" title="Creation Date">
                                <div class="meta-item-icon"><i data-lucide="calendar" size="14"></i></div>
                                <span id="meta-date">...</span>
                            </div>
                            <div class="meta-divider"></div>
                            <div class="meta-item-btn" title="DOI">
                                <div class="meta-item-icon"><i data-lucide="bookmark" size="14"></i></div>
                                <span id="meta-doi-text">...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="desc-content-area block-anim">
                    <div id="rich-text-container">Loading...</div>
                </div>
            </div>
            <div id="panel-visual" class="panel-anim">
                <div class="desc-image-container">
                    <img src="" alt="Project Visual" class="desc-project-img" id="main-project-image">
                </div>
            </div>
            <div id="panel-col-desc" class="panel-anim"></div>
        </div>
    </div>

    <div id="tab-summary" class="tab-page">
        <div class="summary-layout">
            <div class="summary-stats-container block-anim" id="summary-stats-grid"></div>
            <div class="summary-contributors-card block-anim">
                <div class="card-header">
                    <div class="card-title" id="contrib-title"><i data-lucide="users"></i> Project Contributors
                    </div>
                </div>
                <div class="card-body">
                    <div class="contributors-list" id="summary-contributors-list"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="tab-media" class="tab-page">
        <div class="dashboard-card" style="height: 100%;">
            <div class="card-header media-header">
                <div class="media-title"><i data-lucide="music" size="24"></i> Media <span class="media-count-badge"
                                                                                           id="media-count-badge">Loading...</span></div>
                <div class="media-controls">
                    <div class="media-search-box"><i data-lucide="search" class="media-search-icon"></i><input
                            type="text" class="media-search-input" placeholder="Search media or tags..."
                            oninput="handleSearchMedia(this.value)"></div>
                    <div class="view-switcher-container">
                        <div class="view-pill" id="view-pill"></div>
                        <button class="view-btn active"
                                onclick="switchMediaView('gallery', this)"><i data-lucide="grid" size="14"></i>
                            Gallery
                        </button>
                        <button class="view-btn" onclick="switchMediaView('list', this)"><i
                                data-lucide="list" size="14"></i> List
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body media-scroll-area">
                <div class="media-container view-gallery block-anim" id="media-grid-container"></div>
            </div>
        </div>
    </div>
    <div id="tab-map" class="tab-page">
        <div class="map-wrapper">
            <div id="full-map"></div>
            <button class="filter-trigger-btn" id="filter-btn-main"
                    onclick="openFilterDrawer()"><i data-lucide="sliders-horizontal" size="22"></i></button>
            <div class="filter-drawer" id="filter-drawer">
                <div class="fd-header">
                    <div class="fd-title"><i data-lucide="sliders-horizontal" size="20"
                                             color="var(--brand)"></i><span>Filters</span></div>
                    <button class="fd-close"
                            onclick="closeFilterDrawer()"><i data-lucide="chevrons-left" size="20"></i></button>
                </div>
                <div class="fd-content">
                    <div class="custom-select-wrapper" id="sel-realm">
                        <div class="select-trigger" onclick="toggleSelect('sel-realm')"><span class="trigger-text"
                                                                                              id="text-realm">All Realms</span><i data-lucide="chevron-down" size="16"></i></div>
                        <div class="select-options" id="opt-realm"></div>
                    </div>
                    <div class="custom-select-wrapper" id="sel-biome">
                        <div class="select-trigger disabled" id="trig-biome" onclick="toggleSelect('sel-biome')">
                            <span class="trigger-text" id="text-biome">All Biomes</span><i
                                data-lucide="chevron-down" size="16"></i>
                        </div>
                        <div class="select-options" id="opt-biome"></div>
                    </div>
                    <div class="custom-select-wrapper" id="sel-group">
                        <div class="select-trigger disabled" id="trig-group" onclick="toggleSelect('sel-group')">
                            <span class="trigger-text" id="text-group">All Groups</span><i
                                data-lucide="chevron-down" size="16"></i>
                        </div>
                        <div class="select-options" id="opt-group"></div>
                    </div>
                    <button class="btn-toolbar" onclick="resetFilters()" style="width: 100%; margin-top: 12px;"><i data-lucide="rotate-ccw" size="16"></i> Reset</button>
                </div>
            </div>
            <div id="sidebar" class="sidebar">
                <div class="sb-header" id="sb-header-bg">
                    <div class="sb-header-content">
                        <h2 class="sb-title" id="sb-name">Site Name</h2>
                        <div class="sb-meta-row" id="sb-meta-container"></div>
                    </div>
                    <button class="sb-close" onclick="closeSidebar()"><i data-lucide="x" size="18"></i></button>
                </div>
                <div class="sb-content">
                    <div class="data-row"><span class="data-label">Realm</span><span class="data-val"
                                                                                     id="val-realm">--</span></div>
                    <div class="data-row"><span class="data-label">Biome</span><span class="data-val"
                                                                                     id="val-biome">--</span></div>
                    <div class="data-row" style="border-bottom:none;"><span class="data-label">Group</span><span
                            class="data-val" id="val-group">--</span></div>

                    <div class="section-title"><i data-lucide="play-circle" size="16"></i> Media</div>
                    <div class="media-scroll-container" id="media-container"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-timeline" class="tab-page">
    </div>

    <div id="tab-data" class="tab-page">
        <div class="data-layout-wrapper">
            <div class="data-sidebar">
                <div class="data-sidebar-header">
                    <i data-lucide="database" size="18" style="color:var(--brand);"></i> Tables
                </div>
                <div class="data-table-list" id="table-nav-list">
                </div>
            </div>

            <div class="data-main-content">
                <div class="data-toolbar">
                    <div class="card-title" id="current-table-title"><i data-lucide="table"></i> Project</div>
                    <div class="media-controls">
                        <button class="btn-toolbar" onclick="resetDataTable()" title="Reset">
                            <i data-lucide="rotate-ccw" size="16"></i> Reset
                        </button>

                        <div class="media-search-box">
                            <i data-lucide="search" class="media-search-icon"></i>
                            <input type="text" class="media-search-input" id="data-search-input" placeholder="Search" oninput="handleDataSearch(this.value)">
                        </div>

                        <button class="btn-toolbar" onclick="openCrudModal('add')">
                            <i data-lucide="plus" size="16"></i> Add
                        </button>

                        <button class="btn-toolbar" id="btn-edit" onclick="handleToolbarEdit()" disabled>
                            <i data-lucide="pencil" size="16"></i> Edit
                        </button>

                        <button class="btn-toolbar danger" id="btn-delete" onclick="handleToolbarDelete()" disabled>
                            <i data-lucide="trash-2" size="16"></i> Delete
                        </button>
                    </div>
                </div>
                <div class="data-table-container">
                    <table class="crud-table">
                        <thead id="crud-thead">
                        </thead>
                        <tbody id="crud-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="crud-modal-overlay" id="crud-modal-overlay">
        <div class="crud-modal">
            <div class="card-title" id="modal-title">Edit Item</div>
            <div class="form-grid" id="modal-form-container">
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeCrudModal()">Cancel</button>
                <button class="btn-primary" id="modal-submit-btn" onclick="saveCrudData()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<div class="crud-modal-overlay" id="editor-modal-overlay" style="z-index: 10000;">
    <div class="crud-modal" style="width: 800px; max-width: 90vw; transform: translateX(0); left: 50%; top: 50%; bottom: auto; right: auto; border-radius: 16px; transform: translate(-50%, -50%); border-left: none;">
        <div class="card-title" id="editor-title">Edit Description</div>
        <div style="flex: 1; display: flex; flex-direction: column; gap: 10px; min-height: 400px;">
            <div style="background: var(--bg-capsule); padding: 8px; border-radius: 8px; display: flex; gap: 8px; border: 1px solid var(--border-light);">
                <button class="nav-btn-simple" style="width: 32px; height: 32px;"><i data-lucide="bold" size="16"></i></button>
                <button class="nav-btn-simple" style="width: 32px; height: 32px;"><i data-lucide="italic" size="16"></i></button>
                <button class="nav-btn-simple" style="width: 32px; height: 32px;"><i data-lucide="list" size="16"></i></button>
                <div class="nav-divider"></div>
                <button class="nav-btn-simple" style="width: 32px; height: 32px;"><i data-lucide="image" size="16"></i></button>
            </div>
            <textarea id="editor-textarea" style="flex: 1; width: 100%; padding: 16px; border-radius: 8px; border: 1px solid var(--border-light); background: var(--bg-surface); color: var(--text-main); font-family: monospace; line-height: 1.6; resize: none; outline: none; box-sizing: border-box;"></textarea>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeEditorModal()">Cancel</button>
            <button class="btn-primary" onclick="saveEditorContent()">Confirm</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
    lucide.createIcons();


    const generateRichText = (type, title, location, latinName) => {
        if (type === 'modern') {
            return `
                    <div class="style-modern">
                        <span class="tag-label" style="display:inline-block;padding:4px 8px;background:var(--brand);color:white;border-radius:4px;font-size:0.7rem;font-weight:700;margin-bottom:10px;text-transform:uppercase;">Live Monitoring</span>
                        <h1>${title} Digital Overview</h1>
                        <p style="font-size:1.1rem;color:var(--text-secondary);">Deploying next-generation <strong>edge-computing nodes</strong> in ${location} to capture high-fidelity acoustic data.</p>

                        <div class="data-grid">
                            <div class="data-item"><span class="data-val">98.5%</span><span class="data-key">Uptime</span></div>
                            <div class="data-item"><span class="data-val">24/7</span><span class="data-key">Streaming</span></div>
                            <div class="data-item"><span class="data-val">AI</span><span class="data-key">Detection</span></div>
                        </div>

                        <h3>System Architecture</h3>
                        <ul>
                            <li><strong>Edge Nodes:</strong> Solar-powered Raspberry Pi units with AudioMoth sensors.</li>
                            <li><strong>Connectivity:</strong> LoRaWAN mesh network for real-time metadata transmission.</li>
                            <li><strong>Cloud Sync:</strong> Daily batch uploads via Starlink satellite link.</li>
                        </ul>
                    </div>
                `;
        } else if (type === 'academic') {
            return `
                    <div class="style-modern">
                        <div style="background:var(--bg-surface-secondary);padding:20px;border-left:4px solid var(--text-main);margin-bottom:24px;">
                            <h4 style="margin:0 0 8px 0;font-size:0.9rem;text-transform:uppercase;color:var(--text-muted);">Abstract</h4>
                            <p style="margin:0;font-style:italic;">This study investigates the acoustic signature of <em>${latinName}</em> within the ${location} ecosystem, focusing on temporal variations in vocalization intensity.</p>
                        </div>

                        <h2>1. Introduction</h2>
                        <p>Passive Acoustic Monitoring (PAM) has emerged as a non-invasive method for assessing biodiversity.</p>

                        <h2>2. Methodology</h2>
                        <p>We deployed <strong>50 autonomous recording units (ARUs)</strong> across a stratified random grid.</p>
                        <ul>
                            <li>Sampling Rate: 48 kHz</li>
                            <li>Duty Cycle: 10 mins / hour</li>
                            <li>Duration: 6 months</li>
                        </ul>

                        <blockquote>"The results suggest a significant correlation between rainfall patterns and biological acoustic activity."</blockquote>
                    </div>
                `;
        } else {
            return `
                    <div class="style-modern">
                        <p style="font-family:serif;font-size:1.2rem;line-height:1.8;color:var(--text-main);">
                            The jungle was alive. Not with the roar of engines, but with the <strong>symphony of life</strong>.
                        </p>
                        <p>Our team trekked for three days into the heart of ${location}. The humidity was oppressive, but the soundscape was mesmerizing.</p>

                        <div style="margin:24px 0;border-radius:12px;overflow:hidden;border:1px solid var(--border-color);">
                            <img src="https://images.unsplash.com/photo-1542273917363-3b1817f69a2d?auto=format&fit=crop&w=800&q=80" style="width:100%;height:200px;object-fit:cover;display:block;">
                            <div style="padding:12px;background:var(--bg-surface-secondary);font-size:0.8rem;color:var(--text-muted);">Figure 1: Field deployment site at sunrise.</div>
                        </div>

                        <h3>Field Notes: Day 3</h3>
                        <p>We encountered a rare species of <em>${latinName}</em> near the riverbank. The recordings captured here are pristine.</p>
                        <ul>
                            <li>Equipment: Sony PCM-D10</li>
                            <li>Conditions: Light rain</li>
                            <li>Team: K. Mbeki, J. Doe</li>
                        </ul>
                    </div>
                `;
        }
    };

    const colGenerators = [
        (n) => `<div class="col-rt-modern"><h3><i data-lucide="activity"></i> Spectral Analysis</h3><p>${n} exhibits high-frequency harmonics typical of neotropical avian species. The spectrogram reveals distinct banding patterns.</p><ul><li>Bandwidth: 2kHz - 8kHz</li><li>Duration: 1.5s pulses</li></ul></div>`,
        (n) => `<div class="col-rt-modern"><h3><i data-lucide="clock"></i> Temporal Patterns</h3><p>${n} activity peaks during the dawn chorus (05:00 - 06:30) with a secondary, lower intensity peak at dusk.</p></div>`,
        (n) => `<div class="col-rt-modern"><h3><i data-lucide="map-pin"></i> Spatial Distribution</h3><p>Recorded primarily in the riparian zones of the transect. ${n} density decreases significantly >500m from water sources.</p></div>`
    ];

    const projectImages = [
        'https://ecosound-web.de/ecosound_web/sounds/projects/108.jpeg', 'https://ecosound-web.de/ecosound_web/sounds/projects/117.jpeg',
        'https://ecosound-web.de/ecosound_web/sounds/projects/121.jpeg', 'https://ecosound-web.de/ecosound_web/sounds/projects/105.jpeg',
        'https://ecosound-web.de/ecosound_web/sounds/projects/114.jpeg', 'https://ecosound-web.de/ecosound_web/sounds/projects/123.jpeg'
    ];
    const getImg = (idx) => projectImages[idx % projectImages.length];
    const rInt = (min, max) => Math.floor(Math.random() * (max - min + 1) + min);


    const mockNames = ["A. Schmidt", "B. Cohen", "C. Kim", "D. Mwangi", "E. Rossi", "F. Yamamoto", "G. Dubois", "H. Petrov", "I. Al-Fayed", "J. Smith", "K. Gupta", "L. Wei"];

    const projRoles = ["Principal Investigator", "Lead Researcher", "Field Technician", "Data Analyst", "Project Manager", "Ecologist"];

    const colRoles = ["Field Recorder", "Annotator", "Reviewer", "Data Curator", "Metadata Specialist", "Logistics"];


    const getContributors = (count, type, leadName = null) => {
        const list = [];
        const rolePool = type === 'project' ? projRoles : colRoles;

        for (let i = 0; i < count; i++) {
            let name, role;


            if (i === 0 && leadName) {
                name = leadName;
                role = rolePool[0];
            } else {

                name = mockNames[Math.floor(Math.random() * mockNames.length)];
                role = rolePool[Math.floor(Math.random() * (rolePool.length - 1)) + 1];
            }

            list.push({
                name: name,
                role: role,
                email: name.toLowerCase().replace('. ', '.').replace(' ', '.') + "@lab.edu",
                uid: `0000-000${Math.floor(Math.random() * 9)}-${Math.floor(Math.random() * 9999)}-${Math.floor(Math.random() * 9999)}`
            });
        }
        return list;
    };

    const createCollections = (baseName, count, startImgIdx, creatorName) => {
        return Array.from({length: count}, (_, i) => {
            const collectionCreator = `Researcher ${String.fromCharCode(65 + (i % 26))}`;
            return {
                id: `c${i}`,
                name: `${baseName} - Phase ${String.fromCharCode(65 + i)}`,
                active: false,
                creator: collectionCreator,
                date: `2025-0${(i % 9) + 1}-15`,
                doi: `10.ECO/col.${i + 1}`,
                sphere: ["Atmosphere", "Biosphere", "Hydrosphere"][i % 3],
                url: "#",
                description: colGenerators[i % 3](`${baseName}`),
                image: getImg(startImgIdx + i + 1),
                stats: {users: rInt(2, 10), projects: 1, audio: rInt(100, 5000), photos: rInt(10, 200), videos: rInt(0, 50), metadata: rInt(1000, 10000), tags: rInt(50, 300), sites: rInt(1, 5)},

                contributors: getContributors(rInt(3, 5), 'collection', collectionCreator)
            };
        });
    };

    const initialProjects = [
        {
            id: 1, name: "Amazon Rainforest Survey", creator: "Dr. Silva", date: "2025-01-10", doi: "10.1234/amz.01", externalUrl: "https://www.worldwildlife.org/places/amazon",
            description: generateRichText('modern', "Amazon Basin", "Manaus", "Panthera onca"),
            styleClass: "style-modern", image: getImg(0),
            collections: createCollections("Canopy Audio", 8, 0, "Dr. Silva"),
            stats: {users: 45, collections: 8, audio: "120k", photos: 850, videos: 120, metadata: "1.2M", tags: 4500, sites: 12},

            contributors: getContributors(4, 'project', "Dr. Silva")
        },
        {
            id: 2, name: "Marine Ecosystems Study", creator: "Prof. Ocean", date: "2024-11-05", doi: "10.5678/mar.02", externalUrl: "https://www.barrierreef.org/",
            description: generateRichText('academic', "Coral Reefs", "Great Barrier Reef", "Megaptera novaeangliae"),
            styleClass: "style-academic", image: getImg(1),
            collections: createCollections("Hydrophone Data", 6, 5, "Prof. Ocean"),
            stats: {users: 32, collections: 6, audio: "80k", photos: 200, videos: 500, metadata: "800k", tags: 2100, sites: 5},

            contributors: getContributors(3, 'project', "Prof. Ocean")
        },
        {
            id: 3, name: "African Savanna Project", creator: "K. Mbeki", date: "2025-02-15", doi: "10.9999/sav.03", externalUrl: "https://www.awf.org/wildlife-conservation/african-elephant",
            description: generateRichText('blog', "Serengeti", "Tanzania", "Loxodonta africana"),
            styleClass: "style-editorial", image: getImg(2),
            collections: createCollections("Seismic", 5, 2, "K. Mbeki"),
            stats: {users: 28, collections: 5, audio: "45k", photos: 1200, videos: 50, metadata: "500k", tags: 1200, sites: 8},

            contributors: getContributors(5, 'project', "K. Mbeki")
        }
    ];
    const rawProjects = [...initialProjects];

    let currProjIdx = 0;
    let currColIdx = 0;
    let projSearchQuery = "";
    let colSearchQuery = "";


    let map = null;
    let clusterGroup = null;
    let polyLayer = null;
    let currentSites = [];
    let currentSelectedSiteId = null;
    let filterState = {realm: "", biome: "", group: ""};
    const REALM_COLORS = {"Terrestrial": "#65a30d", "Marine": "#0284c7", "Freshwater": "#0891b2", "Subterranean": "#71717a", "Atmospheric": "#f59e0b", "Estuarine": "#14b8a6", "Cryogenic": "#a8a29e", "Artificial": "#db2777", "Introduced": "#9333ea", "Unknown": "#f97316"};
    const TAXONOMY = {
        "Terrestrial": {"Tropical Forests": ["Lowland Rainforest", "Montane Rainforest"], "Savannas": ["Shrubland", "Grassland"]},
        "Marine": {"Coastal": ["Coral Reefs", "Seagrass"], "Pelagic": ["Epipelagic", "Mesopelagic"]},
        "Freshwater": {"Riverine": ["Permanent Rivers", "Seasonal Streams"], "Palustrine": ["Peatlands", "Marshes"]},
        "Subterranean": {"Cave Systems": ["Limestone Caves", "Lava Tubes"], "Aquifers": ["Shallow", "Deep"]},
        "Atmospheric": {"Aerial": ["Lower Troposphere", "Upper Canopy"], "Urban Air": ["City Center", "Industrial"]},
        "Estuarine": {"Brackish Water": ["Mangroves", "Salt Marshes"], "Deltas": ["Active Delta", "Inactive Delta"]},
        "Cryogenic": {"Ice Sheets": ["Polar", "Glacial"], "Tundra": ["Permafrost", "Alpine"]},
        "Artificial": {"Urban": ["Parks", "Gardens"], "Agricultural": ["Farms", "Plantations"]},
        "Introduced": {"Invasive Zones": ["Islands", "Mainland"], "Rehabilitation": ["Forest", "Wetland"]},
        "Unknown": {"Unclassified": ["Region A", "Region B"], "Pending": ["Survey 1", "Survey 2"]}
    };

    function getRealmColor(r) {
        return REALM_COLORS[r] || "#0f172a";
    }

    function generateSitesForContext(projId, colId) {
        // 修改：projId 已经是数字，colId 还是字符串 (c0, c1...)
        let seed = projId + (colId ? colId.charCodeAt(1) * 10 : 0);
        const count = 50 + (seed % 20);
        let baseLat = -3.4, baseLng = -62.2;

        // 修改：匹配数字 ID
        if (projId === 2) {
            baseLat = -18.2;
            baseLng = 147.7;
        }
        if (projId === 3) {
            baseLat = -2.3;
            baseLng = 34.8;
        }
        const realmKeys = Object.keys(TAXONOMY);
        return Array.from({length: count}, (_, i) => {
            let rIndex = Math.floor(Math.random() * realmKeys.length);
            // 修改：匹配数字 ID
            if (projId === 1 && Math.random() > 0.3) rIndex = 0;
            if (projId === 2 && Math.random() > 0.3) rIndex = 1;
            const r = realmKeys[rIndex];
            const bKeys = Object.keys(TAXONOMY[r]);
            const b = bKeys[Math.floor(Math.random() * bKeys.length)];
            const gKeys = TAXONOMY[r][b];
            const g = gKeys[Math.floor(Math.random() * gKeys.length)];
            const lat = baseLat + (Math.random() - 0.5) * 8;
            const lng = baseLng + (Math.random() - 0.5) * 8;
            const vertices = 3 + Math.floor(Math.random() * 5);
            const baseRadius = 0.03;
            const poly = [];
            const rotation = Math.random() * Math.PI;
            for (let k = 0; k < vertices; k++) {
                const angle = (k / vertices) * Math.PI * 2 + rotation;
                const r = baseRadius * (0.8 + Math.random() * 0.4);
                poly.push([lat + Math.sin(angle) * r, lng + Math.cos(angle) * r]);
            }
            return {
                id: `${projId}-${colId || 'all'}-${i}`,
                name: `Site ${String.fromCharCode(65 + (i % 26))}-${100 + i}`,
                center: [lat, lng],
                polygon: poly,
                realm: r,
                biome: b,
                group: g,
                topography_m: Math.floor(Math.random() * 800),
                freshwater_depth_m: r === 'Freshwater' ? (Math.random() * 15).toFixed(1) : "N/A",
                mediaCount: Math.floor(Math.random() * 10) + 2,
                media: Array.from({length: Math.floor(Math.random() * 10) + 2}, (_, m) => ({name: `${r.slice(0, 3).toUpperCase()}_REC_${202500 + m}.wav`, date: "2025-01-15", duration: "01:00:00"}))
            };
        });
    }

    function loadMapData() {

        const projId = rawProjects[currProjIdx].id;
        const colId = currColIdx > 0 ? rawProjects[currProjIdx].collections[currColIdx - 1].id : null;

        if (!colId) {
            currentSites = [];
            rawProjects[currProjIdx].collections.forEach(c => {
                currentSites = [...currentSites, ...generateSitesForContext(projId, c.id)];
            });
        } else {
            currentSites = generateSitesForContext(projId, colId);
        }


        resetFilters();
    }

    function initMap() {
        if (map) return;
        map = L.map('full-map', {zoomControl: false}).setView([-3.465, -62.215], 6);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
        L.control.zoom({position: 'bottomright'}).addTo(map);
        polyLayer = L.layerGroup().addTo(map);
        clusterGroup = L.markerClusterGroup({
            showCoverageOnHover: false, zoomToBoundsOnClick: true, spiderfyOnMaxZoom: true, maxClusterRadius: 60, iconCreateFunction: function (cluster) {
                const markers = cluster.getAllChildMarkers();
                const n = markers.length;
                const realmCounts = {};
                let totalMedia = 0;
                markers.forEach(m => {
                    const r = m.options.customData.realm;
                    realmCounts[r] = (realmCounts[r] || 0) + 1;
                    totalMedia += m.options.customData.mediaCount;
                });
                let gradientParts = [];
                let currentPercentage = 0;
                Object.keys(realmCounts).sort((a, b) => realmCounts[b] - realmCounts[a]).forEach(r => {
                    const pct = (realmCounts[r] / n) * 100;
                    gradientParts.push(`${getRealmColor(r)} ${currentPercentage}% ${currentPercentage + pct}%`);
                    currentPercentage += pct;
                });
                return L.divIcon({
                    html: `<div class="donut-cluster" style="background: conic-gradient(${gradientParts.join(', ')});"><div class="donut-center"><span class="dc-num">${totalMedia}</span><span class="dc-label">MEDIA</span></div></div>`,
                    className: 'custom-cluster-icon',
                    iconSize: L.point(50, 50),
                    iconAnchor: [25, 25]
                });
            }
        });
        map.addLayer(clusterGroup);
        loadMapData();
    }

    function renderMap(shouldZoom = false) {
        if (!map) return;
        polyLayer.clearLayers();
        clusterGroup.clearLayers();
        let visibleBounds = L.latLngBounds([]);
        let visibleCount = 0;
        let isCurrentSiteVisible = false;
        currentSites.forEach(site => {
            if (filterState.realm && site.realm !== filterState.realm) return;
            if (filterState.biome && site.biome !== filterState.biome) return;
            if (filterState.group && site.group !== filterState.group) return;
            if (currentSelectedSiteId && site.id === currentSelectedSiteId) isCurrentSiteVisible = true;
            visibleCount++;
            const siteColor = getRealmColor(site.realm);
            const poly = L.polygon(site.polygon, {color: siteColor, weight: 2, opacity: 0.8, fillColor: siteColor, fillOpacity: 0.15}).addTo(polyLayer);
            poly.on('click', (e) => {
                L.DomEvent.stopPropagation(e);
                openSidebar(site);
            });
            const marker = L.marker(site.center, {
                customData: {realm: site.realm, mediaCount: site.mediaCount},
                icon: L.divIcon({html: `<div class="site-marker-pin" style="border-color:${siteColor}; color:${siteColor}">${site.mediaCount}</div>`, className: 'custom-cluster-icon', iconSize: [28, 28]})
            });
            marker.on('click', () => openSidebar(site));
            clusterGroup.addLayer(marker);
            visibleBounds.extend(site.center);
        });
        if (currentSelectedSiteId && !isCurrentSiteVisible) closeSidebar();
        if ((shouldZoom || visibleCount > 0) && visibleCount > 0) {
            if (visibleCount === 1) map.flyTo(visibleBounds.getCenter(), 14, {duration: 0.8, easeLinearity: 0.5}); else map.fitBounds(visibleBounds, {padding: [50, 50], maxZoom: 15, duration: 0.8, easeLinearity: 0.5});
        }
    }

    function openSidebar(site) {
        currentSelectedSiteId = site.id;
        const color = getRealmColor(site.realm);
        document.documentElement.style.setProperty('--site-color', color);
        document.documentElement.style.setProperty('--site-color-tint', color + '12');


        document.getElementById('sb-name').textContent = site.name;
        document.getElementById('val-realm').textContent = site.realm;
        document.getElementById('val-realm').style.color = color;
        document.getElementById('val-biome').textContent = site.biome;
        document.getElementById('val-group').textContent = site.group;


        const topoHtml = `<div class="sb-meta-item" title="Topography"><i data-lucide="mountain" size="14"></i> ${site.topography_m}m</div>`;
        const depthHtml = site.freshwater_depth_m !== "N/A"
            ? `<div class="sb-meta-divider"></div><div class="sb-meta-item" title="Water Depth"><i data-lucide="waves" size="14"></i> ${site.freshwater_depth_m}m</div>`
            : '';


        const metaContainer = document.getElementById('sb-meta-container');
        if (metaContainer) metaContainer.innerHTML = topoHtml + depthHtml;


        const mockSpectrogram = "https://ecosound-web.de/ecosound_web/sounds/images/51/27/6533-player_s.png";

        const mediaHtml = site.media.map((m) => {

            const mockTagsHtml = `<span class="media-tag">Bio</span><span class="media-tag">Aves</span>`;
            const mockTime = "14:30:00";
            const mockSize = "2.4 MB";

            return `
                <div class="media-item-card" onclick="event.stopPropagation();">
                    <div class="spectrogram-cover">
                        <img src="${mockSpectrogram}" class="spectrogram-img" alt="Spec">
                        <div class="play-overlay"><div class="play-circle"><i data-lucide="play" fill="currentColor"></i></div></div>
                        <div class="duration-badge">${m.duration}</div>
                    </div>
                    <div class="media-card-info">
                        <a href="#" class="media-name" title="${m.name}" onclick="return false;">${m.name}</a>

                        <div class="tags-row">${mockTagsHtml}</div>

                        <div class="media-meta-row">
                            <div class="meta-icon-text"><i data-lucide="calendar" size="14"></i> ${m.date}</div>
                            <div class="meta-icon-text"><i data-lucide="clock" size="14"></i> ${mockTime}</div>
                            <div class="meta-icon-text"><i data-lucide="hard-drive" size="14"></i> ${mockSize}</div>
                        </div>
                    </div>
                </div>`;
        }).join('');


        const mediaListContainer = document.getElementById('media-container');
        mediaListContainer.innerHTML = mediaHtml;
        mediaListContainer.scrollTop = 0;

        lucide.createIcons();
        document.getElementById('sidebar').classList.add('active');
        map.flyTo(site.center, 14, {duration: 0.8, easeLinearity: 0.5});
    }

    function closeSidebar() {
        currentSelectedSiteId = null;
        document.getElementById('sidebar').classList.remove('active');
    }

    function openFilterDrawer() {
        document.getElementById('filter-drawer').classList.add('active');
        document.getElementById('filter-btn-main').classList.add('active');
    }

    function closeFilterDrawer() {
        document.getElementById('filter-drawer').classList.remove('active');
        document.getElementById('filter-btn-main').classList.remove('active');
    }

    function toggleSelect(id) {
        const el = document.getElementById(id);
        if (el.querySelector('.select-trigger').classList.contains('disabled')) return;
        const isOpen = el.classList.contains('open');
        closeSelects();
        if (!isOpen) el.classList.add('open');
    }

    function closeSelects() {
        document.querySelectorAll('.custom-select-wrapper').forEach(d => d.classList.remove('open'));
    }

    function getUniqueValues(data, key) {
        const set = new Set();
        data.forEach(s => {
            if (s[key]) set.add(s[key]);
        });
        return Array.from(set).sort();
    }

    function initFilters() {
        renderSelectOptions('realm');
        updateSelectOptions('biome');
        updateSelectOptions('group');
    }

    function renderSelectOptions(targetType) {
        const list = document.getElementById('opt-' + targetType);
        const options = getUniqueValues(currentSites, 'realm');
        let html = `<div class="select-option" onclick="applyFilter('${targetType}', '')"><div class="opt-dot" style="background:#ccc"></div>All Realms</div>`;
        options.forEach(opt => html += `<div class="select-option" onclick="applyFilter('${targetType}', '${opt}')"><div class="opt-dot" style="background:${getRealmColor(opt)}"></div>${opt}</div>`);
        list.innerHTML = html;
    }

    function applyFilter(type, value) {
        closeSidebar();
        if (type === 'realm') {
            filterState.realm = value;
            filterState.biome = "";
            filterState.group = "";
            updateSelectUI('realm', value);
            updateSelectOptions('biome');
            updateSelectUI('biome', '');
            updateSelectOptions('group');
            updateSelectUI('group', '');
        } else if (type === 'biome') {
            filterState.biome = value;
            filterState.group = "";
            updateSelectUI('biome', value);
            updateSelectOptions('group');
            updateSelectUI('group', '');
        } else if (type === 'group') {
            filterState.group = value;
            updateSelectUI('group', value);
        }
        closeSelects();
        renderMap(true);
    }

    function updateSelectUI(type, value) {
        const textEl = document.getElementById('text-' + type);
        const trigger = type === 'realm' ? document.getElementById('sel-realm').querySelector('.select-trigger') : document.getElementById('trig-' + type);
        const labelMap = {realm: "All Realms", biome: "All Biomes", group: "All Groups"};

        if (!value) {
            textEl.innerHTML = labelMap[type];
            trigger.classList.remove('active');
        } else {
            if (type === 'realm') {

                const color = getRealmColor(value);
                textEl.innerHTML = `<span class="opt-dot" style="background:${color}; display:inline-block; margin-right:8px;"></span>${value}`;
            } else {
                textEl.innerText = value;
            }
            trigger.classList.add('active');
        }
    }

    function updateSelectOptions(targetType) {
        const list = document.getElementById('opt-' + targetType);
        const trigger = document.getElementById('trig-' + targetType);
        let filteredData = currentSites;
        if (targetType === 'biome') {
            if (!filterState.realm) {
                trigger.classList.add('disabled');
                return;
            }
            filteredData = currentSites.filter(s => s.realm === filterState.realm);
        } else if (targetType === 'group') {
            if (!filterState.biome) {
                trigger.classList.add('disabled');
                return;
            }
            filteredData = currentSites.filter(s => s.realm === filterState.realm && s.biome === filterState.biome);
        }
        trigger.classList.remove('disabled');
        const options = getUniqueValues(filteredData, targetType);
        const labelMap = {biome: "All Biomes", group: "All Groups"};
        let html = `<div class="select-option" onclick="applyFilter('${targetType}', '')">${labelMap[targetType]}</div>`;
        if (options.length === 0) html = `<div style="padding:10px;color:#999;font-size:0.85rem">No options</div>`; else options.forEach(opt => html += `<div class="select-option" onclick="applyFilter('${targetType}', '${opt}')">${opt}</div>`);
        list.innerHTML = html;
    }

    function resetFilters() {
        closeSidebar();
        filterState = {realm: "", biome: "", group: ""};
        updateSelectUI('realm', '');
        initFilters();
        renderMap(true);
    }


    let mediaItems = [];
    let mediaSearchQuery = "";
    const taxonTags = ["Aves", "Insecta", "Chiroptera", "Anura", "Anthrophony", "Geophony"];
    const getRandomTags = () => {
        const count = rInt(1, 3);
        const shuffled = taxonTags.sort(() => 0.5 - Math.random());
        return shuffled.slice(0, count);
    };


    const generateMediaForContext = (proj, col) => {
        const prefix = col ? `COL_${col.id}` : `PROJ_${proj.id}`;
        const count = col ? rInt(8, 15) : rInt(24, 40);
        return Array.from({length: count}, (_, i) => {
            const h = Math.floor(Math.random() * 24).toString().padStart(2, '0');
            const m = Math.floor(Math.random() * 60).toString().padStart(2, '0');
            const s = Math.floor(Math.random() * 60).toString().padStart(2, '0');
            const year = 2021 + Math.floor(Math.random() * 5);
            const month = Math.floor(Math.random() * 12) + 1;
            const day = Math.floor(Math.random() * 28) + 1;
            const fullDate = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

            return {
                id: i,
                name: `${prefix}_REC_${20250000 + i}.wav`,
                date: fullDate,
                time: `${h}:${m}:${s}`,
                fullDate: `${fullDate} ${h}:${m}`,
                duration: `00:${rInt(10, 59)}`,
                tags: getRandomTags(),
                size: `${(Math.random() * 5 + 0.5).toFixed(1)} MB`,
                sr: "48kHz",
                spectrogram: "https://ecosound-web.de/ecosound_web/sounds/images/51/27/6533-player_s.png",
                creator: ["Dr. Silva", "M. Lewis", "Field Team A", "Auto-Recorder"][rInt(0, 3)],
                site: `Site-${rInt(1, 12).toString().padStart(2, '0')}`,
                sensor: ["AudioMoth v1.2", "Song Meter Micro", "Zoom F3 + Clippy", "Sony PCM-D10"][rInt(0, 3)],
                license: ["CC BY 4.0", "CC BY-NC", "CC0"][rInt(0, 2)]
            };
        });
    };

    function updateMediaContext() {
        const proj = rawProjects[currProjIdx];
        const col = currColIdx > 0 ? proj.collections[currColIdx - 1] : null;
        mediaItems = generateMediaForContext(proj, col);
        mediaSearchQuery = "";
        const searchInput = document.querySelector('.media-search-input');
        if (searchInput) searchInput.value = "";


        const scrollArea = document.querySelector('.media-scroll-area');
        if (scrollArea) scrollArea.scrollTop = 0;

        const container = document.getElementById('media-grid-container');
        animateBlockSwap(container, () => {
            renderMedia();
        });
    }

    function handleSearchMedia(val) {
        mediaSearchQuery = val.toLowerCase();
        renderMedia();
    }

    function renderMedia() {

        enrichMediaData();

        const container = document.getElementById('media-grid-container');
        const badge = document.getElementById('media-count-badge');
        const isGallery = container.classList.contains('view-gallery');
        const filteredItems = mediaItems.filter(item => item.name.toLowerCase().includes(mediaSearchQuery) || item.tags.some(t => t.toLowerCase().includes(mediaSearchQuery)) || item.site.toLowerCase().includes(mediaSearchQuery) || item.sensor.toLowerCase().includes(mediaSearchQuery));
        badge.textContent = `${filteredItems.length} Items`;

        if (filteredItems.length === 0) {
            container.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:60px; color:var(--text-muted); display:flex; flex-direction:column; align-items:center; gap:10px;"><i data-lucide="filter" size="32" style="opacity:0.3"></i><span>No media matches your filter</span></div>`;
            lucide.createIcons();
            return;
        }

        let html = '';
        filteredItems.forEach(item => {
            const tagsHtml = item.tags.map(t => `<span class="media-tag">${t}</span>`).join('');

            if (isGallery) {

                html += `<div class="media-item-card"><div class="spectrogram-cover"><img src="${item.spectrogram}" class="spectrogram-img" alt="Spec"><div class="play-overlay"><div class="play-circle"><i data-lucide="play" fill="currentColor"></i></div></div><div class="duration-badge">${item.duration}</div></div><div class="media-card-info"><a href="#" class="media-name" title="${item.name}" onclick="event.stopPropagation(); return false;">${item.name}</a><div class="tags-row">${tagsHtml}</div><div class="media-meta-row"><div class="meta-icon-text"><i data-lucide="calendar" size="14"></i> ${item.date}</div><div class="meta-icon-text"><i data-lucide="clock" size="14"></i> ${item.time}</div><div class="meta-icon-text"><i data-lucide="hard-drive" size="14"></i> ${item.size}</div></div></div></div>`;
            } else {

                const realmColor = getRealmColor(item.realm);


                const depthHtml = item.freshwater_depth_m !== 'N/A'
                    ? `<span title="Water Depth"><i data-lucide="waves" size="12"></i> ${item.freshwater_depth_m}m</span>`
                    : '';

                html += `
                    <div class="media-item-row">
                        <div class="list-spec-container">
                            <img src="${item.spectrogram}" class="list-spec-img" alt="Spec">
                            <div class="duration-badge">${item.duration}</div>
                        </div>

                        <div class="row-basic-info">
                            <a href="#" class="row-name" title="${item.name}" onclick="event.stopPropagation(); return false;">${item.name}</a>
                            <div class="tags-row">${tagsHtml}</div>
                            <div class="row-meta-list">
                                <div class="row-meta-item"><i data-lucide="calendar" size="14"></i> ${item.date}</div>
                                <div class="row-meta-item"><i data-lucide="clock" size="14"></i> ${item.time}</div>
                                <div class="row-meta-item"><i data-lucide="hard-drive" size="14"></i> ${item.size}</div>
                            </div>
                        </div>

                        <div class="row-details-col">
                            <div class="rd-header-row">
                                <div class="rd-site-group">
                                    <div class="rd-site-name"><i data-lucide="map-pin" size="14" style="color:var(--brand);"></i>${item.site}</div>
                                    <div class="rd-site-metrics">
                                        <span title="Topography"><i data-lucide="mountain" size="12"></i> ${item.topography_m}m</span>
                                        ${depthHtml}
                                    </div>
                                </div>
                                <div class="rd-hierarchy">
                                    <span style="color:${realmColor}">${item.realm}</span>
                                    <span class="rd-bread-sep"><i data-lucide="chevron-right" size="12"></i></span>
                                    <span>${item.biome}</span>
                                    <span class="rd-bread-sep"><i data-lucide="chevron-right" size="12"></i></span>
                                    <span>${item.group}</span>
                                </div>
                            </div>
                            <div class="rd-grid">
                                <div class="rd-item"><span class="rd-label">Medium</span><span class="rd-val">${item.medium}</span></div>
                                <div class="rd-item"><span class="rd-label">Sensor</span><span class="rd-val" title="${item.sensor}">${item.sensor}</span></div>
                                <div class="rd-item"><span class="rd-label">License</span><span class="rd-val" title="${item.license}">${item.license}</span></div>

                                <div class="rd-item span-v"><span class="rd-label">Note</span><span class="rd-val" title="${item.note}">${item.note}</span></div>

                                <div class="rd-item"><span class="rd-label">Uploader</span><span class="rd-val" title="${item.uploader}">${item.uploader}</span></div>
                                <div class="rd-item"><span class="rd-label">Creator</span><span class="rd-val" title="${item.creator}">${item.creator}</span></div>
                                <div class="rd-item"><span class="rd-label">DOI</span><span class="rd-val" title="${item.doi}">${item.doi}</span></div>
                            </div>
                        </div>
                    </div>`;
            }
        });
        container.innerHTML = html;
        lucide.createIcons();
    }

    function switchMediaView(mode, btn) {
        const container = document.getElementById('media-grid-container');
        const btns = document.querySelectorAll('.view-btn');
        const pill = document.getElementById('view-pill');

        if (mode === 'gallery') {
            container.classList.remove('view-list');
            container.classList.add('view-gallery');
        } else {
            container.classList.remove('view-gallery');
            container.classList.add('view-list');
        }


        const scrollArea = document.querySelector('.media-scroll-area');
        if (scrollArea) scrollArea.scrollTop = 0;

        btns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        pill.style.width = btn.offsetWidth + 'px';
        pill.style.left = btn.offsetLeft + 'px';
        renderMedia();
    }


    function enrichMediaData() {
        if (currentSites.length === 0) return;
        const realSites = currentSites;

        mediaItems.forEach((item, index) => {
            if (!item.enriched || !item.realSiteLinked) {
                const siteIndex = (item.id + index) % realSites.length;
                const linkedSite = realSites[siteIndex];

                item.site = linkedSite.name;
                item.realm = linkedSite.realm;
                item.biome = linkedSite.biome;
                item.group = linkedSite.group;


                item.topography_m = linkedSite.topography_m;
                item.freshwater_depth_m = linkedSite.freshwater_depth_m;


                item.start = moment(`${item.date} ${item.time}`, "YYYY-MM-DD HH:mm:ss").toDate();

                item.end = moment(item.start).add(rInt(1, 10), 'minutes').toDate();

                if (!item.uploader) item.uploader = ["UserA", "LabAdmin", "J.Doe"][rInt(0, 2)];
                if (!item.medium) item.medium = ['Marine', 'Freshwater'].includes(item.realm) ? 'Water' : 'Air';
                if (!item.sensor) item.sensor = ["AudioMoth", "Song Meter", "Audiomoth Dev"][rInt(0, 2)];

                item.realSiteLinked = true;
                item.enriched = true;
            }
        });
    }


    function getIconForStat(key) {
        const map = {'Users': 'users', 'Collections': 'library', 'Audio': 'mic', 'Photos': 'image', 'Videos': 'video', 'Metadata': 'file-json', 'Tags': 'tags', 'Sites': 'map-pin', 'Projects': 'folder-kanban'};
        return map[key] || 'activity';
    }

    function renderSummary() {
        const statsContainer = document.getElementById('summary-stats-grid');
        const contribCard = document.querySelector('.summary-contributors-card');
        const contribList = document.getElementById('summary-contributors-list');
        const contribTitle = document.getElementById('contrib-title');
        let statsObj = {};
        let contributorsArr = [];
        let type = "Project";
        let contribBgIconName = 'users';
        if (currColIdx === 0) {
            const proj = rawProjects[currProjIdx];
            type = "Project";
            statsObj = proj.stats;
            order = ['Users', 'Collections', 'Audio', 'Photos', 'Videos', 'Metadata', 'Tags', 'Sites'];
            contributorsArr = proj.contributors;
            contribBgIconName = 'folder-kanban';
        } else {
            const col = rawProjects[currProjIdx].collections[currColIdx - 1];
            type = "Collection";
            statsObj = col.stats;
            order = ['Users', 'Projects', 'Audio', 'Photos', 'Videos', 'Metadata', 'Tags', 'Sites'];
            contributorsArr = col.contributors;
            contribBgIconName = 'library';
        }
        let statsHTML = '';
        order.forEach((key) => {
            let val = statsObj[key.toLowerCase()] || 0;
            const icon = getIconForStat(key);
            statsHTML += `<div class="summary-stat-card"><div class="stat-content-left"><div class="summary-stat-val ${key === 'Users' ? 'highlight' : ''}">${val}</div><div class="summary-stat-label">${key}</div></div><i data-lucide="${icon}" class="bg-icon"></i></div>`;
        });
        animateBlockSwap(statsContainer, () => {
            statsContainer.innerHTML = statsHTML;
            lucide.createIcons();
        });
        animateBlockSwap(contribCard, () => {
            contribTitle.innerHTML = `<i data-lucide="${type === 'Project' ? 'folder-kanban' : 'library'}"></i> ${type} Contributors`;
            let contribHTML = '';
            contributorsArr.forEach((p, index) => {
                const isCreator = index === 0;
                contribHTML += `<div class="contrib-item"><div class="contrib-info-block"><span class="contrib-name">${p.name}</span><div class="contrib-sub"><a href="mailto:${p.email}" class="contrib-email"><i data-lucide="mail"></i>${p.email}</a><span class="contrib-divider">•</span><a href="https://orcid.org/${p.uid}" target="_blank" class="orcid-link" title="ORCID: ${p.uid}"><i data-lucide="id-card"></i><span class="cid">${p.uid}</span></a></div></div><span class="contrib-role-text ${isCreator ? 'creator-role' : ''}">${p.role}</span></div>`;
            });
            contribList.innerHTML = contribHTML;
            const existingIcon = contribCard.querySelector('.bg-icon-contrib');
            if (existingIcon) existingIcon.remove();
            const bgIcon = document.createElement('i');
            bgIcon.setAttribute('data-lucide', contribBgIconName);
            bgIcon.className = 'bg-icon-contrib';
            contribCard.appendChild(bgIcon);
            lucide.createIcons();
        });
    }

    function renderProjectList() {
        const container = document.getElementById('project-list-container');
        const filteredProjs = rawProjects.map((p, i) => ({...p, originalIndex: i})).filter(p => p.name.toLowerCase().includes(projSearchQuery.toLowerCase()));
        if (filteredProjs.length === 0) {
            container.innerHTML = `<div class="empty-state"><i data-lucide="search-x" size="20"></i>No projects found</div>`;
            lucide.createIcons();
            return;
        }
        let html = '';
        filteredProjs.forEach(proj => {
            const isSel = proj.originalIndex === currProjIdx;
            html += `<div class="crumb-item ${isSel ? 'selected' : ''}" onclick="selectProject(${proj.originalIndex})"><span>${proj.name}</span><i data-lucide="check" class="check-icon"></i></div>`;
        });
        container.innerHTML = html;
        lucide.createIcons();
    }

    function renderCollectionList() {
        const container = document.getElementById('collection-list-container');
        const rawCols = rawProjects[currProjIdx].collections;
        const displayList = [{name: "All Collections"}, ...rawCols];
        const filteredCols = displayList.map((c, i) => ({...c, originalIndex: i})).filter(c => c.name.toLowerCase().includes(colSearchQuery.toLowerCase()));
        if (filteredCols.length === 0) {
            container.innerHTML = `<div class="empty-state"><i data-lucide="search-x" size="20"></i>No collections found</div>`;
            lucide.createIcons();
            return;
        }
        let html = '';
        filteredCols.forEach(col => {
            const isSel = col.originalIndex === currColIdx;
            html += `<div class="crumb-item ${isSel ? 'selected' : ''}" onclick="selectCollection(${col.originalIndex})"><span>${col.name}</span><i data-lucide="check" class="check-icon"></i></div>`;
        });
        container.innerHTML = html;
        lucide.createIcons();
    }

    const animateBlockSwap = async (containerOrId, updateCallback) => {
        const el = typeof containerOrId === 'string' ? document.getElementById(containerOrId) : containerOrId;
        if (!el) {
            if (updateCallback) updateCallback();
            return;
        }
        el.classList.add('fading-out');
        await new Promise(r => setTimeout(r, 300));
        if (updateCallback) updateCallback();
        el.classList.remove('fading-out');
    };
    const animateImageSwap = async (img, newSrc) => {
        if (img.getAttribute('data-current-src') === newSrc) return;
        img.style.opacity = 0;
        await new Promise(r => setTimeout(r, 300));
        img.src = newSrc;
        img.setAttribute('data-current-src', newSrc);
        const handleLoad = () => {
            img.style.opacity = 1;
            img.removeEventListener('load', handleLoad);
        };
        img.addEventListener('load', handleLoad);
        if (img.complete && img.naturalWidth > 0) {
            handleLoad();
        }
    };
    const animateTextSwap = async (elementOrId, newContent) => {
        const el = typeof elementOrId === 'string' ? document.getElementById(elementOrId) : elementOrId;
        if (!el) return;
        if (el.textContent === newContent) return;
        el.classList.add('fading-out');
        await new Promise(r => setTimeout(r, 300));
        el.textContent = newContent;
        el.classList.remove('fading-out');
    };

    function updateContent(project, immediate = false) {
        const updateLogic = () => {
            document.getElementById('desc-project-title').textContent = project.name;
            document.getElementById('meta-creator-name').textContent = project.creator;
            document.getElementById('meta-date').textContent = project.date;
            const doiDisplay = project.doi.includes('/') ? project.doi.split('/')[1] : project.doi;
            document.getElementById('meta-doi-text').textContent = doiDisplay;
            document.getElementById('meta-link').href = project.externalUrl || "#";
            const projContainer = document.getElementById('rich-text-container');
            projContainer.innerHTML = project.description;
            projContainer.className = "";
            if (project.styleClass) projContainer.classList.add(project.styleClass);
        };

        if (immediate) {
            updateLogic();
            const img = document.getElementById('main-project-image');
            img.src = project.image;
            img.setAttribute('data-current-src', project.image);
            img.onload = () => {
                img.style.opacity = 1;
            };
        } else {
            const headerSection = document.querySelector('.desc-header-section');
            const contentArea = document.querySelector('.desc-content-area');
            animateBlockSwap(headerSection, null);
            animateBlockSwap(contentArea, updateLogic);
            const img = document.getElementById('main-project-image');
            animateImageSwap(img, project.image);
        }
        const projLabel = document.getElementById('label-project');
        if (immediate) projLabel.textContent = project.name; else animateTextSwap(projLabel, project.name);
        const fullList = [{name: "All Collections"}, ...project.collections];
        const colName = fullList[0] ? fullList[0].name : "Select...";
        if (immediate) document.getElementById('label-collection').textContent = colName; else animateTextSwap('label-collection', colName);
        const refreshAllViews = () => {
            renderSummary();
            updateMediaContext();
            loadMapData();
            if (document.getElementById('tab-map').classList.contains('active')) renderMap(true);
        };
        if (immediate) setTimeout(refreshAllViews, 50); else refreshAllViews();
        lucide.createIcons();
    }

    function selectProject(idx) {

        const dropdown = document.getElementById('dropdown-project');
        dropdown.style.display = 'none';

        const container = document.getElementById('desc-layout-container');
        const isCollectionMode = container.classList.contains('mode-collection');
        if (currProjIdx !== idx) {
            currProjIdx = idx;
            currColIdx = 0;


            const tlContainer = document.getElementById('tl-matrix-container');
            if (tlContainer) {
                tlContainer.scrollTop = 0;
                tlContainer.scrollLeft = 0;
            }


            projSearchQuery = "";
            document.querySelector('#dropdown-project input').value = "";
            colSearchQuery = "";
            document.querySelector('#dropdown-collection input').value = "";
            if (isCollectionMode) {
                const colPanel = document.getElementById('panel-col-desc');
                colPanel.style.opacity = 0;
                updateContent(rawProjects[currProjIdx], false);
                setTimeout(() => {
                    container.classList.remove('mode-collection');
                    setTimeout(() => {
                        colPanel.style.opacity = 1;
                    }, 800);
                }, 300);
            } else {
                updateContent(rawProjects[currProjIdx], false);
            }
            renderCollectionList();
            renderProjectList();

            // 新增：如果当前在 Data Tab，刷新数据
            if (document.getElementById('tab-data').classList.contains('active')) {
                renderTableNav(); // 刷新侧边栏数量
                renderCrudTable(); // 刷新表格内容
            }
        }

        setTimeout(() => {
            dropdown.style.display = '';
            closeAllMenus();
        }, 50);
    }

    function selectCollection(idx) {

        const dropdown = document.getElementById('dropdown-collection');
        dropdown.style.display = 'none';

        if (currColIdx !== idx) {
            currColIdx = idx;


            const tlContainer = document.getElementById('tl-matrix-container');
            if (tlContainer) {
                tlContainer.scrollTop = 0;
                tlContainer.scrollLeft = 0;
            }


            colSearchQuery = "";
            document.querySelector('#dropdown-collection input').value = "";
            const container = document.getElementById('desc-layout-container');
            const project = rawProjects[currProjIdx];
            if (currColIdx === 0) {
                container.classList.remove('mode-collection');
                animateTextSwap('label-collection', "All Collections");
            } else {
                const colData = project.collections[currColIdx - 1];
                const colContainer = document.getElementById('panel-col-desc');
                const colDoiShort = colData.doi.split('/')[1];
                const updateCollectionHTML = () => {

                    colContainer.innerHTML = `
                            <div class="collection-card block-anim">
                                <div class="col-header-group">
                                    <div class="col-badge"><i data-lucide="globe-2" size="14"></i> ${colData.sphere}</div>
                                    <div class="title-row">
                                        <h2 class="col-title smooth-text">${colData.name}</h2>
                                        <a href="${colData.url}" target="_blank" class="title-link-icon" title="External Media"><i data-lucide="link" size="20"></i></a>
                                    </div>
                                    <div class="col-meta-row smooth-text">
                                        <div class="meta-capsule-box">
                                            <div class="meta-item-btn"><div class="meta-item-icon"><i data-lucide="user" size="14"></i></div>${colData.creator}</div>
                                            <div class="meta-divider"></div>
                                            <div class="meta-item-btn"><div class="meta-item-icon"><i data-lucide="calendar" size="14"></i></div>${colData.date}</div>
                                            <div class="meta-divider"></div>
                                            <div class="meta-item-btn"><div class="meta-item-icon"><i data-lucide="bookmark" size="14"></i></div>${colDoiShort}</span></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-rich-text smooth-text">${colData.description}</div>
                            </div>`;
                    lucide.createIcons();
                };
                if (!container.classList.contains('mode-collection')) {
                    updateCollectionHTML();
                    requestAnimationFrame(() => container.classList.add('mode-collection'));
                } else {
                    const card = colContainer.querySelector('.collection-card');
                    if (card) animateBlockSwap(card, updateCollectionHTML); else updateCollectionHTML();
                }
                const newLabel = project.collections[currColIdx - 1].name;
                animateTextSwap('label-collection', newLabel);
            }

            renderSummary();
            updateMediaContext();
            loadMapData();
            if (document.getElementById('tab-map').classList.contains('active')) renderMap(true);
            renderCollectionList();

            // 新增：如果当前在 Data Tab，刷新数据
            if (document.getElementById('tab-data').classList.contains('active')) {
                renderTableNav(); // 刷新侧边栏数量
                // 切换集合时，如果当前看的是项目层级表（如 project/collection），可能需要切到 site 或 media 才有意义
                // 或者保持当前表不动，只更新内容
                renderCrudTable();
            }
        }
        setTimeout(() => {
            dropdown.style.display = '';
            closeAllMenus();
        }, 50);
    }

    function handleSearchProject(val) {
        projSearchQuery = val;
        renderProjectList();
    }

    function handleSearchCollection(val) {
        colSearchQuery = val;
        renderCollectionList();
    }

    function toggleMenu(id) {
        const el = document.getElementById(id);
        const isActive = el.classList.contains('active');
        closeAllMenus();
        if (!isActive) {
            el.classList.add('active');
            const input = el.querySelector('input');
            if (input) {
                input.value = '';
                setTimeout(() => input.focus(), 50);
            }
            if (id === 'project-wrap') {
                projSearchQuery = "";
                renderProjectList();
            } else if (id === 'collection-wrap') {
                colSearchQuery = "";
                renderCollectionList();
            }
        }
    }

    function closeAllMenus() {
        document.querySelectorAll('.crumb-wrapper, .user-wrapper').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.custom-select-wrapper').forEach(d => d.classList.remove('open'));
    }

    function toggleUserMenu() {
        const el = document.getElementById('user-menu');
        const isActive = el.classList.contains('active');
        closeAllMenus();
        if (!isActive) el.classList.add('active');
    }

    document.addEventListener('click', e => {
        if (e.target.closest('.dropdown-search-box')) return;
        if (!e.target.closest('.crumb-wrapper') && !e.target.closest('.user-wrapper')) {
            document.querySelectorAll('.crumb-wrapper, .user-wrapper').forEach(el => el.classList.remove('active'));
        }
        if (!e.target.closest('.custom-select-wrapper')) closeSelects();
    });

    function movePill(el) {
        const pill = document.getElementById('nav-sliding-pill');
        if (pill && el) {
            pill.style.width = el.offsetWidth + 'px';
            pill.style.left = el.offsetLeft + 'px';
        }
    }

    function switchTab(btn, tabName) {
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        movePill(btn);
        document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
        document.getElementById('tab-' + tabName).classList.add('active');
        if (tabName === 'media') {
            requestAnimationFrame(() => {
                const activeView = document.querySelector('.view-btn.active');
                const pill = document.getElementById('view-pill');
                if (activeView && pill) {
                    pill.style.width = activeView.offsetWidth + 'px';
                    pill.style.left = activeView.offsetLeft + 'px';
                }
            });
        }
        if (tabName === 'map') {
            if (!map) initMap();
            setTimeout(() => {
                map.invalidateSize();
                renderMap(false);
            }, 100);
        }
    }

    window.addEventListener('resize', () => {
        const active = document.querySelector('.nav-item.active');
        if (active) movePill(active);
    });

    function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        const target = current === 'dark' ? 'light' : 'dark';
        setTheme(target);
    }

    function setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        const iconEl = document.getElementById('theme-icon-el');
        if (iconEl) {
            iconEl.setAttribute('data-lucide', theme === 'dark' ? 'sun' : 'moon');
            lucide.createIcons();
        }
        if (currentSelectedSiteId) {
            const site = currentSites.find(s => s.id === currentSelectedSiteId);
            if (site) {
                const color = getRealmColor(site.realm);
                document.documentElement.style.setProperty('--site-color', color);
                document.documentElement.style.setProperty('--site-color-tint', color + '12');
            }
        }
    }

    function init() {
        const saved = localStorage.getItem('theme');
        const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const defaultTheme = saved || (systemDark ? 'dark' : 'light');
        setTheme(defaultTheme);
        renderProjectList();
        renderCollectionList();
        updateContent(rawProjects[0], true);
        const activeView = document.querySelector('.view-btn.active');
        if (activeView) {
            const p = document.getElementById('view-pill');
            p.style.width = activeView.offsetWidth + 'px';
            p.style.left = activeView.offsetLeft + 'px';
        }
        const active = document.querySelector('.nav-item.active');
        if (active) movePill(active);
    }


    const dbSchema = {
        project: {
            label: "All Projects",
            itemLabel: "Project",
            icon: "folder-kanban",
            pk: "project_id",
            columns: [
                { key: "project_id", label: "ID", type: "number", readonly: true },
                { key: "uuid", label: "UUID", type: "text", readonly: true, hiddenInTable: true },
                { key: "name", label: "Name", type: "text" },
                // 增加 filterType: 'text'，强制筛选器为文本框
                { key: "creator_name", label: "Creator", type: "select", options: mockNames, filterType: 'text' },
                { key: "url", label: "URL", type: "text" },
                { key: "doi", label: "DOI", type: "text" },
                { key: "public", label: "Public", type: "boolean" },
                { key: "active", label: "Active", type: "boolean" },
                { key: "creation_date", label: "Created", type: "text", readonly: true },
                // 将三个“大控件”移动到底部
                { key: "picture_url", label: "Picture", type: "file" },
                { key: "description_short", label: "Short Description", type: "richtext", hiddenInTable: true },
                { key: "description", label: "Description", type: "richtext", hiddenInTable: true }
            ]
        },
        collection: {
            label: "Collections",
            icon: "library",
            pk: "collection_id",
            columns: [
                { key: "collection_id", label: "ID", type: "number", readonly: true },
                { key: "uuid", label: "UUID", type: "text", readonly: true, hiddenInTable: true },
                { key: "name", label: "Name", type: "text" },
                { key: "creator_id", label: "Creator", type: "text" },
                { key: "url", label: "URL", type: "text" },
                { key: "doi", label: "DOI", type: "text" },
                { key: "sphere", label: "Sphere", type: "text" },
                { key: "public_access", label: "Public Access", type: "boolean" },
                { key: "public_tags", label: "Public Tags", type: "boolean" },
                { key: "creation_date", label: "Created", type: "text", readonly: true },
                { key: "description", label: "Description", type: "richtext", hiddenInTable: true }
            ]
        },
        site: {
            label: "Sites",
            icon: "map-pin",
            pk: "id", // 对应 currentSites 中的 id
            columns: [
                { key: "id", label: "Site ID", type: "text", readonly: true },
                { key: "name", label: "Site Name", type: "text" },
                { key: "realm", label: "Realm", type: "text" },
                { key: "biome", label: "Biome", type: "text" },
                { key: "group", label: "Group", type: "text" },
                { key: "topography_m", label: "Elevation (m)", type: "number" },
                { key: "mediaCount", label: "Media Count", type: "number", readonly: true }
            ]
        },
        media: {
            label: "Media Files",
            icon: "file-audio",
            pk: "id", // 对应 mediaItems 中的 id
            columns: [
                { key: "id", label: "ID", type: "number", readonly: true },
                { key: "name", label: "Filename", type: "text" },
                { key: "site", label: "Site Name", type: "text" },
                { key: "date", label: "Date", type: "text" },
                { key: "duration", label: "Duration", type: "text" },
                { key: "sensor", label: "Sensor", type: "text" },
                { key: "size", label: "Size", type: "text" }
            ]
        },
        "user": {
            label: "Contributors",
            icon: "users",
            pk: "uid", // 对应 contributors 中的 uid
            columns: [
                { key: "uid", label: "ORCID / ID", type: "text", readonly: true },
                { key: "name", label: "Name", type: "text" },
                { key: "email", label: "Email", type: "text" },
                { key: "role", label: "Role", type: "text" }
            ]
        },
        sensor: {
            label: "Sensors (Ref)",
            icon: "cpu",
            pk: "sensor_id",
            columns: [
                { key: "sensor_id", label: "ID", type: "number", readonly: true },
                { key: "name", label: "Model Name", type: "text" },
                { key: "sensor_type", label: "Type", type: "select", options: ["audio", "photo"] }
            ]
        },
        project_contributor: {
            label: "Proj. Contributors",
            itemLabel: "Contribution",
            icon: "user-cog",
            pk: "id", // 前端模拟使用合成主键
            columns: [
                { key: "id", label: "ID", type: "text", readonly: true, hiddenInTable: true },
                { key: "project_id", label: "Project ID", type: "number" },
                { key: "user_id", label: "User", type: "select", options: mockNames }, // 复用 mockNames 模拟外键关联 User
                { key: "contribution_role", label: "Role", type: "text" }, // PI, Technician, etc.
                { key: "added_date", label: "Date Added", type: "text", readonly: true }
            ]
        }
    };

    let currentTable = "project";
    let crudSearchQuery = "";
    let editingId = null;
    let selectedCrudIds = [];
    let sortState = { key: null, direction: 'asc' };

    // 静态 Mock 数据用于 Sensors 等通用表
    const staticMockDB = {
        sensor: [
            { sensor_id: 1, name: "AudioMoth v1.2", sensor_type: "audio" },
            { sensor_id: 2, name: "Song Meter Micro", sensor_type: "audio" },
            { sensor_id: 3, name: "GoPro Hero 10", sensor_type: "photo" }
        ]
    };

    // --- 新增辅助函数开始 ---
    let currentEditorTargetId = null;

    function handleFileChange(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                input.setAttribute('data-base64', e.target.result);
                // 更新逻辑：通过ID查找预览容器
                const previewId = input.id + '-preview';
                const previewEl = document.getElementById(previewId);
                if (previewEl) {
                    previewEl.innerHTML = `<img src="${e.target.result}" style="height:32px; border-radius:4px; border:1px solid var(--border-color); vertical-align:middle;">`;
                }
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function openEditorForInput(inputId) {
        currentEditorTargetId = inputId;
        const currentVal = document.getElementById(inputId).value;
        const textarea = document.getElementById('editor-textarea');
        textarea.value = currentVal;
        document.getElementById('editor-modal-overlay').classList.add('active');
    }

    function closeEditorModal() {
        document.getElementById('editor-modal-overlay').classList.remove('active');
        currentEditorTargetId = null;
    }

    function saveEditorContent() {
        if (currentEditorTargetId) {
            const val = document.getElementById('editor-textarea').value;
            document.getElementById(currentEditorTargetId).value = val;
            const preview = document.getElementById(currentEditorTargetId + '-preview');
            // 简单去除HTML标签显示预览
            const textContent = val.replace(/<[^>]*>?/gm, '');
            if(preview) preview.textContent = textContent.substring(0, 40) + (textContent.length>40 ? '...' : '');
        }
        closeEditorModal();
    }
    // --- 新增辅助函数结束 ---

    // 核心函数：根据当前上下文动态获取表格数据
    function getDataForTable(tableName) {
        const currentProject = rawProjects[currProjIdx];

        if (tableName === 'project') {
            return rawProjects.map(p => {
                const stripHtml = (html) => {
                    let tmp = document.createElement("DIV");
                    tmp.innerHTML = html;
                    return tmp.textContent || tmp.innerText || "";
                };
                return {
                    project_id: p.id,
                    uuid: `550e8400-e29b-41d4-a716-${String(p.id).padStart(12, '0')}`,
                    name: p.name,
                    creator_name: p.creator,
                    url: p.externalUrl || "https://example.com",
                    picture_url: p.image,
                    description: p.description,
                    description_short: p.description, // 用于编辑和列表
                    doi: p.doi,
                    public: true,
                    active: true,
                    creation_date: p.date
                };
            });
        }
        else if (tableName === 'collection') {
            return currentProject.collections.map((c, i) => ({
                collection_id: i + 1,
                uuid: `c-${currentProject.id}-${i}-${Date.now()}`,
                name: c.name,
                creator_id: c.creator,
                doi: c.doi,
                description: c.description,
                sphere: c.sphere || "Biosphere",
                url: c.url || "",
                public_access: c.active !== undefined ? c.active : false,
                public_tags: false,
                creation_date: c.date
            }));
        }
        else if (tableName === 'site') {
            // 返回 Map 页面正在使用的 Sites 数据
            return currentSites;
        }
        else if (tableName === 'media') {
            // 返回 Media 页面正在使用的 Media 数据
            // 注意：Media Tab 生成数据时可能没有 enriched，这里确保数据字段完整
            if(mediaItems.length > 0 && !mediaItems[0].enriched) {
                enrichMediaData();
            }
            return mediaItems;
        }
        else if (tableName === 'user') {
            // 返回当前项目或集合的贡献者
            if (currColIdx > 0) {
                return currentProject.collections[currColIdx - 1].contributors;
            }
            return currentProject.contributors;
        }
        else {
            // 对于 sensor 等通用数据，使用静态 Mock
            return staticMockDB[tableName] || [];
        }
    }

    function initDataTab() {
        // 如果是从别的 Tab 切过来，重置到当前项目视图
        switchCrudTable('project');
    }

    function renderTableNav() {
        const navList = document.getElementById('table-nav-list');
        let html = "";
        Object.keys(dbSchema).forEach(key => {
            const table = dbSchema[key];
            const isActive = currentTable === key ? 'active' : '';

            // 动态获取当前数量
            const data = getDataForTable(key);
            const count = data ? data.length : 0;

            html += `
                <div class="dt-item ${isActive}" onclick="switchCrudTable('${key}')">
                    <span style="display:flex; align-items:center; gap:8px;">
                        <i data-lucide="${table.icon}" size="16"></i> ${table.label}
                    </span>
                    <span class="dt-count">${count}</span>
                </div>
            `;
        });
        navList.innerHTML = html;
        lucide.createIcons();
    }


    function switchCrudTable(tableName) {
        currentTable = tableName;
        crudSearchQuery = "";

        selectedCrudIds = [];
        updateToolbarState();

        const searchInput = document.getElementById('data-search-input');
        if (searchInput) {
            searchInput.value = "";
            searchInput.placeholder = "Search";
        }

        const schema = dbSchema[tableName];
        const firstColKey = schema.columns[0].key;
        sortState = {key: firstColKey, direction: 'asc'};

        crudFilterState = {};

        renderTableNav();
        renderCrudHeader();
        renderCrudTable();
    }

    function handleDataSearch(val) {
        crudSearchQuery = val.toLowerCase();
        renderCrudTable();
    }


    function handleSort(key) {
        if (sortState.key === key) {

            sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
        } else {

            sortState.key = key;
            sortState.direction = 'asc';
        }
        renderCrudHeader();
        renderCrudTable();
    }


    function handleColumnFilter(key, value) {
        if (value === "" || value === "all") {
            delete crudFilterState[key];
        } else {
            crudFilterState[key] = value;
        }
        renderCrudTable();
    }


    function renderCrudHeader() {
        const schema = dbSchema[currentTable];
        const thead = document.getElementById('crud-thead');

        let headHtml = "<tr>";


        headHtml += `
            <th style="width: 40px; text-align:center; vertical-align:top; padding-top:14px;">
                <input type="checkbox" class="crud-checkbox" id="header-select-all"
                onclick="handleSelectAll(this.checked)">
            </th>`;


        schema.columns.forEach(col => {
            if (col.hiddenInTable) return;

            const isSorted = sortState.key === col.key;
            const sortIcon = isSorted ? (sortState.direction === 'asc' ? 'arrow-up' : 'arrow-down') : 'arrow-up-down';
            const activeClass = isSorted ? 'active-sort' : '';
            const iconOpacity = isSorted ? '1' : '0.3';

            let filterInputHtml = '';
            const currentFilterVal = crudFilterState[col.key] || "";

            if (col.type === 'boolean') {
                filterInputHtml = `<select class="th-filter-input" onchange="handleColumnFilter('${col.key}', this.value)" onclick="event.stopPropagation()"><option value="all">All</option><option value="true" ${currentFilterVal === 'true' ? 'selected' : ''}>True</option><option value="false" ${currentFilterVal === 'false' ? 'selected' : ''}>False</option></select>`;
            } else if (col.type === 'select' && col.filterType !== 'text') { // 修改：增加 filterType 检查
                let opts = `<option value="all">All</option>`;
                if(col.options) {
                    col.options.forEach(o => {
                        opts += `<option value="${o}" ${currentFilterVal === o ? 'selected' : ''}>${o}</option>`;
                    });
                }
                filterInputHtml = `<select class="th-filter-input" onchange="handleColumnFilter('${col.key}', this.value)" onclick="event.stopPropagation()">${opts}</select>`;
            } else if (col.type === 'file' || col.type === 'image' || col.type === 'richtext') {
                filterInputHtml = '';
            } else {
                filterInputHtml = `<input type="text" class="th-filter-input" placeholder="Filter..." value="${currentFilterVal}" oninput="handleColumnFilter('${col.key}', this.value)" onclick="event.stopPropagation()">`;
            }

            headHtml += `
                <th style="min-width: 140px;">
                    <div class="th-header-content ${activeClass}" onclick="handleSort('${col.key}')">
                        <span>${col.label}</span>
                        <i data-lucide="${sortIcon}" size="14" style="opacity:${iconOpacity}"></i>
                    </div>
                    ${filterInputHtml ? `<div class="th-filter-box">${filterInputHtml}</div>` : ''}
                </th>`;
        });
        headHtml += `</tr>`;
        thead.innerHTML = headHtml;
        lucide.createIcons();
    }


    function renderCrudTable() {
        const schema = dbSchema[currentTable];
        // 修改点：使用动态数据源
        const rawData = getDataForTable(currentTable);

        const tbody = document.getElementById('crud-tbody');
        const titleEl = document.getElementById('current-table-title');

        titleEl.innerHTML = `<i data-lucide="${schema.icon}"></i> ${schema.label}`;


        let processedData = rawData.filter(row => {
            const matchesGlobal = !crudSearchQuery || Object.values(row).some(v => String(v).toLowerCase().includes(crudSearchQuery));
            if (!matchesGlobal) return false;
            return Object.keys(crudFilterState).every(key => {
                const filterVal = crudFilterState[key].toLowerCase();
                const rowVal = String(row[key] !== undefined ? row[key] : "").toLowerCase();
                if (filterVal === 'true' || filterVal === 'false') return rowVal === filterVal;
                return rowVal.includes(filterVal);
            });
        });


        if (sortState.key) {
            processedData.sort((a, b) => {
                let valA = a[sortState.key], valB = b[sortState.key];
                if (valA === null || valA === undefined) valA = "";
                if (valB === null || valB === undefined) valB = "";
                if (typeof valA === 'number' && typeof valB === 'number') return sortState.direction === 'asc' ? valA - valB : valB - valA;
                valA = String(valA).toLowerCase();
                valB = String(valB).toLowerCase();
                if (valA < valB) return sortState.direction === 'asc' ? -1 : 1;
                if (valA > valB) return sortState.direction === 'asc' ? 1 : -1;
                return 0;
            });
        }


        let bodyHtml = "";
        const visibleCols = schema.columns.filter(c => !c.hiddenInTable);

        if (processedData.length === 0) {
            bodyHtml = `<tr><td colspan="${visibleCols.length + 1}" style="text-align:center; padding:40px; color:var(--text-muted); font-style:italic;">No results found</td></tr>`;
        } else {
            processedData.forEach(row => {
                const pk = schema.pk;
                const isSelected = selectedCrudIds.includes(row[pk]);
                const rowClass = isSelected ? 'selected' : '';

                bodyHtml += `<tr class="${rowClass}" ondblclick="openCrudModal('edit', '${row[pk]}')">`;
                bodyHtml += `
                    <td style="text-align:center; border-bottom:1px solid var(--border-color);">
                        <input type="checkbox" class="crud-checkbox" ${isSelected ? 'checked' : ''}
                        onclick="event.stopPropagation(); toggleRowSelection('${row[pk]}')">
                    </td>`;

                visibleCols.forEach(col => {
                    let val = row[col.key];
                    if (val === undefined || val === null) val = "";

                    if (currentTable === 'project' && col.key === 'project_id') {
                        const currentProjId = rawProjects[currProjIdx] ? rawProjects[currProjIdx].id : null;
                        if (row.project_id === currentProjId) {
                            val = `<span style="display:flex; align-items:center; gap:8px;">
                                    ${val}
                                    <span style="background:var(--brand); color:white; padding:2px 8px; border-radius:12px; font-size:0.7rem; font-weight:700; box-shadow:0 2px 5px rgba(131,205,32,0.3);">Current</span>
                                   </span>`;
                        }
                    }
                    if (col.type === 'image' || col.type === 'file') {
                        val = `<img src="${val}" style="width:40px; height:40px; object-fit:cover; border-radius:6px; border:1px solid var(--border-color);" alt="img" onerror="this.style.display='none'">`;
                    }
                    if (col.type === 'boolean') {
                        val = val ? `<span class="status-badge status-true">True</span>` : `<span class="status-badge status-false">False</span>`;
                    }
                    if (col.type === 'richtext') {
                        // 移除 HTML 标签并截断
                        const text = String(val).replace(/<[^>]*>?/gm, '');
                        val = `<span style="opacity:0.8; font-size:0.85rem;" title="${text}">${text.substring(0, 30)}${text.length > 30 ? '...' : ''}</span>`;
                    }

                    bodyHtml += `<td>${val}</td>`;
                });
                bodyHtml += `</tr>`;
            });
        }
        tbody.innerHTML = bodyHtml;
        lucide.createIcons();


        updateHeaderCheckbox(processedData);


        window.currentVisibleData = processedData;
    }


    function updateHeaderCheckbox(visibleData) {
        const checkbox = document.getElementById('header-select-all');
        if (!checkbox) return;

        if (visibleData.length === 0) {
            checkbox.checked = false;
            checkbox.indeterminate = false;
            return;
        }

        const visibleIds = visibleData.map(d => d[dbSchema[currentTable].pk]);

        const selectedCount = visibleIds.filter(id => selectedCrudIds.includes(id)).length;

        if (selectedCount === 0) {
            checkbox.checked = false;
            checkbox.indeterminate = false;
        } else if (selectedCount === visibleIds.length) {
            checkbox.checked = true;
            checkbox.indeterminate = false;
        } else {
            checkbox.checked = false;
            checkbox.indeterminate = true;
        }
    }


    function toggleRowSelection(id) {
        const idx = selectedCrudIds.indexOf(id);
        if (idx > -1) {
            selectedCrudIds.splice(idx, 1);
        } else {
            selectedCrudIds.push(id);
        }
        renderCrudTable();
        updateToolbarState();
    }


    window.handleSelectAll = function (checked) {
        const schema = dbSchema[currentTable];
        const data = window.currentVisibleData || [];

        if (checked) {

            data.forEach(row => {
                const id = row[schema.pk];
                if (!selectedCrudIds.includes(id)) selectedCrudIds.push(id);
            });
        } else {

            const visibleIds = new Set(data.map(r => r[schema.pk]));
            selectedCrudIds = selectedCrudIds.filter(id => !visibleIds.has(id));
        }
        renderCrudTable();
        updateToolbarState();
    };


    function updateToolbarState() {
        const editBtn = document.getElementById('btn-edit');
        const delBtn = document.getElementById('btn-delete');
        const count = selectedCrudIds.length;


        if (editBtn) editBtn.disabled = (count !== 1);


        if (delBtn) delBtn.disabled = (count === 0);
    }


    function handleToolbarEdit() {
        if (selectedCrudIds.length === 1) {
            openCrudModal('edit', selectedCrudIds[0]);
        }
    }


    function handleToolbarDelete() {
        if (selectedCrudIds.length > 0) {
            openDeleteModal();
        }
    }


    function openDeleteModal() {
        const modal = document.getElementById('crud-modal-overlay');
        const container = document.getElementById('modal-form-container');
        const title = document.getElementById('modal-title');
        const submitBtn = document.getElementById('modal-submit-btn');

        const schema = dbSchema[currentTable];
        // 修改：优先使用单数名称 itemLabel
        const itemName = schema.itemLabel || schema.label.slice(0, -1);
        title.textContent = `Delete ${itemName}`;

        const count = selectedCrudIds.length;

        container.innerHTML = `
            <div style="padding: 10px 0; font-size: 1rem; color: var(--text-secondary); line-height: 1.5;">
                <div style="margin-bottom:8px;">Are you sure you want to delete <strong style="color:var(--text-main)">${count}</strong> selected item(s)?</div>
                <div style="font-size:0.85rem; color:#ef4444; font-weight:600;"><i data-lucide="alert-triangle" size="14" style="vertical-align:text-bottom"></i> This action cannot be undone.</div>
            </div>
        `;
        lucide.createIcons();


        if (submitBtn) {
            submitBtn.textContent = "Delete";
            submitBtn.style.backgroundColor = "#ef4444";
            submitBtn.onclick = confirmDeleteData;
        }

        modal.classList.add('active');
    }


    function confirmDeleteData() {
        const pk = dbSchema[currentTable].pk;
        const currentData = getDataForTable(currentTable);

        // 找出需要保留的元素（这是一个简化的删除，实际上如果引用的 array 是 rawProjects 的属性，这样做可能无法重新赋值回去，
        // 但由于 JS 数组引用特性，splice 是更好的选择）

        // 从后往前遍历删除，避免索引错位
        for (let i = currentData.length - 1; i >= 0; i--) {
            if (selectedCrudIds.includes(currentData[i][pk])) {
                currentData.splice(i, 1);
            }
        }

        selectedCrudIds = [];
        renderTableNav();
        renderCrudTable();
        updateToolbarState();
        closeCrudModal();

        // 联动刷新
        if (currentTable === 'site' && map) renderMap(false);
    }

    function openCrudModal(mode, id = null) {
        const schema = dbSchema[currentTable];
        const modal = document.getElementById('crud-modal-overlay');
        const container = document.getElementById('modal-form-container');
        const title = document.getElementById('modal-title');
        const submitBtn = document.getElementById('modal-submit-btn');

        if (submitBtn) {
            // 统一使用 "Save"，适用于新增和编辑
            submitBtn.textContent = "Save";
            submitBtn.style.backgroundColor = "";
            submitBtn.onclick = saveCrudData;
        }

        editingId = id;
        const itemName = schema.itemLabel || schema.label.slice(0, -1);
        title.textContent = mode === 'edit' ? `Edit ${itemName}` : `New ${itemName}`;

        let currentRow = {};
        if (mode === 'edit') {
            const currentData = getDataForTable(currentTable);
            currentRow = currentData.find(r => r[schema.pk] == id) || {};
        }

        let formHtml = "";
        schema.columns.forEach(col => {
            if (col.readonly && mode === 'add') return;

            const val = mode === 'edit' ? (currentRow[col.key] !== undefined ? currentRow[col.key] : "") : "";
            const disabled = (col.readonly && mode === 'edit') ? "disabled style='opacity:0.6; cursor:not-allowed'" : "";

            formHtml += `<div class="form-group"><label class="form-label">${col.label}</label>`;

            if (col.type === 'select') {
                formHtml += `<select class="form-input" id="input-${col.key}" ${disabled}>`;
                // 添加默认空选项
                formHtml += `<option value="">Select...</option>`;
                if (col.options) {
                    col.options.forEach(opt => {
                        const selected = val === opt ? 'selected' : '';
                        formHtml += `<option value="${opt}" ${selected}>${opt}</option>`;
                    });
                }
                formHtml += `</select>`;
            } else if (col.type === 'boolean') {
                formHtml += `<select class="form-input" id="input-${col.key}" ${disabled}>
                    <option value="true" ${val === true ? 'selected' : ''}>True</option>
                    <option value="false" ${val === false ? 'selected' : ''}>False</option>
                </select>`;
            } else if (col.type === 'file') {
                formHtml += `<div style="display:flex; gap:10px; align-items:center;">
                    <input type="file" id="input-${col.key}" onchange="handleFileChange(this)" ${disabled} style="display:none;">
                    <button class="btn-secondary" onclick="document.getElementById('input-${col.key}').click()" style="height:32px; font-size:0.8rem;">Upload File</button>
                    <span id="input-${col.key}-preview">
                        ${val ? `<img src="${val}" style="height:32px; border-radius:4px; border:1px solid var(--border-color); vertical-align:middle;">` : '<span style="font-size:0.8rem; color:var(--text-muted);">No file selected</span>'}
                    </span>
                </div>`;
            } else if (col.type === 'richtext') {
                const safeVal = String(val).replace(/'/g, "&apos;");
                const textPreview = String(val).replace(/<[^>]*>?/gm, '');
                formHtml += `
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="hidden" id="input-${col.key}" value='${safeVal}'>
                        <button class="btn-secondary" onclick="openEditorForInput('input-${col.key}')" style="height:32px; font-size:0.8rem;">Edit Content</button>
                        <span id="input-${col.key}-preview" style="font-size:0.8rem; color:var(--text-muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:200px;">
                            ${textPreview.substring(0, 30)}...
                        </span>
                    </div>
                `;
            } else {
                formHtml += `<input type="text" class="form-input" id="input-${col.key}" value="${val}" ${disabled}>`;
            }
            formHtml += `</div>`;
        });

        container.innerHTML = formHtml;
        modal.classList.add('active');
    }

    function closeCrudModal() {
        document.getElementById('crud-modal-overlay').classList.remove('active');
    }

    function saveCrudData() {
        const schema = dbSchema[currentTable];
        let newRow = {};

        const isProject = currentTable === 'project';
        const isCollection = currentTable === 'collection';

        const currentData = getDataForTable(currentTable);
        let existingRow = null;
        if (editingId !== null) {
            existingRow = currentData.find(r => r[schema.pk] == editingId);
        }

        schema.columns.forEach(col => {
            if (col.readonly && editingId === null) return;

            const input = document.getElementById(`input-${col.key}`);
            if (!input && col.type !== 'file' && col.type !== 'richtext') return;

            let val = input ? input.value : "";

            if (col.type === 'number') val = Number(val);
            if (col.type === 'boolean') val = (val === 'true');

            if (col.type === 'file') {
                const fileInput = document.getElementById(`input-${col.key}`);
                const base64 = fileInput ? fileInput.getAttribute('data-base64') : null;
                if (base64) {
                    val = base64;
                } else if (existingRow) {
                    val = existingRow[col.key];
                } else {
                    val = "";
                }
            }

            if (col.type === 'richtext') {
               const hiddenInput = document.getElementById(`input-${col.key}`);
               if (hiddenInput) val = hiddenInput.value;
            }

            newRow[col.key] = val;
        });

        if (isProject) {
            const mappedProject = {
                id: newRow.project_id,
                name: newRow.name,
                creator: newRow.creator_name,
                externalUrl: newRow.url,
                image: newRow.picture_url,
                description: newRow.description,
                doi: newRow.doi,
                date: newRow.creation_date
            };

            if (editingId !== null) {
                const target = rawProjects.find(p => p.id == editingId);
                if (target) {
                    Object.assign(target, mappedProject);
                    if (editingId == rawProjects[currProjIdx].id) {
                         updateContent(target, true);
                    }
                }
            } else {
                if(rawProjects.length > 0) {
                    mappedProject.id = Math.max(...rawProjects.map(p=>p.id)) + 1;
                } else {
                    mappedProject.id = 1;
                }
                mappedProject.collections = [];
                mappedProject.stats = {users:0, collections:0, audio:"0", photos:0, videos:0, metadata:"0", tags:0, sites:0};
                mappedProject.contributors = [];
                if(!mappedProject.date) mappedProject.date = new Date().toISOString().split('T')[0];
                rawProjects.push(mappedProject);
            }
            renderProjectList();
        } else if (isCollection) {
            const proj = rawProjects[currProjIdx];

            const mappedCol = {
                 name: newRow.name,
                 creator: newRow.creator_id,
                 doi: newRow.doi,
                 sphere: newRow.sphere,
                 url: newRow.url,
                 description: newRow.description,
                 active: newRow.public_access,
                 date: newRow.creation_date || new Date().toISOString().split('T')[0]
            };

            if (editingId !== null) {
                 const colIndex = editingId - 1;
                 if (proj.collections[colIndex]) {
                     Object.assign(proj.collections[colIndex], mappedCol);
                 }
            } else {
                 mappedCol.id = `c${proj.collections.length + Date.now()}`;
                 mappedCol.stats = {users:0, projects:1, audio:0, photos:0, videos:0, metadata:0, tags:0, sites:0};
                 mappedCol.contributors = [];
                 proj.collections.push(mappedCol);
            }
            renderCollectionList();
        } else {
            if (editingId !== null) {
                const idx = currentData.findIndex(r => r[schema.pk] == editingId);
                if (idx !== -1) {
                    Object.assign(currentData[idx], newRow);
                }
            } else {
                if (currentData.length > 0 && typeof currentData[0][schema.pk] === 'number') {
                     const maxId = currentData.reduce((max, r) => Math.max(max, r[schema.pk] || 0), 0);
                     newRow[schema.pk] = maxId + 1;
                } else {
                    newRow[schema.pk] = `new-${Date.now()}`;
                }
                currentData.push(newRow);
            }
        }

        if (currentTable === 'site' && map) {
             renderMap(false);
        }

        renderTableNav();
        renderCrudTable();
        closeCrudModal();
    }

    function resetDataTable() {
        crudSearchQuery = "";
        crudFilterState = {};
        sortState = {key: null, direction: 'asc'};
        selectedCrudIds = [];
        updateToolbarState();

        const searchInput = document.getElementById('data-search-input');
        if (searchInput) searchInput.value = "";

        renderCrudHeader();
        renderCrudTable();
    }

    const originalSwitchTab = window.switchTab;
    window.switchTab = function (btn, tabName) {
        originalSwitchTab(btn, tabName);
        if (tabName === 'data') {
            initDataTab();
        }
    };
    init();
</script>
</body>

</html>