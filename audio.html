<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>ecoSignal | Audio Detail</title>

    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="project.css" rel="stylesheet">
    <style>
        .player-toolbar-top .btn-toolbar,
        .player-toolbar-bottom .btn-toolbar {
            border-color: transparent;
            box-shadow: none;
        }

        /* 新增：工具栏按钮被选中时的状态 */
        .player-toolbar-bottom .btn-toolbar.active {
            background: var(--brand) !important;
            color: white !important;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15) !important;
        }
        .player-toolbar-bottom .btn-toolbar.active i {
            color: white !important;
        }

        /* 声道切换按钮的默认样式 */
        .channel-btn {
            background: transparent;
            color: var(--text-secondary);
            border: none;
            border-radius: 50px;
            padding: 0 14px;
            height: 100%;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        /* 悬停时文字变亮 */
        .channel-btn:hover {
            color: var(--text-main);
        }
        /* 选中时的激活样式 */
        .channel-btn.active {
            background: var(--brand) !important;
            color: white !important;
            font-weight: 700;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
    </style>
    <script src="data.js"></script>
</head>
<body>

<nav class="project-nav-bar">
    <div class="nav-left">
        <div class="nav-capsule-box">
            <a class="nav-logo" href="index.html">
                <div class="logo-icon-box"><i data-lucide="activity"></i></div>
                <span>ecoSignal</span>
            </a>
            <div class="nav-divider"></div>

            <div class="breadcrumb-group">
                <div class="crumb-wrapper" id="project-wrap">
                    <button class="crumb-btn" onclick="toggleMenu('project-wrap')">
                        <span class="block-anim" id="label-project">Loading...</span>
                        <i data-lucide="chevron-down" size="14"></i>
                    </button>
                    <div class="crumb-dropdown" id="dropdown-project">
                        <div class="dropdown-search-box">
                            <div class="search-input-wrapper">
                                <i class="search-icon-small" data-lucide="search"></i>
                                <input class="dropdown-input" onclick="event.stopPropagation()" oninput="handleSearchProject(this.value)" placeholder="Search Project..." type="text">
                            </div>
                        </div>
                        <div class="dropdown-list-scroll" id="project-list-container"></div>
                    </div>
                </div>

                <span class="crumb-separator">/</span>

                <div class="crumb-wrapper" id="collection-wrap">
                    <button class="crumb-btn" onclick="toggleMenu('collection-wrap')">
                        <span class="block-anim" id="label-collection">Loading...</span>
                        <i data-lucide="chevron-down" size="14"></i>
                    </button>
                    <div class="crumb-dropdown" id="dropdown-collection">
                        <div class="dropdown-search-box">
                            <div class="search-input-wrapper">
                                <i class="search-icon-small" data-lucide="search"></i>
                                <input class="dropdown-input" onclick="event.stopPropagation()" oninput="handleSearchCollection(this.value)" placeholder="Search Collection..." type="text">
                            </div>
                        </div>
                        <div class="dropdown-list-scroll" id="collection-list-container"></div>
                    </div>
                </div>

                <span class="crumb-separator">/</span>

                <div class="crumb-wrapper" id="audio-wrap">
                    <button class="crumb-btn" onclick="toggleMenu('audio-wrap')">
                        <span class="block-anim" id="label-audio">Loading...</span>
                        <i data-lucide="chevron-down" size="14"></i>
                    </button>
                    <div class="crumb-dropdown" id="dropdown-audio">
                        <div class="dropdown-search-box">
                            <div class="search-input-wrapper">
                                <i class="search-icon-small" data-lucide="search"></i>
                                <input class="dropdown-input" onclick="event.stopPropagation()" oninput="handleSearchAudio(this.value)" placeholder="Search Audio..." type="text">
                            </div>
                        </div>
                        <div class="dropdown-list-scroll" id="audio-list-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="nav-center"></div>

    <div class="nav-right">
        <div class="nav-capsule-box">
            <button class="nav-btn-simple" onclick="toggleTheme()" title="Switch Theme">
                <i data-lucide="moon" id="theme-icon-el" size="20"></i>
            </button>
            <div class="nav-divider"></div>
            <button class="nav-btn-simple" title="Information"><i data-lucide="info" size="20"></i></button>
            <div class="nav-divider"></div>
            <div class="user-wrapper" id="user-menu">
                <div class="user-capsule-btn" onclick="toggleUserMenu()">
                    <div class="user-avatar-icon"><i data-lucide="user" size="16"></i></div>
                    <span class="user-name-text">Liudilong</span>
                    <i class="chevron-icon" data-lucide="chevron-down" size="14"></i>
                </div>
                <div class="dropdown-menu">
                    <a class="dropdown-item" href="project.html"><i data-lucide="layout-dashboard" size="18"></i>Dashboard</a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="setting.html"><i data-lucide="settings" size="18"></i> Settings</a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item danger" href="index.html"><i data-lucide="log-out" size="18"></i>Logout</a>
                </div>
            </div>
        </div>
    </div>
</nav>
<div class="content-wrapper" style="top: var(--nav-height); padding: 0; height: calc(100vh - var(--nav-height)); display: flex; flex-direction: column;">

    <div class="audio-studio-container" style="background: var(--bg-surface); display: flex; flex-direction: row; flex: 1; overflow: hidden;">

        <div class="studio-main-section" style="flex: 1; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); overflow: hidden;">

            <div class="player-section" style="display: flex; flex-direction: column; padding: 12px 16px; border-bottom: 1px solid var(--border-color); gap: 8px; flex-shrink: 0;">

                <div class="player-toolbar-top" style="display: flex; gap: 8px; align-items: center;">

                    <button class="btn-toolbar" style="padding: 4px 8px; color: var(--brand);" title="Select Tool"><i data-lucide="mouse-pointer-2" size="14"></i></button>
                    <button class="btn-toolbar" style="padding: 4px 8px;" title="Draw Bounding Box"><i data-lucide="crosshair" size="14"></i></button>

                    <span style="width: 1px; height: 14px; background: var(--border-color); margin: 0 4px;"></span>

                    <button class="btn-toolbar" disabled style="padding: 4px 8px;" title="Pan Left (Previous Time Segment)"><i data-lucide="chevron-left" size="14"></i></button>
                    <button class="btn-toolbar" disabled style="padding: 4px 8px;" title="Pan Right (Next Time Segment)"><i data-lucide="chevron-right" size="14"></i></button>

                    <span style="width: 1px; height: 14px; background: var(--border-color); margin: 0 4px;"></span>

                    <button class="btn-toolbar" style="padding: 4px 8px;" title="Zoom In Proportionally"><i data-lucide="zoom-in" size="14"></i></button>
                    <button class="btn-toolbar" style="padding: 4px 8px;" title="Zoom Out"><i data-lucide="zoom-out" size="14"></i></button>
                    <button class="btn-toolbar" style="padding: 4px 8px;" title="Zoom by px/s"><i data-lucide="stretch-horizontal" size="14"></i></button>

                    <span style="margin-left: auto; font-family: monospace; font-size: 0.75rem; color: var(--text-main);">00:00:00 / 00:05:00</span>
                </div>

                <div class="player-middle" style="display: flex; gap: 8px; height: 400px;">

                    <div class="spectrogram-viewport" id="spectrogram-viewport" style="flex: 1; height: 100%; background-color: #1e1e1e; background-image: url('https://ecosound-web.de/ecosound_web/tmp/47877828/10005255_f7644c9a13d31622281088363recording_f1d6c506_897f_4c5e_8ca9_fe2ab93fef312421328162956812056_1-22050_0-59.8954__1.png'); background-size: 100% 100%; background-repeat: no-repeat; border-radius: 4px; position: relative; overflow: hidden; box-shadow: inset 0 0 10px rgba(0,0,0,0.5);">

                        <div id="annotations-layer" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 5;"></div>

                        <div style="position: absolute; left: 25%; top: 0; bottom: 0; width: 1px; background: rgba(239, 68, 68, 0.8); box-shadow: 0 0 4px rgba(239, 68, 68, 0.5); pointer-events: none; z-index: 10;"></div>
                    </div>
                </div>
                <div class="player-toolbar-bottom" style="display: flex; gap: 12px; align-items: center; margin-top: 4px;">

                    <div style="display: flex; gap: 4px;">
                        <button class="btn-toolbar" id="btn-play-toggle" style="padding: 4px 8px;" title="Play" onclick="togglePlayState()">
                            <i data-lucide="play" size="14"></i>
                        </button>
                        <button class="btn-toolbar" style="padding: 4px 8px;" title="Stop" onclick="stopPlayState()">
                            <i data-lucide="square" size="14"></i>
                        </button>
                    </div>

                    <span style="width: 1px; height: 12px; background: var(--border-color);"></span>

                    <button class="btn-toolbar" style="padding: 4px 8px;" title="Auto-advance to next segment" onclick="this.classList.toggle('active')"><i data-lucide="arrow-right-from-line" size="14"></i></button>

                    <button class="btn-toolbar" style="padding: 4px 8px;" title="Toggle Full Band / Filtered Frequency" onclick="this.classList.toggle('active')"><i data-lucide="filter" size="14"></i></button>

                    <span style="width: 1px; height: 12px; background: var(--border-color);"></span>

                    <div style="display: flex; align-items: center; gap: 8px;" title="Playback Speed">
                        <i data-lucide="gauge" size="14" style="color: var(--text-muted);"></i>

                        <input type="range" min="0.05" max="1" step="0.01" value="1"
                               style="width: 140px; height: 8px; cursor: pointer; accent-color: var(--brand); border-radius: 4px; background: var(--border-color); border: none; outline: none; box-shadow: none; -webkit-tap-highlight-color: transparent;"
                               oninput="this.nextElementSibling.innerText = Number(this.value).toFixed(2) + 'x'">

                        <span style="font-size: 0.75rem; color: var(--text-main); font-family: monospace; font-weight: 600; width: 38px; text-align: right;">1.00x</span>
                    </div>

                    <div style="flex: 1;"></div>

                    <div id="channel-control-container" style="display: flex; align-items: center;"></div>

                </div>
            </div>

            <div class="studio-bottom-section" style="flex: 1; display: flex; flex-direction: row; overflow: hidden; background: var(--bg-surface);">

                <div class="table-side-toolbar" style="display: flex; flex-direction: column; gap: 8px; padding: 16px 8px; border-right: 1px solid var(--border-color); background: var(--bg-body); flex-shrink: 0; align-items: center;">

                    <button class="btn-toolbar" onclick="resetFilters()" title="Reset Filters" style="padding: 8px; justify-content: center;">
                        <i data-lucide="rotate-ccw" size="16"></i>
                    </button>

                    <div style="width: 24px; height: 1px; background: var(--border-color); margin: 6px 0; border-radius: 1px; opacity: 0.8;"></div>

                    <div style="display: flex; flex-direction: column; gap: 12px; width: 100%;">
                        <button class="btn-toolbar" disabled id="btn-assign" title="Assign Task" style="padding: 8px; justify-content: center;">
                            <i data-lucide="clipboard-list" size="16"></i>
                        </button>

                        <button class="btn-toolbar danger" disabled id="btn-delete" title="Delete Selected" style="padding: 8px; justify-content: center;">
                            <i data-lucide="trash-2" size="16"></i>
                        </button>
                    </div>

                    <div style="flex: 1;"></div>

                    <button class="btn-toolbar" id="btn-export-csv" title="Export CSV" style="padding: 8px; justify-content: center;">
                        <i data-lucide="download" size="16"></i>
                    </button>

                </div>

                <div class="data-table-container" style="flex: 1; overflow: auto;">
                    <table class="crud-table">
                        <thead id="crud-thead"></thead>
                        <tbody id="crud-tbody"></tbody>
                    </table>
                </div>
            </div>

        </div>

        <div class="info-section" style="width: 280px; padding: 16px; display: flex; flex-direction: column; gap: 16px; background: var(--bg-body); flex-shrink: 0; overflow-y: auto;">
            <div style="font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                <i data-lucide="info" size="16"></i> Recording Info
            </div>
            <div style="display: flex; flex-direction: column; gap: 12px; font-size: 0.85rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: var(--text-muted);">File Name</span>
                    <span style="font-weight: 500; font-family: monospace; max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" id="info-filename" title="REC_c10000_20260000.wav">REC_c10000_...wav</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-muted);">Date</span>
                    <span style="font-weight: 500;">2026-02-15</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-muted);">Time</span>
                    <span style="font-weight: 500;">08:30:00</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-muted);">Duration</span>
                    <span style="font-weight: 500;">00:05:00</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-muted);">Sample Rate</span>
                    <span style="font-weight: 500;">48000 Hz</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-muted);">Channels</span>
                    <span style="font-weight: 500;" id="info-channels">2 (Stereo)</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-muted);">Format</span>
                    <span style="font-weight: 500;">WAV (16-bit)</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: var(--text-muted);">Site / Sensor</span>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span id="site-color-dot" style="width: 8px; height: 8px; border-radius: 50%; background: var(--brand); box-shadow: 0 0 4px var(--brand);"></span>
                        <span style="font-weight: 600; color: var(--brand); transition: color 0.3s;" id="info-site">Site A / SM4</span>
                    </div>
                </div>
            </div>
            <div style="margin-top: auto; padding-top: 16px; border-top: 1px solid var(--border-color);">
                <button class="btn-toolbar" style="width: 100%; justify-content: center;"><i data-lucide="file-audio" size="14"></i> Download Audio</button>
            </div>
        </div>

    </div>
</div>
<script>
    // ================== 1. 顶部下拉框数据源逻辑 ==================
    // 使用引入的 initialProjects 确保顶部具有与 Dashboard 完全相同的级联项目
    let currentProject = initialProjects[0];
    let currentCollection = currentProject.collections[0];

    // 动态生成属于该集合的音频文件列表
    function generateAudiosForCol(colId) {
        return Array.from({length: 12}, (_, i) => ({
            id: `a${i}`,
            name: `REC_${colId}_${20260000 + i}.wav`
        }));
    }

    let currentAudios = generateAudiosForCol(currentCollection.id);
    let currentAudio = currentAudios[0];

    function renderProjects(filterText = '') {
        const container = document.getElementById('project-list-container');
        const filtered = initialProjects.filter(p => p.name.toLowerCase().includes(filterText.toLowerCase()));
        if (filtered.length === 0) return container.innerHTML = '<div class="empty-state">No projects found</div>';
        container.innerHTML = filtered.map(proj => {
            const isSel = currentProject && currentProject.id === proj.id;
            return `<div class="crumb-item ${isSel ? 'selected' : ''}" onclick="selectProject(${proj.id})">
                <span>${proj.name}</span><i data-lucide="check" class="check-icon"></i></div>`;
        }).join('');
        lucide.createIcons();
    }

    function renderCollections(filterText = '') {
        const container = document.getElementById('collection-list-container');
        if (!currentProject) return container.innerHTML = '<div class="empty-state">Select a project first</div>';
        const filtered = currentProject.collections.filter(c => c.name.toLowerCase().includes(filterText.toLowerCase()));
        if (filtered.length === 0) return container.innerHTML = '<div class="empty-state">No collections found</div>';
        container.innerHTML = filtered.map(col => {
            const isSel = currentCollection && currentCollection.id === col.id;
            return `<div class="crumb-item ${isSel ? 'selected' : ''}" onclick="selectCollection('${col.id}')">
                <span>${col.name}</span><i data-lucide="check" class="check-icon"></i></div>`;
        }).join('');
        lucide.createIcons();
    }

    function renderAudios(filterText = '') {
        const container = document.getElementById('audio-list-container');
        if (!currentCollection) return container.innerHTML = '<div class="empty-state">Select a collection first</div>';
        const filtered = currentAudios.filter(a => a.name.toLowerCase().includes(filterText.toLowerCase()));
        if (filtered.length === 0) return container.innerHTML = '<div class="empty-state">No audios found</div>';
        container.innerHTML = filtered.map(audio => {
            const isSel = currentAudio && currentAudio.id === audio.id;
            return `<div class="crumb-item ${isSel ? 'selected' : ''}" onclick="selectAudio('${audio.id}')">
                <span>${audio.name}</span><i data-lucide="check" class="check-icon"></i></div>`;
        }).join('');
        lucide.createIcons();
    }

    function selectProject(id) {
        currentProject = initialProjects.find(p => p.id === id);
        document.getElementById('label-project').textContent = currentProject.name;
        currentCollection = currentProject.collections[0];
        document.getElementById('label-collection').textContent = currentCollection ? currentCollection.name : 'No Collection';

        if (currentCollection) {
            currentAudios = generateAudiosForCol(currentCollection.id);
            currentAudio = currentAudios[0];
        } else {
            currentAudios = [];
            currentAudio = null;
        }
        document.getElementById('label-audio').textContent = currentAudio ? currentAudio.name : 'No Audio';
        closeAllMenus();
        renderProjects();
        renderCollections();
        renderAudios();
    }

    function selectCollection(id) {
        currentCollection = currentProject.collections.find(c => String(c.id) === String(id));
        document.getElementById('label-collection').textContent = currentCollection.name;
        currentAudios = generateAudiosForCol(currentCollection.id);
        currentAudio = currentAudios[0];
        document.getElementById('label-audio').textContent = currentAudio.name;
        closeAllMenus();
        renderCollections();
        renderAudios();
    }

    // ================== 1.5 生态站点主题色引擎 ==================
    // 预设四种典型生境的主题色
    const siteThemes = {
        'Forest (Site A)': { hex: '#10b981', rgb: '16, 185, 129' },  // 翠绿 (森林)
        'Marine (Site B)': { hex: '#0ea5e9', rgb: '14, 165, 233' },  // 海蓝 (海洋)
        'Urban (Site C)':  { hex: '#8b5cf6', rgb: '139, 92, 246' },  // 亮紫 (城市)
        'Desert (Site D)': { hex: '#f59e0b', rgb: '245, 158, 11' }   // 琥珀 (荒漠)
    };
    const siteNames = Object.keys(siteThemes);

    // 动态应用站点主题色
    function applySiteTheme(siteName) {
        const theme = siteThemes[siteName] || siteThemes['Forest (Site A)'];

        // 动态修改全局 CSS 变量
        document.documentElement.style.setProperty('--brand', theme.hex);
        document.documentElement.style.setProperty('--brand-rgb', theme.rgb);

        // 更新右侧信息面板显示
        const siteEl = document.getElementById('info-site');
        if (siteEl) siteEl.textContent = `${siteName} / SM4`;
    }

    // ================== 1.6 动态渲染声道控制器 ==================
    function renderChannelControl(isStereo) {
        const container = document.getElementById('channel-control-container');
        const infoChannels = document.getElementById('info-channels');
        if (!container) return;

        if (isStereo) {
            // 双声道：保留可点击的胶囊切换样式
            container.innerHTML = `
            <div style="display: flex; align-items: center; background: var(--bg-capsule); box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.04), inset -1px -1px 3px rgba(255, 255, 255, 0.1); border-radius: 60px; padding: 4px; height: 32px; box-sizing: border-box; gap: 2px;" title="Stereo Channel Selection">
                <button class="channel-btn active" onclick="this.parentNode.querySelectorAll('.channel-btn').forEach(b => b.classList.remove('active')); this.classList.add('active');">L</button>
                <button class="channel-btn" onclick="this.parentNode.querySelectorAll('.channel-btn').forEach(b => b.classList.remove('active')); this.classList.add('active');">R</button>
            </div>`;
            if (infoChannels) infoChannels.textContent = "2 (Stereo)";
        } else {
            // 单声道：去掉了等宽字体，颜色使用与 L/R 未选中时一致的 var(--text-secondary)
            container.innerHTML = `
            <div style="display: flex; align-items: center; padding: 0 8px; height: 32px; box-sizing: border-box;" title="Mono Audio">
                <span style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary);">Mono</span>
            </div>`;
            if (infoChannels) infoChannels.textContent = "1 (Mono)";
        }
    }

    // ================== 修改原有的 selectAudio ==================
    function selectAudio(id) {
        currentAudio = currentAudios.find(a => a.id === id);
        document.getElementById('label-audio').textContent = currentAudio.name;

        // 模拟：根据音频 ID 的数字部分，随机分配一个生境站点并切换主题色
        const numId = parseInt(id.replace(/\D/g, '') || 0);
        const assignedSite = siteNames[numId % siteNames.length];
        applySiteTheme(assignedSite);

        // 【新增】每次切换音频，随机决定是双声道(Stereo)还是单声道(Mono)
        const isStereo = Math.random() > 0.5;
        renderChannelControl(isStereo);

        closeAllMenus();
        renderAudios();
    }
    // ================== 1.7 播放/暂停 图标切换逻辑 ==================
    let isAudioPlaying = false;

    function togglePlayState() {
        isAudioPlaying = !isAudioPlaying;
        const btn = document.getElementById('btn-play-toggle');
        const icon = btn.querySelector('i');

        if (isAudioPlaying) {
            // 切换为暂停状态
            icon.setAttribute('data-lucide', 'pause');
            btn.setAttribute('title', 'Pause');
            btn.classList.add('active'); // 增加高亮背景（可选，视觉提示正在播放）
        } else {
            // 切换回播放状态
            icon.setAttribute('data-lucide', 'play');
            btn.setAttribute('title', 'Play');
            btn.classList.remove('active');
        }
        // 关键：通知 Lucide 重新渲染刚修改过 data-lucide 属性的图标
        lucide.createIcons();
    }

    function stopPlayState() {
        // 点击停止时，强制重置为未播放状态
        isAudioPlaying = false;
        const btn = document.getElementById('btn-play-toggle');
        const icon = btn.querySelector('i');

        icon.setAttribute('data-lucide', 'play');
        btn.setAttribute('title', 'Play');
        btn.classList.remove('active');

        lucide.createIcons();
    }
    function toggleMenu(id) {
        const el = document.getElementById(id);
        const isActive = el.classList.contains('active');
        closeAllMenus();
        if (!isActive) {
            el.classList.add('active');
            const input = el.querySelector('input');
            if (input) {
                input.value = '';
                setTimeout(() => input.focus(), 50);
            }
            if (id === 'project-wrap') renderProjects();
            if (id === 'collection-wrap') renderCollections();
            if (id === 'audio-wrap') renderAudios();
        }
    }

    function closeAllMenus() {
        document.querySelectorAll('.crumb-wrapper, .user-wrapper').forEach(el => el.classList.remove('active'));
    }

    function toggleUserMenu() {
        const el = document.getElementById('user-menu');
        const isActive = el.classList.contains('active');
        closeAllMenus();
        if (!isActive) el.classList.add('active');
    }


    // ================== 2. 表格 Schema 和 数据生成 ==================
    const annotationSchema = [
        {key: "id", label: "ID", type: "number"},
        {key: "uuid", label: "UUID", type: "text"},
        {key: "media_name", label: "Media Name", type: "text", filterType: 'select'},
        {key: "min_x", label: "Min X", type: "number", filterType: 'range'},
        {key: "max_x", label: "Max X", type: "number", filterType: 'range'},
        {key: "min_y", label: "Min Y", type: "number", filterType: 'range'},
        {key: "max_y", label: "Max Y", type: "number", filterType: 'range'},
        {key: "creator_type", label: "Creator Type", type: "text", filterType: 'select'},
        {key: "sound_id", label: "Sound Class", type: "select"},
        {key: "animal_sound_type", label: "Sound Type", type: "select"},
        {key: "taxon_id", label: "Taxon", type: "select"},
        {key: "confidence", label: "Confidence", type: "number", filterType: 'range'},
        {key: "uncertain", label: "Uncertain", type: "boolean"},
        {key: "sound_distance_m", label: "Distance (m)", type: "number", filterType: 'range'},
        {key: "distance_not_estimable", label: "Not Estimable", type: "boolean"},
        {key: "individual_num", label: "Indiv. Num", type: "number", filterType: 'range'},
        {key: "reference", label: "Reference", type: "boolean"},
        {key: "comments", label: "Comments", type: "text"},
        {key: "creator_id", label: "Creator", type: "text", filterType: 'select'},
        {key: "creation_date", label: "Created", type: "text"}
    ];

    // 动态生成 30 条标注数据
    const mockAnnotations = Array.from({length: 30}, (_, i) => {
        const isBio = Math.random() > 0.3;
        const minX = parseFloat((Math.random() * 50).toFixed(1));
        const soundClass = isBio ? 'Biophony' : (Math.random() > 0.5 ? 'Geophony' : 'Anthrophony');
        const taxon = isBio ? ["Aves", "Insecta", "Amphibia"][Math.floor(Math.random() * 3)] : "";
        const creatorType = ["user", "model", "automated"][Math.floor(Math.random() * 3)];

        return {
            id: i + 1,
            uuid: `5570-e29b-41d4-a716-${String(i + 1).padStart(12, '0')}`,
            media_name: ['REC_c10000_20260000.wav', 'REC_c10000_20260001.wav'][Math.floor(Math.random() * 2)],
            min_x: minX,
            max_x: parseFloat((minX + 2 + Math.random() * 10).toFixed(1)),
            min_y: Math.floor(Math.random() * 1000),
            max_y: Math.floor(2000 + Math.random() * 6000),
            creator_type: creatorType,
            sound_id: soundClass,
            animal_sound_type: isBio ? ["Call", "Song", "Drumming"][Math.floor(Math.random() * 3)] : "",
            taxon_id: taxon,
            confidence: creatorType === 'user' ? null : parseFloat((0.5 + Math.random() * 0.49).toFixed(2)),
            uncertain: Math.random() > 0.8,
            sound_distance_m: isBio ? Math.floor(Math.random() * 100) : null,
            distance_not_estimable: isBio ? Math.random() > 0.8 : false,
            individual_num: isBio ? Math.floor(Math.random() * 5) + 1 : null,
            reference: Math.random() > 0.7,
            comments: ["Clear", "Noisy", "Overlapping", "Needs review", ""][Math.floor(Math.random() * 5)],
            creator_id: ["Liudilong", "A. Schmidt", "J. Doe", "System"][Math.floor(Math.random() * 4)],
            creation_date: `2026-02-${String((i % 28) + 1).padStart(2, '0')} 10:00:00`
        };
    });

    // ================== 3. 状态引擎与事件监听 ==================
    let crudSearchQuery = "";
    let crudFilterState = {};
    let sortState = {key: "id", direction: 'asc'};
    let selectedIds = [];

    document.addEventListener('click', e => {
        // 防止点击在搜索框里也触发关闭
        if (e.target.closest('.dropdown-search-box')) return;

        // 如果点击的地方不是高级下拉筛选框，则关闭它们
        if (!e.target.closest('.table-filter-wrapper')) {
            document.querySelectorAll('.table-filter-dropdown').forEach(d => d.classList.remove('active'));
        }

        // 如果点击的地方不是顶部导航菜单，则关闭导航
        if (!e.target.closest('.crumb-wrapper') && !e.target.closest('.user-wrapper')) {
            closeAllMenus();
        }
    });

    function getUniqueValues(data, key) {
        const set = new Set();
        data.forEach(row => {
            if (row[key] !== undefined && row[key] !== null && row[key] !== "") {
                set.add(row[key]);
            }
        });
        return Array.from(set).sort();
    }

    // ================== 4. 表格交互与联动逻辑 ==================
    function handleDataSearch(val) {
        crudSearchQuery = val.toLowerCase();
        renderCrudTable();
    }

    function handleSort(key) {
        if (sortState.key === key) sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
        else {
            sortState.key = key;
            sortState.direction = 'asc';
        }
        renderCrudHeader();
        renderCrudTable();
    }

    function handleColumnFilter(key, value) {
        if (value === "" || value === "all") delete crudFilterState[key];
        else crudFilterState[key] = value;
        renderCrudTable();
    }

    function handleRangeFilter(key, type, val) {
        if (!crudFilterState[key] || typeof crudFilterState[key] !== 'object') crudFilterState[key] = {min: "", max: ""};
        crudFilterState[key][type] = val;
        if (crudFilterState[key].min === "" && crudFilterState[key].max === "") delete crudFilterState[key];
        renderCrudTable();
    }

    function resetFilters() {
        crudSearchQuery = "";
        crudFilterState = {};
        sortState = {key: "id", direction: 'asc'};
        document.getElementById('data-search-input').value = "";
        renderCrudHeader();
        renderCrudTable();
    }

    function toggleTableFilterSelect(id) {
        const dropdown = document.getElementById(id);
        if (!dropdown) return;
        document.querySelectorAll('.table-filter-dropdown').forEach(d => {
            if (d.id !== id) d.classList.remove('active');
        });
        const isActive = dropdown.classList.contains('active');
        if (!isActive) {
            dropdown.classList.add('active');
            const search = dropdown.querySelector('.table-filter-search');
            if (search) search.value = '';
            Array.from(dropdown.querySelectorAll('.table-filter-option')).forEach(opt => opt.classList.remove('hidden'));
        } else {
            dropdown.classList.remove('active');
        }
    }

    function filterTableFilterSelect(dropdownId, query) {
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) return;
        const val = query.toLowerCase();
        dropdown.querySelectorAll('.table-filter-option').forEach(opt => {
            if (opt.textContent.toLowerCase().includes(val)) opt.classList.remove('hidden');
            else opt.classList.add('hidden');
        });
    }

    function selectTableFilterOption(key, value, label) {
        handleColumnFilter(key, value);
        const triggerSpan = document.getElementById(`filter-trigger-span-${key}`);
        if (triggerSpan) triggerSpan.textContent = label;
        const dropdown = document.getElementById(`filter-dropdown-${key}`);
        if (dropdown) dropdown.classList.remove('active');
    }

    function toggleRowSelection(id, el) {
        const idx = selectedIds.indexOf(id);
        if (idx > -1) {
            selectedIds.splice(idx, 1);
            el.closest('tr').classList.remove('selected');
        } else {
            selectedIds.push(id);
            el.closest('tr').classList.add('selected');
        }
        updateToolbarState();
    }

    function handleSelectAll(checked) {
        const checkboxes = document.querySelectorAll('#crud-tbody .crud-checkbox');
        selectedIds = [];
        checkboxes.forEach(cb => {
            cb.checked = checked;
            const tr = cb.closest('tr');
            const id = Number(tr.dataset.id);
            if (checked) {
                selectedIds.push(id);
                tr.classList.add('selected');
            } else {
                tr.classList.remove('selected');
            }
        });
        updateToolbarState();
    }

    function updateToolbarState() {
        const count = selectedIds.length;
        const delBtn = document.getElementById('btn-delete');
        const assignBtn = document.getElementById('btn-assign');

        if (delBtn) delBtn.disabled = count === 0;
        if (assignBtn) assignBtn.disabled = count === 0;
    }

    // ================== 5. 表格渲染核心 ==================
    function renderCrudHeader() {
        const thead = document.getElementById('crud-thead');
        let headHtml = "<tr>";
        headHtml += `<th style="width: 40px; text-align:center; vertical-align:top; padding-top:14px;"><input type="checkbox" class="crud-checkbox" onclick="handleSelectAll(this.checked)"></th>`;

        annotationSchema.forEach(col => {
            const isSorted = sortState.key === col.key;
            const sortIcon = isSorted ? (sortState.direction === 'asc' ? 'arrow-up' : 'arrow-down') : 'arrow-up-down';
            const activeClass = isSorted ? 'active-sort' : '';
            const iconOpacity = isSorted ? '1' : '0.3';

            let filterInputHtml = '';
            const currentFilterVal = crudFilterState[col.key];

            if (col.filterType === 'range') {
                const minVal = (currentFilterVal && currentFilterVal.min) ? currentFilterVal.min : "";
                const maxVal = (currentFilterVal && currentFilterVal.max) ? currentFilterVal.max : "";
                filterInputHtml = `
                <div style="display:flex; gap:4px; align-items:center;">
                    <input type="number" class="th-filter-input" placeholder="Min" style="padding:0 4px; font-size:0.75rem;" value="${minVal}" oninput="handleRangeFilter('${col.key}', 'min', this.value)" onclick="event.stopPropagation()">
                    <span style="color:var(--text-muted);">-</span>
                    <input type="number" class="th-filter-input" placeholder="Max" style="padding:0 4px; font-size:0.75rem;" value="${maxVal}" oninput="handleRangeFilter('${col.key}', 'max', this.value)" onclick="event.stopPropagation()">
                </div>`;
            } else if (col.type === 'boolean') {
                const valStr = currentFilterVal || "all";
                let displayLabel = valStr === 'true' ? "True" : (valStr === 'false' ? "False" : "All");
                filterInputHtml = `
                <div class="table-filter-wrapper" style="position:relative; width:100%;">
                    <div class="table-filter-trigger th-filter-input" onclick="event.stopPropagation(); toggleTableFilterSelect('filter-dropdown-${col.key}')" style="display:flex; align-items:center; justify-content:space-between; padding-right:24px;">
                        <span id="filter-trigger-span-${col.key}" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${displayLabel}</span>
                        <i data-lucide="chevron-down" size="12" style="position:absolute; right:8px; opacity:0.5;"></i>
                    </div>
                    <div class="table-filter-dropdown" id="filter-dropdown-${col.key}" onclick="event.stopPropagation()">
                        <div class="table-filter-options-list">
                            <div class="table-filter-option ${valStr === 'all' ? 'selected' : ''}" onclick="selectTableFilterOption('${col.key}', 'all', 'All')">All</div>
                            <div class="table-filter-option ${valStr === 'true' ? 'selected' : ''}" onclick="selectTableFilterOption('${col.key}', 'true', 'True')">True</div>
                            <div class="table-filter-option ${valStr === 'false' ? 'selected' : ''}" onclick="selectTableFilterOption('${col.key}', 'false', 'False')">False</div>
                        </div>
                    </div>
                </div>`;
            } else if (col.type === 'select' || col.filterType === 'select') {
                const valStr = currentFilterVal || "";
                const displayLabel = (valStr && valStr !== 'all') ? valStr : 'All';
                const uniqueVals = getUniqueValues(mockAnnotations, col.key);
                filterInputHtml = `
                <div class="table-filter-wrapper" style="position:relative; width:100%;">
                    <div class="table-filter-trigger th-filter-input" onclick="event.stopPropagation(); toggleTableFilterSelect('filter-dropdown-${col.key}')" style="display:flex; align-items:center; justify-content:space-between; padding-right:24px;">
                        <span id="filter-trigger-span-${col.key}" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${displayLabel}</span>
                        <i data-lucide="chevron-down" size="12" style="position:absolute; right:8px; opacity:0.5;"></i>
                    </div>
                    <div class="table-filter-dropdown" id="filter-dropdown-${col.key}" onclick="event.stopPropagation()">
                        <input type="text" class="table-filter-search" placeholder="Search..." oninput="filterTableFilterSelect('filter-dropdown-${col.key}', this.value)">
                        <div class="table-filter-options-list">
                            <div class="table-filter-option ${!valStr || valStr === 'all' ? 'selected' : ''}" onclick="selectTableFilterOption('${col.key}', 'all', 'All')">All</div>
                            ${uniqueVals.map(o => `<div class="table-filter-option ${String(valStr) === String(o) ? 'selected' : ''}" onclick="selectTableFilterOption('${col.key}', '${String(o).replace(/'/g, "\\'")}', '${String(o).replace(/'/g, "\\'")}')">${o}</div>`).join('')}
                        </div>
                    </div>
                </div>`;
            } else {
                const valStr = currentFilterVal || "";
                filterInputHtml = `<input type="text" class="th-filter-input" placeholder="Filter..." value="${valStr}" oninput="handleColumnFilter('${col.key}', this.value)" onclick="event.stopPropagation()">`;
            }

            headHtml += `<th style="min-width: 140px;">
                <div class="th-header-content ${activeClass}" onclick="handleSort('${col.key}')">
                    <span>${col.label}</span>
                    <i data-lucide="${sortIcon}" size="14" style="opacity:${iconOpacity}"></i>
                </div>
                <div class="th-filter-box">${filterInputHtml}</div>
            </th>`;
        });
        headHtml += `</tr>`;
        thead.innerHTML = headHtml;
        lucide.createIcons();
    }

    function renderCrudTable() {
        const tbody = document.getElementById('crud-tbody');

        let processedData = mockAnnotations.filter(row => {
            const matchesGlobal = !crudSearchQuery || Object.values(row).some(v => String(v).toLowerCase().includes(crudSearchQuery));
            if (!matchesGlobal) return false;

            return Object.keys(crudFilterState).every(key => {
                const filterVal = crudFilterState[key];
                const rowVal = row[key];

                if (typeof filterVal === 'object' && (filterVal.min !== undefined || filterVal.max !== undefined)) {
                    if (rowVal === null || rowVal === undefined || rowVal === "") return false;
                    const numVal = Number(rowVal);
                    if (filterVal.min !== "" && numVal < Number(filterVal.min)) return false;
                    if (filterVal.max !== "" && numVal > Number(filterVal.max)) return false;
                    return true;
                }
                const strFilterVal = String(filterVal).toLowerCase();
                const strRowVal = String(rowVal !== undefined && rowVal !== null ? rowVal : "").toLowerCase();
                if (strFilterVal === 'true' || strFilterVal === 'false') return strRowVal === strFilterVal;
                return strRowVal.includes(strFilterVal);
            });
        });

        if (sortState.key) {
            processedData.sort((a, b) => {
                let valA = a[sortState.key], valB = b[sortState.key];
                if (valA === null || valA === undefined) valA = "";
                if (valB === null || valB === undefined) valB = "";
                if (typeof valA === 'number' && typeof valB === 'number') return sortState.direction === 'asc' ? valA - valB : valB - valA;
                valA = String(valA).toLowerCase();
                valB = String(valB).toLowerCase();
                if (valA < valB) return sortState.direction === 'asc' ? -1 : 1;
                if (valA > valB) return sortState.direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        let bodyHtml = "";
        if (processedData.length === 0) {
            bodyHtml = `<tr><td colspan="${annotationSchema.length + 1}" style="text-align:center; padding:40px; color:var(--text-muted); font-style:italic;">No results found</td></tr>`;
        } else {
            processedData.forEach(row => {
                const isChecked = selectedIds.includes(row.id);
                bodyHtml += `<tr data-id="${row.id}" class="${isChecked ? 'selected' : ''}">`;
                bodyHtml += `<td style="text-align:center; border-bottom:1px solid var(--border-color);"><input type="checkbox" class="crud-checkbox" ${isChecked ? 'checked' : ''} onclick="toggleRowSelection(${row.id}, this)"></td>`;

                annotationSchema.forEach(col => {
                    let val = row[col.key];
                    if (val === undefined || val === null) val = "";

                    if (col.type === 'boolean') {
                        if (val === true) val = `<span style="background:var(--brand); color:white; padding:2px 8px; border-radius:12px; font-size:0.7rem; font-weight:700; box-shadow:0 2px 5px rgba(var(--brand-rgb),0.3); display:inline-block;">True</span>`;
                        else if (val === false) val = `<span style="background:#ef4444; color:white; padding:2px 8px; border-radius:12px; font-size:0.7rem; font-weight:700; box-shadow:0 2px 5px rgba(239,68,68,0.3); display:inline-block;">False</span>`;
                        else val = "";
                    } else if (col.key === 'taxon_id' && val) {
                        val = `<div style="display:flex; flex-wrap:nowrap; gap:4px; overflow-x:auto; scrollbar-width:none; align-items:center;">
                                <span style="background:var(--brand); color:white; padding:2px 8px; border-radius:12px; font-size:0.7rem; font-weight:700; box-shadow:0 2px 5px rgba(var(--brand-rgb),0.3); white-space:nowrap; flex-shrink:0; display:inline-block;">${val}</span>
                               </div>`;
                    }
                    bodyHtml += `<td>${val}</td>`;
                });
                bodyHtml += `</tr>`;
            });
        }

        tbody.innerHTML = bodyHtml;
        lucide.createIcons();
        updateToolbarState(); // 渲染完毕后根据选择更新顶部按钮状态

        // 【新增】每次表格数据渲染/筛选后，同步更新频谱图上的标注框
        if (typeof renderAnnotationsOnSpectrogram === 'function') {
            renderAnnotationsOnSpectrogram(processedData);
        }
    }

    function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        const target = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', target);
        localStorage.setItem('theme', target);
        document.getElementById('theme-icon-el').setAttribute('data-lucide', target === 'dark' ? 'sun' : 'moon');
        lucide.createIcons();
    }

    // ================== 5.5 渲染频谱图上的标注框 ==================
    function renderAnnotationsOnSpectrogram(filteredData) {
        const layer = document.getElementById('annotations-layer');
        if (!layer) return;

        // 如果没有传入数据，默认设为空数组
        const data = filteredData || [];

        // 假设当前音频总时长约为 60 秒，最高频率设定为 24000 Hz
        const MAX_TIME = 60;
        const MAX_FREQ = 24000;

        let html = '';

        // 改为遍历 data 而不是全局的 mockAnnotations
        data.forEach(anno => {
            // 防止生成超出范围的数据
            if (anno.min_x > MAX_TIME) return;

            // 计算坐标百分比（注意：频率0在最下方，所以用 bottom 定位）
            const left = (anno.min_x / MAX_TIME) * 100;
            let width = ((anno.max_x - anno.min_x) / MAX_TIME) * 100;
            const bottom = (anno.min_y / MAX_FREQ) * 100;
            let height = ((anno.max_y - anno.min_y) / MAX_FREQ) * 100;

            // 边界截断，防止框超出频谱图画布
            if (left + width > 100) width = 100 - left;
            if (bottom + height > 100) height = 100 - bottom;

            // 根据声音类别分配不同颜色
            let color = '#3b82f6'; // 默认蓝色
            if (anno.sound_id === 'Biophony') color = '#10b981'; // 绿色 (生物声)
            else if (anno.sound_id === 'Anthrophony') color = '#ef4444'; // 红色 (人类声)
            else if (anno.sound_id === 'Geophony') color = '#f59e0b'; // 橙色 (地质声)

            // 画出标注框 (33 是 20%的十六进制透明度， 66 是 40%)
            // 美化后的科技感标注框 (Neon Glow)
            html += `<div class="annotation-box" data-id="${anno.id}" style="
                position: absolute;
                left: ${left}%;
                bottom: ${bottom}%;
                width: ${width}%;
                height: ${height}%;
                border: 1px solid ${color};
                background-color: ${color}1A; /* 10% 极低透明度，不遮挡频谱细节 */
                box-shadow: 0 0 6px ${color}4D, inset 0 0 4px ${color}4D; /* 内外发光效果 */
                pointer-events: auto;
                cursor: pointer;
                border-radius: 2px;
                box-sizing: border-box;
                transition: all 0.2s ease;
                backdrop-filter: brightness(1.2); /* 微微提亮背后的频谱图 */
            " title="${anno.sound_id} (ID: ${anno.id})"
              onclick="handleBoxClick(${anno.id}, event)"
              onmouseover="this.style.backgroundColor='${color}4D'; this.style.boxShadow='0 0 10px ${color}80, inset 0 0 8px ${color}80'; this.style.zIndex='10';"
              onmouseout="this.style.backgroundColor='${color}1A'; this.style.boxShadow='0 0 6px ${color}4D, inset 0 0 4px ${color}4D'; this.style.zIndex='1';">
            </div>`;
        });

        layer.innerHTML = html;
    }

    // 处理图上标注框的点击事件，与下方的表格发生联动
    function handleBoxClick(id, event) {
        if(event) event.stopPropagation();

        // 找到表格中对应的行并模拟点击该行的复选框，触发已有的选中/解除选中逻辑
        const tr = document.querySelector(`tr[data-id="${id}"]`);
        if(tr) {
            const checkbox = tr.querySelector('.crud-checkbox');
            if(checkbox) checkbox.click();
            // 自动滚动让这行居中显示
            tr.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // 添加一个临时的闪烁动画提示
            tr.style.backgroundColor = 'var(--bg-hover)';
            setTimeout(() => tr.style.backgroundColor = '', 500);
        }
    }


    // ================== 6. 初始化 ==================
    window.addEventListener('DOMContentLoaded', () => {
        const saved = localStorage.getItem('theme');
        const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const targetTheme = saved || (systemDark ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', targetTheme);
        document.getElementById('theme-icon-el').setAttribute('data-lucide', targetTheme === 'dark' ? 'sun' : 'moon');

        document.getElementById('label-project').textContent = currentProject.name;
        document.getElementById('label-collection').textContent = currentCollection.name;
        document.getElementById('label-audio').textContent = currentAudio.name;

        // 初始化表格与按钮
        renderCrudHeader();
        renderCrudTable();

        applySiteTheme(siteNames[0]);

        // 【新增】页面首次加载时，也随机初始化一个声道状态
        renderChannelControl(Math.random() > 0.5);

        lucide.createIcons();
    });
</script>
</body>
</html>